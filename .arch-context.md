# Architecture Context Inventory

> Generated: 2026-02-14
> Domain: field definition, field group, field pack, tag, saved view, custom fields, JSONB

---

## 1. Numbering

| Sequence           | Current Last                        | Next        |
|--------------------|-------------------------------------|-------------|
| Architecture section | 10 (Phase 4)                      | **11**      |
| ADR                | ADR-051                             | **ADR-052** |
| Tenant migration   | V23 (`V23__add_invoices.sql`)       | **V24**     |

---

## 2. Relevant Entities

**No existing entities match** the domain keywords (field definition, field group, field pack, tag, saved view, custom fields). These are net-new concepts.

### Entities with JSONB usage (reference for custom field storage pattern)

| Entity       | File                                  | JSONB Column | Java Type              |
|--------------|---------------------------------------|-------------|------------------------|
| `AuditEvent` | `audit/AuditEvent.java`               | `details`   | `Map<String, Object>`  |

Hibernate mapping:
```java
@JdbcTypeCode(SqlTypes.JSON)
@Column(name = "details", columnDefinition = "jsonb")
private Map<String, Object> details;
```

Imports: `org.hibernate.annotations.JdbcTypeCode` + `org.hibernate.type.SqlTypes`

### Entities likely targeted by custom fields / tags / saved views

| Entity           | File                               | Why relevant                       |
|------------------|------------------------------------|------------------------------------|
| `Project`        | `project/Project.java`             | Primary target for tags, custom fields, saved views |
| `Customer`       | `customer/Customer.java`           | Target for tags, custom fields     |
| `Task`           | `task/Task.java`                   | Target for custom fields, saved views |
| `TimeEntry`      | `timeentry/TimeEntry.java`         | Potential custom field target      |
| `Document`       | `document/Document.java`           | Potential tag target               |

### 5 most recently modified entities

| Entity          | Package       | Last Modified |
|-----------------|---------------|---------------|
| `TimeEntry`     | `timeentry/`  | 2026-02-14    |
| `Customer`      | `customer/`   | 2026-02-14    |
| `ProjectBudget` | `budget/`     | 2026-02-14    |
| `CostRate`      | `costrate/`   | 2026-02-13    |
| `BillingRate`   | `billingrate/` | 2026-02-13   |

---

## 3. Reference Entity Pattern -- `CostRate`

Most recently created standard entity. Shows the canonical tenant-scoped pattern.

```java
package io.b2mash.b2b.b2bstrawman.costrate;

import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAware;
import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAwareEntityListener;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.math.BigDecimal;
import java.time.Instant;
import java.time.LocalDate;
import java.util.UUID;
import org.hibernate.annotations.Filter;
import org.hibernate.annotations.FilterDef;
import org.hibernate.annotations.ParamDef;

@Entity
@Table(name = "cost_rates")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class CostRate implements TenantAware {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "member_id", nullable = false)
  private UUID memberId;

  @Column(name = "currency", nullable = false, length = 3)
  private String currency;

  @Column(name = "hourly_cost", nullable = false, precision = 12, scale = 2)
  private BigDecimal hourlyCost;

  @Column(name = "effective_from", nullable = false)
  private LocalDate effectiveFrom;

  @Column(name = "effective_to")
  private LocalDate effectiveTo;

  @Column(name = "tenant_id")
  private String tenantId;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  protected CostRate() {}

  public CostRate(UUID memberId, String currency, BigDecimal hourlyCost,
      LocalDate effectiveFrom, LocalDate effectiveTo) {
    this.memberId = memberId;
    this.currency = currency;
    this.hourlyCost = hourlyCost;
    this.effectiveFrom = effectiveFrom;
    this.effectiveTo = effectiveTo;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  // update() method sets fields + updatedAt
  // Getters (no setters except TenantAware)
  // getTenantId() / setTenantId() for TenantAware
}
```

### Key entity conventions

- **Tenant isolation**: `implements TenantAware` + `@FilterDef`/`@Filter` + `@EntityListeners(TenantAwareEntityListener.class)`
- **UUID PK**: `@GeneratedValue(strategy = GenerationType.UUID)`
- **Timestamps**: `createdAt` (updatable=false) + `updatedAt`, set in constructor and update methods (not `@PrePersist`)
- **No Lombok**: Plain Java, protected no-arg constructor
- **Domain methods**: Mutation via named methods (e.g., `update()`), not raw setters
- **`@Version`**: Used selectively (e.g., `ProjectBudget`), not universally

---

## 4. Reference ADR Template -- ADR-051

```markdown
# ADR-052: [Title -- Noun Phrase Describing Decision]

**Status**: Accepted

**Context**: [1-3 paragraphs describing the problem, constraints, and
why a decision is needed.]

Key constraints:
- [bullet list of specific constraints]

**Options Considered**:

1. **Option name** -- [One-sentence description.]
   - Pros:
     - [bullet list]
   - Cons:
     - [bullet list]

2. **Option name** -- [One-sentence description.]
   - Pros: [...]
   - Cons: [...]

3. **Option name** -- [One-sentence description.]
   - Pros: [...]
   - Cons: [...]

**Decision**: [Selected option] (Option N).

**Rationale**: [1-2 paragraphs explaining why this option was chosen,
including migration/evolution path for future needs.]

**Consequences**:
- [Concrete implementation artifact -- package, class, config]
- [What changes and what stays the same]
- [Future migration path / what would need to change]
```

---

## 5. Quick Reference

| Item                 | Value                                                        |
|----------------------|--------------------------------------------------------------|
| Base package         | `io.b2mash.b2b.b2bstrawman`                                 |
| Entity superinterface| `TenantAware` (in `multitenancy/`)                           |
| Entity listener      | `TenantAwareEntityListener`                                  |
| Filter name          | `tenantFilter` (all entities use same name)                  |
| Migration path       | `backend/src/main/resources/db/migration/tenant/`            |
| Migration naming     | `V{N}__{description}.sql` (double underscore)                |
| ID strategy          | UUID (generated)                                             |
| JSONB Hibernate      | `@JdbcTypeCode(SqlTypes.JSON)` + `columnDefinition = "jsonb"`|
| Total entities       | 21 (across 15 packages)                                      |
