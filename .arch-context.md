# Architecture Context Inventory

Generated: 2026-03-01

---

## 1. ARCHITECTURE.md Section Headers

File: `architecture/ARCHITECTURE.md`

| Line | Section |
|------|---------|
| 3    | `## 1. Overview` |
| 50   | `## 2. Architecture Decision Records` |
| 409  | `## 3. Component Architecture` |
| 704  | `## 4. Sequence Diagrams` |
| 874  | `## 5. Data Flow Diagrams` |
| 980  | `## 6. Security Architecture` |
| 1083 | `## 7. Infrastructure Architecture` |
| 1236 | `## 8. Database Architecture` |
| 1344 | `## 9. Phase 2 — Billing & Tiered Tenancy` |
| 1874 | `## 10. Phase 4 — Customers, Document Scopes & Tasks` |
| 2446 | `## Appendix A: Clerk JWT Claims` |
| 2460 | `## Appendix B: Environment Variables Reference` |

**Last numbered section**: 10 (Phase 4)
**Next available section number**: 11

> Note: Phases 5+ use standalone architecture docs in `architecture/phase{N}-*.md` rather than inline sections. The last inline section is 10 (Phase 4). New phases should follow the standalone pattern.

### Standalone Phase Architecture Docs

```
architecture/phase5-task-time-lifecycle.md
architecture/phase6-audit-compliance-foundations.md
architecture/phase6.5-notifications-comments-activity.md
architecture/phase7-customer-portal-backend.md
architecture/phase8-rate-cards-budgets-profitability.md
architecture/phase9-operational-dashboards.md
architecture/phase10-invoicing-billing.md
architecture/phase11-tags-custom-fields-views.md
architecture/phase12-document-templates.md
architecture/phase13-dedicated-schema-only.md
architecture/phase14-customer-compliance-lifecycle.md
architecture/phase15-contextual-actions-setup-guidance.md
architecture/phase16-project-templates-recurring-schedules.md
architecture/phase17-retainer-agreements-billing.md
architecture/phase18-task-detail-experience-missing-functionality.md
architecture/phase19-reporting-data-export.md
architecture/phase20-e2e-auth-abstraction.md
architecture/phase21-integration-ports-byoak.md
architecture/phase22-customer-portal-frontend.md
architecture/phase23-custom-field-maturity.md
architecture/phase24-outbound-email-delivery.md
architecture/phase25-online-payment-collection.md
architecture/phase26-invoice-tax-handling.md
architecture/phase27-document-clauses.md
architecture/phase28-document-acceptance.md
architecture/phase29-entity-lifecycle-integrity.md
architecture/phase30-expenses-recurring-calendar.md
architecture/phase31-document-system-redesign.md
```

---

## 2. ADR Numbering

**Highest ADR number**: 123 (`ADR-123-template-clause-association-source-of-truth.md`)
**Next available ADR number**: 124

Total ADR files: 113 (ADR-010 through ADR-123; ADR-001 to ADR-009 are inline in ARCHITECTURE.md)

---

## 3. Migration Numbering

### Global Migrations (`db/migration/global/`)

| File | Description |
|------|-------------|
| V1   | create_org_schema_mapping |
| V2   | create_organizations |
| V3   | create_processed_webhooks |
| V4   | add_org_tier |
| V5   | drop_schema_name_unique |
| V6   | add_subscriptions |
| V7   | create_portal_schema |
| V8   | extend_portal_read_model |
| V9   | portal_payment_fields |
| V10  | portal_invoice_tax_fields |
| V11  | portal_acceptance_requests |

**Highest global migration**: V11
**Next available global migration**: V12

### Tenant Migrations (`db/migration/tenant/`)

| File | Description |
|------|-------------|
| V1   | create_projects |
| V2   | create_documents |
| V3   | create_members |
| V4   | migrate_ownership_to_members |
| V5   | create_project_members |
| V6   | add_missing_fk_indexes |
| V7   | create_customers |
| V8   | create_customer_projects |
| V9   | create_tasks |
| V10  | extend_documents_scope |
| V11  | create_time_entries |
| V12  | create_audit_events |
| V13  | create_comments |
| V14  | create_notifications |
| V15  | create_notification_preferences |
| V16  | create_portal_contacts_and_magic_link_tokens |
| V17  | create_rate_budget_tables |
| V18  | add_time_entry_rate_snapshots |
| V19  | add_project_budget_version |
| V20  | add_dashboard_indexes |
| V21  | create_invoices |
| V22  | add_field_definitions_groups |
| V23  | add_tags |
| V24  | add_field_pack_status |
| V25  | add_custom_field_columns |
| V26  | add_saved_views |
| V27  | create_document_templates |
| V28  | add_branding_and_template_pack_status |
| V29  | customer_compliance_lifecycle |
| V30  | project_templates_recurring_schedules |
| V31  | create_retainer_tables |
| V32  | rename_external_to_shared_visibility |
| V33  | create_task_items |
| V34  | create_template_task_items |
| V35  | create_report_definitions |
| V36  | create_integration_tables |
| V37  | portal_comments_support |
| V38  | custom_field_maturity |
| V39  | generated_document_warnings |
| V40  | comment_source_column |
| V41  | create_email_delivery_log |
| V42  | online_payment_collection |
| V43  | invoice_tax_handling |
| V44  | create_clause_tables |
| V45  | create_acceptance_requests |
| V46  | add_acceptance_request_reference_type |
| V47  | entity_lifecycle_integrity |
| V48  | document_tiptap_migration |
| V49  | swap_content_body_to_jsonb |
| V50  | expenses_recurring_calendar |

**Highest tenant migration**: V50
**Next available tenant migration**: V51

---

## 4. Entity Inventory (56 @Entity classes)

| Entity Class | File Path (relative to backend/) |
|---|---|
| AcceptanceRequest | `src/main/java/io/b2mash/b2b/b2bstrawman/acceptance/AcceptanceRequest.java` |
| AuditEvent | `src/main/java/io/b2mash/b2b/b2bstrawman/audit/AuditEvent.java` |
| BillingRate | `src/main/java/io/b2mash/b2b/b2bstrawman/billingrate/BillingRate.java` |
| Clause | `src/main/java/io/b2mash/b2b/b2bstrawman/clause/Clause.java` |
| ChecklistInstance | `src/main/java/io/b2mash/b2b/b2bstrawman/checklist/ChecklistInstance.java` |
| ChecklistInstanceItem | `src/main/java/io/b2mash/b2b/b2bstrawman/checklist/ChecklistInstanceItem.java` |
| ChecklistTemplate | `src/main/java/io/b2mash/b2b/b2bstrawman/checklist/ChecklistTemplate.java` |
| ChecklistTemplateItem | `src/main/java/io/b2mash/b2b/b2bstrawman/checklist/ChecklistTemplateItem.java` |
| Comment | `src/main/java/io/b2mash/b2b/b2bstrawman/comment/Comment.java` |
| CostRate | `src/main/java/io/b2mash/b2b/b2bstrawman/costrate/CostRate.java` |
| Customer | `src/main/java/io/b2mash/b2b/b2bstrawman/customer/Customer.java` |
| CustomerProject | `src/main/java/io/b2mash/b2b/b2bstrawman/customer/CustomerProject.java` |
| DataSubjectRequest | `src/main/java/io/b2mash/b2b/b2bstrawman/datarequest/DataSubjectRequest.java` |
| Document | `src/main/java/io/b2mash/b2b/b2bstrawman/document/Document.java` |
| DocumentTemplate | `src/main/java/io/b2mash/b2b/b2bstrawman/template/DocumentTemplate.java` |
| EmailDeliveryLog | `src/main/java/io/b2mash/b2b/b2bstrawman/integration/email/EmailDeliveryLog.java` |
| EntityTag | `src/main/java/io/b2mash/b2b/b2bstrawman/tag/EntityTag.java` |
| Expense | `src/main/java/io/b2mash/b2b/b2bstrawman/expense/Expense.java` |
| FieldDefinition | `src/main/java/io/b2mash/b2b/b2bstrawman/fielddefinition/FieldDefinition.java` |
| FieldGroup | `src/main/java/io/b2mash/b2b/b2bstrawman/fielddefinition/FieldGroup.java` |
| FieldGroupMember | `src/main/java/io/b2mash/b2b/b2bstrawman/fielddefinition/FieldGroupMember.java` |
| GeneratedDocument | `src/main/java/io/b2mash/b2b/b2bstrawman/template/GeneratedDocument.java` |
| Invoice | `src/main/java/io/b2mash/b2b/b2bstrawman/invoice/Invoice.java` |
| InvoiceCounter | `src/main/java/io/b2mash/b2b/b2bstrawman/invoice/InvoiceCounter.java` |
| InvoiceLine | `src/main/java/io/b2mash/b2b/b2bstrawman/invoice/InvoiceLine.java` |
| MagicLinkToken | `src/main/java/io/b2mash/b2b/b2bstrawman/portal/MagicLinkToken.java` |
| Member | `src/main/java/io/b2mash/b2b/b2bstrawman/member/Member.java` |
| Notification | `src/main/java/io/b2mash/b2b/b2bstrawman/notification/Notification.java` |
| NotificationPreference | `src/main/java/io/b2mash/b2b/b2bstrawman/notification/NotificationPreference.java` |
| Organization | `src/main/java/io/b2mash/b2b/b2bstrawman/provisioning/Organization.java` |
| OrgIntegration | `src/main/java/io/b2mash/b2b/b2bstrawman/integration/OrgIntegration.java` |
| OrgSchemaMapping | `src/main/java/io/b2mash/b2b/b2bstrawman/multitenancy/OrgSchemaMapping.java` |
| OrgSecret | `src/main/java/io/b2mash/b2b/b2bstrawman/integration/secret/OrgSecret.java` |
| OrgSettings | `src/main/java/io/b2mash/b2b/b2bstrawman/settings/OrgSettings.java` |
| PaymentEvent | `src/main/java/io/b2mash/b2b/b2bstrawman/invoice/PaymentEvent.java` |
| PortalContact | `src/main/java/io/b2mash/b2b/b2bstrawman/portal/PortalContact.java` |
| ProjectBudget | `src/main/java/io/b2mash/b2b/b2bstrawman/budget/ProjectBudget.java` |
| Project | `src/main/java/io/b2mash/b2b/b2bstrawman/project/Project.java` |
| ProjectMember | `src/main/java/io/b2mash/b2b/b2bstrawman/member/ProjectMember.java` |
| ProjectTemplate | `src/main/java/io/b2mash/b2b/b2bstrawman/projecttemplate/ProjectTemplate.java` |
| RecurringSchedule | `src/main/java/io/b2mash/b2b/b2bstrawman/schedule/RecurringSchedule.java` |
| ReportDefinition | `src/main/java/io/b2mash/b2b/b2bstrawman/reporting/ReportDefinition.java` |
| RetainerAgreement | `src/main/java/io/b2mash/b2b/b2bstrawman/retainer/RetainerAgreement.java` |
| RetainerPeriod | `src/main/java/io/b2mash/b2b/b2bstrawman/retainer/RetainerPeriod.java` |
| RetentionPolicy | `src/main/java/io/b2mash/b2b/b2bstrawman/retention/RetentionPolicy.java` |
| SavedView | `src/main/java/io/b2mash/b2b/b2bstrawman/view/SavedView.java` |
| ScheduleExecution | `src/main/java/io/b2mash/b2b/b2bstrawman/schedule/ScheduleExecution.java` |
| Subscription | `src/main/java/io/b2mash/b2b/b2bstrawman/billing/Subscription.java` |
| Tag | `src/main/java/io/b2mash/b2b/b2bstrawman/tag/Tag.java` |
| Task | `src/main/java/io/b2mash/b2b/b2bstrawman/task/Task.java` |
| TaskItem | `src/main/java/io/b2mash/b2b/b2bstrawman/task/TaskItem.java` |
| TaxRate | `src/main/java/io/b2mash/b2b/b2bstrawman/tax/TaxRate.java` |
| TemplateClause | `src/main/java/io/b2mash/b2b/b2bstrawman/clause/TemplateClause.java` |
| TemplateTask | `src/main/java/io/b2mash/b2b/b2bstrawman/projecttemplate/TemplateTask.java` |
| TemplateTaskItem | `src/main/java/io/b2mash/b2b/b2bstrawman/projecttemplate/TemplateTaskItem.java` |
| TimeEntry | `src/main/java/io/b2mash/b2b/b2bstrawman/timeentry/TimeEntry.java` |

---

## 5. Backend Package Structure

All packages under `io.b2mash.b2b.b2bstrawman`:

```
acceptance/       activity/         audit/            billing/
billingrate/      budget/           checklist/        clause/
comment/          compliance/       config/           costrate/
customer/         customerbackend/  dashboard/        datarequest/
dev/              document/         event/            exception/
expense/          fielddefinition/  integration/      invoice/
member/           multitenancy/     mywork/           notification/
portal/           project/          projecttemplate/  provisioning/
report/           reporting/        retainer/         retention/
s3/               schedule/         security/         settings/
setupstatus/      tag/              task/             tax/
template/         timeentry/        view/
```

Total: 47 packages

---

## 6. Frontend Route Structure

### frontend/ (original — `app/(app)/org/[slug]/`)

```
compliance/                          — /compliance
compliance/requests/[id]/            — /compliance/requests/:id
compliance/requests/                 — /compliance/requests
customers/[id]/                      — /customers/:id
customers/                           — /customers
dashboard/                           — /dashboard
documents/                           — /documents
invoices/[id]/                       — /invoices/:id
invoices/                            — /invoices
my-work/                             — /my-work
notifications/                       — /notifications
profitability/                       — /profitability
projects/[id]/                       — /projects/:id
projects/[id]/expenses/              — /projects/:id/expenses
projects/                            — /projects
reports/[reportSlug]/                — /reports/:reportSlug
reports/                             — /reports
retainers/[id]/                      — /retainers/:id
retainers/                           — /retainers
schedules/[id]/                      — /schedules/:id
schedules/                           — /schedules
settings/                            — /settings (general)
settings/acceptance/                 — /settings/acceptance
settings/billing/                    — /settings/billing
settings/checklists/                 — /settings/checklists
settings/checklists/[id]/            — /settings/checklists/:id
settings/checklists/[id]/edit/       — /settings/checklists/:id/edit
settings/checklists/new/             — /settings/checklists/new
settings/clauses/                    — /settings/clauses
settings/compliance/                 — /settings/compliance
settings/custom-fields/              — /settings/custom-fields
settings/email/                      — /settings/email
settings/integrations/               — /settings/integrations
settings/notifications/              — /settings/notifications
settings/project-templates/          — /settings/project-templates
settings/project-templates/[id]/     — /settings/project-templates/:id
settings/rates/                      — /settings/rates
settings/tags/                       — /settings/tags
settings/tax/                        — /settings/tax
settings/templates/                  — /settings/templates
settings/templates/[id]/edit/        — /settings/templates/:id/edit
settings/templates/new/              — /settings/templates/new
team/                                — /team
```

### frontend-v2/ (redesign — `src/app/(app)/org/[slug]/`)

```
compliance/                          — /compliance
customers/[id]/                      — /customers/:id
customers/                           — /customers
dashboard/                           — /dashboard
documents/                           — /documents
invoices/[id]/                       — /invoices/:id
invoices/                            — /invoices
my-work/                             — /my-work
notifications/                       — /notifications
profitability/                       — /profitability
projects/[id]/                       — /projects/:id
projects/                            — /projects
reports/[reportSlug]/                — /reports/:reportSlug
reports/                             — /reports
retainers/[id]/                      — /retainers/:id
retainers/                           — /retainers
schedules/                           — /schedules
settings/                            — /settings
settings/billing/                    — /settings/billing
settings/branding/                   — /settings/branding
settings/clauses/                    — /settings/clauses
settings/cost-rates/                 — /settings/cost-rates
settings/general/                    — /settings/general
settings/integrations/               — /settings/integrations
settings/rates/                      — /settings/rates
settings/tax/                        — /settings/tax
settings/templates/                  — /settings/templates
settings/templates/[id]/             — /settings/templates/:id
team/                                — /team
```

### frontend-v2/ portal routes (`src/app/portal/`)

```
portal/                              — /portal (landing)
portal/documents/                    — /portal/documents
portal/projects/                     — /portal/projects
```

---

## 7. Reference Entity Pattern — AcceptanceRequest

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/acceptance/AcceptanceRequest.java`

```java
package io.b2mash.b2b.b2bstrawman.acceptance;

import io.b2mash.b2b.b2bstrawman.exception.InvalidStateException;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.PrePersist;
import jakarta.persistence.PreUpdate;
import jakarta.persistence.Table;
import java.time.Instant;
import java.util.Objects;
import java.util.Set;
import java.util.UUID;

/** A request for a portal contact to accept a generated document. */
@Entity
@Table(name = "acceptance_requests")
public class AcceptanceRequest {

  private static final Set<AcceptanceStatus> TERMINAL_STATUSES =
      Set.of(AcceptanceStatus.ACCEPTED, AcceptanceStatus.EXPIRED, AcceptanceStatus.REVOKED);

  private static final Set<AcceptanceStatus> ACTIVE_STATUSES =
      Set.of(AcceptanceStatus.PENDING, AcceptanceStatus.SENT, AcceptanceStatus.VIEWED);

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "generated_document_id", nullable = false)
  private UUID generatedDocumentId;

  @Column(name = "portal_contact_id", nullable = false)
  private UUID portalContactId;

  @Column(name = "customer_id", nullable = false)
  private UUID customerId;

  @Enumerated(EnumType.STRING)
  @Column(name = "status", nullable = false, length = 20)
  private AcceptanceStatus status;

  @Column(name = "request_token", nullable = false, length = 255)
  private String requestToken;

  @Column(name = "sent_at")
  private Instant sentAt;

  @Column(name = "viewed_at")
  private Instant viewedAt;

  @Column(name = "accepted_at")
  private Instant acceptedAt;

  @Column(name = "expires_at", nullable = false)
  private Instant expiresAt;

  @Column(name = "revoked_at")
  private Instant revokedAt;

  @Column(name = "acceptor_name", length = 255)
  private String acceptorName;

  @Column(name = "acceptor_ip_address", length = 45)
  private String acceptorIpAddress;

  @Column(name = "acceptor_user_agent", length = 500)
  private String acceptorUserAgent;

  @Column(name = "certificate_s3_key", length = 1000)
  private String certificateS3Key;

  @Column(name = "certificate_file_name", length = 255)
  private String certificateFileName;

  @Column(name = "sent_by_member_id", nullable = false)
  private UUID sentByMemberId;

  @Column(name = "revoked_by_member_id")
  private UUID revokedByMemberId;

  @Column(name = "reminder_count", nullable = false)
  private int reminderCount;

  @Column(name = "last_reminded_at")
  private Instant lastRemindedAt;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  /** JPA-required no-arg constructor. */
  protected AcceptanceRequest() {}

  public AcceptanceRequest(
      UUID generatedDocumentId,
      UUID portalContactId,
      UUID customerId,
      String requestToken,
      Instant expiresAt,
      UUID sentByMemberId) {
    this.generatedDocumentId =
        Objects.requireNonNull(generatedDocumentId, "generatedDocumentId must not be null");
    this.portalContactId =
        Objects.requireNonNull(portalContactId, "portalContactId must not be null");
    this.customerId = Objects.requireNonNull(customerId, "customerId must not be null");
    this.requestToken = Objects.requireNonNull(requestToken, "requestToken must not be null");
    this.expiresAt = Objects.requireNonNull(expiresAt, "expiresAt must not be null");
    this.sentByMemberId = Objects.requireNonNull(sentByMemberId, "sentByMemberId must not be null");
    this.status = AcceptanceStatus.PENDING;
    this.reminderCount = 0;
  }

  @PrePersist
  void onPrePersist() {
    var now = Instant.now();
    this.createdAt = now;
    this.updatedAt = now;
  }

  @PreUpdate
  void onPreUpdate() {
    this.updatedAt = Instant.now();
  }

  // --- Lifecycle methods ---

  public void markSent() {
    requireStatus(Set.of(AcceptanceStatus.PENDING), "mark as sent");
    this.status = AcceptanceStatus.SENT;
    this.sentAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void markViewed(Instant viewedAt) {
    if (this.status == AcceptanceStatus.VIEWED) {
      return; // idempotent
    }
    requireStatus(Set.of(AcceptanceStatus.SENT), "mark as viewed");
    this.status = AcceptanceStatus.VIEWED;
    this.viewedAt = Objects.requireNonNull(viewedAt, "viewedAt must not be null");
    this.updatedAt = Instant.now();
  }

  public void markAccepted(String name, String ip, String ua) {
    requireStatus(Set.of(AcceptanceStatus.SENT, AcceptanceStatus.VIEWED), "mark as accepted");
    this.status = AcceptanceStatus.ACCEPTED;
    this.acceptorName = name;
    this.acceptorIpAddress = ip;
    this.acceptorUserAgent = ua;
    this.acceptedAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void markRevoked(UUID revokedBy) {
    requireStatus(ACTIVE_STATUSES, "revoke");
    this.status = AcceptanceStatus.REVOKED;
    this.revokedByMemberId = Objects.requireNonNull(revokedBy, "revokedBy must not be null");
    this.revokedAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void markExpired() {
    requireStatus(ACTIVE_STATUSES, "mark as expired");
    this.status = AcceptanceStatus.EXPIRED;
    this.updatedAt = Instant.now();
  }

  public void recordReminder() {
    requireStatus(ACTIVE_STATUSES, "record reminder");
    this.reminderCount++;
    this.lastRemindedAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public boolean isActive() {
    return ACTIVE_STATUSES.contains(this.status);
  }

  public boolean isExpired() {
    return Instant.now().isAfter(expiresAt);
  }

  // --- Getters (truncated for brevity — see full file) ---

  public UUID getId() { return id; }
  public UUID getGeneratedDocumentId() { return generatedDocumentId; }
  public UUID getPortalContactId() { return portalContactId; }
  public UUID getCustomerId() { return customerId; }
  public AcceptanceStatus getStatus() { return status; }
  public String getRequestToken() { return requestToken; }
  public Instant getSentAt() { return sentAt; }
  public Instant getViewedAt() { return viewedAt; }
  public Instant getAcceptedAt() { return acceptedAt; }
  public Instant getExpiresAt() { return expiresAt; }
  public Instant getRevokedAt() { return revokedAt; }
  public String getAcceptorName() { return acceptorName; }
  public String getAcceptorIpAddress() { return acceptorIpAddress; }
  public String getAcceptorUserAgent() { return acceptorUserAgent; }
  public String getCertificateS3Key() { return certificateS3Key; }
  public String getCertificateFileName() { return certificateFileName; }
  public UUID getSentByMemberId() { return sentByMemberId; }
  public UUID getRevokedByMemberId() { return revokedByMemberId; }
  public int getReminderCount() { return reminderCount; }
  public Instant getLastRemindedAt() { return lastRemindedAt; }
  public Instant getCreatedAt() { return createdAt; }
  public Instant getUpdatedAt() { return updatedAt; }

  // Setters for certificate fields
  public void setCertificateS3Key(String certificateS3Key) { ... }
  public void setCertificateFileName(String certificateFileName) { ... }

  private void requireStatus(Set<AcceptanceStatus> allowedStatuses, String action) {
    if (!allowedStatuses.contains(this.status)) {
      throw new InvalidStateException(
          "Invalid acceptance request state",
          "Cannot " + action + " acceptance request in status " + this.status);
    }
  }
}
```

### Key Patterns to Follow

- `@Entity` + `@Table(name = "...")` with explicit table name
- UUID primary key with `@GeneratedValue(strategy = GenerationType.UUID)`
- All columns use explicit `@Column(name = "...", nullable = ..., length = ...)`
- Enum fields use `@Enumerated(EnumType.STRING)`
- `@PrePersist` / `@PreUpdate` for timestamp management
- Protected no-arg constructor for JPA
- Public constructor with `Objects.requireNonNull()` validation
- Lifecycle methods with status guard (`requireStatus()` pattern using `InvalidStateException`)
- No Lombok, no `@Data`, no `@Builder` -- plain Java with explicit getters
- Foreign keys stored as UUID fields (not JPA `@ManyToOne` relationships)
- No multitenancy boilerplate -- schema boundary handles isolation

---

## 8. Recent ADR Format Template

File: `adr/ADR-123-template-clause-association-source-of-truth.md`

```markdown
# ADR-123: Template-Clause Association Source of Truth

**Status**: Accepted

**Context**:

[2-3 paragraphs describing the problem, current state, and why a decision is needed.
Include specifics about existing system behavior and what creates tension.]

**Options Considered**:

1. **Option title** -- [Brief summary]
   - Pros:
     - [bullet points]
   - Cons:
     - [bullet points]

2. **Option title** -- [Brief summary]
   - Pros: ...
   - Cons: ...

3. **Option title** -- [Brief summary]
   - Pros: ...
   - Cons: ...

**Decision**: Option N -- [Option title].

**Rationale**:

[3-5 paragraphs explaining why this option was chosen. Reference specific
system behaviors, performance characteristics, and UX principles.
Explain why other options were rejected.]

**Consequences**:

- [Bullet list of concrete consequences: what changes, what is deprecated,
  what downstream systems are affected, what future considerations exist]
- Related: [links to related ADRs]
```

---

## 9. Portal Structure

### Portal Backend (`backend/.../portal/`)

```
CustomerAuthFilter.java          — JWT auth filter for portal contacts
MagicLinkCleanupService.java     — Cleanup expired magic links
MagicLinkService.java            — Generate/exchange magic links
MagicLinkToken.java              — Entity
MagicLinkTokenRepository.java    — Repository
PortalAuthController.java        — Auth endpoints (magic link exchange)
PortalAuthException.java         — Auth-specific exception
PortalBrandingController.java    — Org branding for portal display
PortalContact.java               — Entity (customer contacts with portal access)
PortalContactRepository.java     — Repository
PortalContactService.java        — CRUD for portal contacts
PortalDocumentController.java    — Document access for portal contacts
PortalEmailService.java          — Email delivery for portal
PortalJwtService.java            — JWT generation for portal sessions
PortalProjectController.java     — Project access for portal contacts
PortalQueryService.java          — Cross-entity queries for portal
```

### Portal Frontend — Standalone App (`portal/`)

Separate Next.js app for customer-facing portal.

```
portal/app/
  layout.tsx
  page.tsx                               — Landing/home
  not-found.tsx
  login/page.tsx                         — Login page
  auth/exchange/page.tsx                 — Magic link token exchange
  accept/[token]/page.tsx                — Document acceptance page
  accept/[token]/acceptance-page.tsx     — Acceptance UI component
  (authenticated)/
    layout.tsx                           — Auth-guarded layout
    projects/page.tsx                    — Project list
    projects/[id]/page.tsx               — Project detail
    invoices/page.tsx                    — Invoice list
    invoices/[id]/page.tsx               — Invoice detail
    invoices/[id]/payment-success/       — Payment success page
    invoices/[id]/payment-cancelled/     — Payment cancelled page
    profile/page.tsx                     — Contact profile
```

### Portal in frontend-v2 (`frontend-v2/src/app/portal/`)

```
portal/
  layout.tsx
  page.tsx                  — Portal landing
  documents/page.tsx        — Portal documents list
  projects/page.tsx         — Portal projects list
```

---

## 10. Existing Proposal-Related Code

**No Proposal entity, service, controller, or repository exists in the backend.**

The only references to "proposal" in the entire codebase are:

1. **UI placeholder text** in `frontend/components/documents/documents-panel.tsx`:
   ```
   description="Upload proposals, contracts, and deliverables for this project."
   ```
   This is just an empty-state description string, not a feature.

2. **Phase 32 ideation and requirements docs** (planning/design documents, not implemented code):
   - `.claude/ideas/phase32-ideation-2026-02-28.md`
   - `requirements/claude-code-prompt-phase32.md`
   - `docs/ux-brief/06-documents-templates.md`
   - `docs/ux-brief/00-product-overview.md`
   - `architecture/phase31-document-system-redesign.md`
   - `adr/ADR-119-editor-library-selection.md`
   - `requirements/claude-code-prompt-phase31.md`
   - `.claude/ideas/phase31-ideation-2026-02-28.md`
   - `docs/plans/2026-02-28-document-system-redesign-design.md`

**Conclusion**: Proposals are a greenfield feature. No existing code, entities, migrations, or API endpoints to integrate with or migrate from.

---

## Summary — Next Available Numbers

| Resource | Next Available |
|----------|---------------|
| Architecture section (inline) | 11 |
| ADR | 124 |
| Global migration | V12 |
| Tenant migration | V51 |
| Entity count | 56 existing |
| Backend packages | 47 existing |
