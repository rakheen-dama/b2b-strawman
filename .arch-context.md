# Architecture Context Inventory

Generated: 2026-02-18 (updated for Phase 13 dedicated-schema-only branch)

---

## 1. ARCHITECTURE.md Section Headers

File: `architecture/ARCHITECTURE.md`

| # | Section |
|---|---------|
| 1 | Overview |
| 2 | Architecture Decision Records |
| 3 | Component Architecture |
| 4 | Sequence Diagrams |
| 5 | Data Flow Diagrams |
| 6 | Security Architecture |
| 7 | Infrastructure Architecture |
| 8 | Database Architecture |
| 9 | Phase 2 -- Billing & Tiered Tenancy |
| 10 | Phase 4 -- Customers, Document Scopes & Tasks |
| Appendix A | Clerk JWT Claims |
| Appendix B | Environment Variables Reference |

- **Last numbered section**: 10 (Phase 4)
- **Next available section number**: 11
- **Note**: Phases 5+ have separate architecture docs in `architecture/phase{N}-*.md`

### Separate Architecture Docs

| File | Phase |
|------|-------|
| `phase5-task-time-lifecycle.md` | Phase 5 |
| `phase6-audit-compliance-foundations.md` | Phase 6 |
| `phase6.5-notifications-comments-activity.md` | Phase 6.5 |
| `phase7-customer-portal-backend.md` | Phase 7 |
| `phase8-rate-cards-budgets-profitability.md` | Phase 8 |
| `phase9-operational-dashboards.md` | Phase 9 |
| `phase10-invoicing-billing.md` | Phase 10 |
| `phase11-tags-custom-fields-views.md` | Phase 11 |
| `phase12-document-templates.md` | Phase 12 |
| `phase13-dedicated-schema-only.md` | Phase 13 (current branch -- dedicated schema refactor) |

---

## 2. ADR Numbering

Directory: `adr/`

**Total ADR files**: 55 (ADR-010 through ADR-064)
**Note**: ADR-001 through ADR-009 are inline in `architecture/ARCHITECTURE.md`

**Highest ADR number**: **064** (`ADR-064-dedicated-schema-only.md`)
**Next available ADR number**: **065**

### ADR Ranges by Phase

| Range | Phase |
|-------|-------|
| 001--009 | Inline in ARCHITECTURE.md (Phase 1) |
| 010--016 | Phase 2 (Billing & Tiered Tenancy) |
| 017--020 | Phase 4 (Customers, Documents, Tasks) |
| 021--024 | Phase 5 (Task & Time Lifecycle) |
| 025--029 | Phase 6 (Audit & Compliance Foundations) |
| 030--033 | Phase 7 (Customer Portal Backend) |
| 034--038 | Phase 6.5 (Notifications, Comments, Activity) |
| 039--043 | Phase 8 (Rate Cards, Budgets, Profitability) |
| 044--047 | Phase 9 (Operational Dashboards) |
| 048--051 | Phase 10 (Invoicing & Billing) |
| 052--055 | Phase 11 (Tags, Custom Fields, Views) |
| 056--059 | Phase 12 (Document Templates) |
| 060--063 | Phase 13 requirements (Lifecycle, Checklists, Anonymization, Compliance Packs) |
| 064 | Phase 13 (Dedicated Schema Only) |

---

## 3. Migration Numbering

### Global Migrations (`db/migration/global/`)

| Version | Description |
|---------|-------------|
| V1 | create_org_schema_mapping |
| V2 | create_organizations |
| V3 | create_processed_webhooks |
| V4 | add_org_tier |
| V5 | drop_schema_name_unique |
| V6 | add_subscriptions |
| V7 | create_portal_schema |

**Highest global migration**: **V7**
**Next available global migration**: **V8**

### Tenant Migrations (`db/migration/tenant/`)

| Version | Description |
|---------|-------------|
| V1 | create_projects |
| V2 | create_documents |
| V3 | create_members |
| V4 | migrate_ownership_to_members |
| V5 | create_project_members |
| V6 | add_missing_fk_indexes |
| V7 | add_tenant_id_for_shared |
| V8 | shared_schema_member_unique |
| V9 | create_customers |
| V10 | create_customer_projects |
| V11 | create_tasks |
| V12 | extend_documents_scope |
| V13 | create_time_entries |
| V14 | create_audit_events |
| V15 | create_comments |
| V16 | create_notifications |
| V17 | create_notification_preferences |
| V18 | create_portal_contacts_and_magic_link_tokens |
| V19 | create_rate_budget_tables |
| V20 | add_time_entry_rate_snapshots |
| V21 | add_project_budget_version |
| V22 | add_dashboard_indexes |
| V23 | create_invoices |
| V24 | add_field_definitions_groups |
| V25 | add_tags |
| V26 | add_field_pack_status |
| V27 | add_custom_field_columns |
| V28 | add_saved_views |
| V29 | create_document_templates |
| V30 | add_branding_and_template_pack_status |

**Highest tenant migration**: **V30**
**Next available tenant migration**: **V31**

---

## 4. Entity Inventory

32 `@Entity` classes total:

| Entity | Package | File (relative to `backend/src/main/java/io/b2mash/b2b/b2bstrawman/`) |
|--------|---------|------------------------------------------------------------------------|
| OrgSchemaMapping | multitenancy | `multitenancy/OrgSchemaMapping.java` |
| Organization | provisioning | `provisioning/Organization.java` |
| Subscription | billing | `billing/Subscription.java` |
| Project | project | `project/Project.java` |
| Document | document | `document/Document.java` |
| Member | member | `member/Member.java` |
| ProjectMember | member | `member/ProjectMember.java` |
| Customer | customer | `customer/Customer.java` |
| CustomerProject | customer | `customer/CustomerProject.java` |
| Task | task | `task/Task.java` |
| TimeEntry | timeentry | `timeentry/TimeEntry.java` |
| AuditEvent | audit | `audit/AuditEvent.java` |
| Comment | comment | `comment/Comment.java` |
| Notification | notification | `notification/Notification.java` |
| NotificationPreference | notification | `notification/NotificationPreference.java` |
| PortalContact | portal | `portal/PortalContact.java` |
| MagicLinkToken | portal | `portal/MagicLinkToken.java` |
| OrgSettings | settings | `settings/OrgSettings.java` |
| BillingRate | billingrate | `billingrate/BillingRate.java` |
| CostRate | costrate | `costrate/CostRate.java` |
| ProjectBudget | budget | `budget/ProjectBudget.java` |
| Invoice | invoice | `invoice/Invoice.java` |
| InvoiceLine | invoice | `invoice/InvoiceLine.java` |
| InvoiceCounter | invoice | `invoice/InvoiceCounter.java` |
| FieldDefinition | fielddefinition | `fielddefinition/FieldDefinition.java` |
| FieldGroup | fielddefinition | `fielddefinition/FieldGroup.java` |
| FieldGroupMember | fielddefinition | `fielddefinition/FieldGroupMember.java` |
| Tag | tag | `tag/Tag.java` |
| EntityTag | tag | `tag/EntityTag.java` |
| SavedView | view | `view/SavedView.java` |
| DocumentTemplate | template | `template/DocumentTemplate.java` |
| GeneratedDocument | template | `template/GeneratedDocument.java` |

---

## 5. Backend Package Structure

33 top-level packages under `io.b2mash.b2b.b2bstrawman`:

```
activity/          -- Activity feed service (reads audit events)
audit/             -- AuditEvent entity, repository, service, controller, builder
billing/           -- Subscription entity, SubscriptionService, PlanSyncService
billingrate/       -- BillingRate entity, repository, service, controller
budget/            -- ProjectBudget entity, repository, service, BudgetCheckService
comment/           -- Comment entity, repository, service, controller
config/            -- Spring config beans (Security, S3, Cors, DevPortal, etc.)
costrate/          -- CostRate entity, repository, service, controller
customer/          -- Customer + CustomerProject entities, services, controllers
customerbackend/   -- Customer-facing backend APIs (portal backend)
dashboard/         -- Dashboard aggregation service, controller
dev/               -- Dev portal controller (Thymeleaf test harness)
document/          -- Document entity, repository, service, controller
event/             -- Spring application event classes
exception/         -- Shared semantic exceptions
fielddefinition/   -- FieldDefinition, FieldGroup, FieldGroupMember, FieldPackSeeder
invoice/           -- Invoice, InvoiceLine, InvoiceCounter, InvoiceNumberService
member/            -- Member, ProjectMember entities, MemberSyncService
multitenancy/      -- RequestScopes, OrgSchemaMapping, TenantFilter, ConnectionProvider, Config
mywork/            -- "My Work" cross-project service, controller
notification/      -- Notification, NotificationPreference, channel/, template/
portal/            -- PortalContact, MagicLinkToken, portal auth
project/           -- Project entity, ProjectAccessService, controller
provisioning/      -- Organization, TenantProvisioningService, TenantMigrationRunner
report/            -- Profitability report service, controller
s3/                -- S3 presigned URL service
security/          -- ClerkJwtAuthFilter, ApiKeyAuthFilter, ClerkJwtUtils
settings/          -- OrgSettings entity, repository, service, controller
tag/               -- Tag, EntityTag entities, services, controllers
task/              -- Task entity, repository, service, controller
template/          -- DocumentTemplate, GeneratedDocument, TemplatePackSeeder, rendering
timeentry/         -- TimeEntry entity, repository, service, controller
view/              -- SavedView entity, ViewFilterService, filter handlers
```

---

## 6. Frontend Route Structure

Pages under `frontend/app/(app)/org/[slug]/`:

```
dashboard/page.tsx
customers/page.tsx
customers/[id]/page.tsx
documents/page.tsx
invoices/page.tsx
invoices/[id]/page.tsx
my-work/page.tsx
notifications/page.tsx
profitability/page.tsx
projects/page.tsx
projects/[id]/page.tsx
settings/page.tsx
settings/billing/page.tsx
settings/custom-fields/page.tsx
settings/notifications/page.tsx
settings/rates/page.tsx
settings/tags/page.tsx
settings/templates/page.tsx
settings/templates/new/page.tsx
settings/templates/[id]/edit/page.tsx
team/page.tsx
```

**Total**: 21 page routes

---

## 7. Entity Source Code (Phase 14 Reference)

### 7.1 Customer Entity

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/customer/Customer.java`

```java
package io.b2mash.b2b.b2bstrawman.customer;

import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAware;
import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAwareEntityListener;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.time.Instant;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import org.hibernate.annotations.Filter;
import org.hibernate.annotations.FilterDef;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.annotations.ParamDef;
import org.hibernate.type.SqlTypes;

@Entity
@Table(name = "customers")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class Customer implements TenantAware {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "name", nullable = false, length = 255)
  private String name;

  @Column(name = "email", nullable = false, length = 255)
  private String email;

  @Column(name = "phone", length = 50)
  private String phone;

  @Column(name = "id_number", length = 100)
  private String idNumber;

  @Column(name = "status", nullable = false, length = 20)
  private String status;

  @Column(name = "notes", columnDefinition = "TEXT")
  private String notes;

  @Column(name = "created_by", nullable = false)
  private UUID createdBy;

  @Column(name = "tenant_id")
  private String tenantId;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "custom_fields", columnDefinition = "jsonb")
  private Map<String, Object> customFields = new HashMap<>();

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "applied_field_groups", columnDefinition = "jsonb")
  private List<UUID> appliedFieldGroups;

  protected Customer() {}

  public Customer(
      String name, String email, String phone, String idNumber, String notes, UUID createdBy) {
    this.name = name;
    this.email = email;
    this.phone = phone;
    this.idNumber = idNumber;
    this.status = "ACTIVE";
    this.notes = notes;
    this.createdBy = createdBy;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void update(String name, String email, String phone, String idNumber, String notes) {
    this.name = name;
    this.email = email;
    this.phone = phone;
    this.idNumber = idNumber;
    this.notes = notes;
    this.updatedAt = Instant.now();
  }

  public void archive() {
    this.status = "ARCHIVED";
    this.updatedAt = Instant.now();
  }

  public UUID getId() { return id; }
  public String getName() { return name; }
  public String getEmail() { return email; }
  public String getPhone() { return phone; }
  public String getIdNumber() { return idNumber; }
  public String getStatus() { return status; }
  public String getNotes() { return notes; }
  public UUID getCreatedBy() { return createdBy; }
  @Override public String getTenantId() { return tenantId; }
  @Override public void setTenantId(String tenantId) { this.tenantId = tenantId; }
  public Instant getCreatedAt() { return createdAt; }
  public Instant getUpdatedAt() { return updatedAt; }
  public Map<String, Object> getCustomFields() { return customFields; }
  public void setCustomFields(Map<String, Object> customFields) {
    this.customFields = customFields;
    this.updatedAt = Instant.now();
  }
  public List<UUID> getAppliedFieldGroups() { return appliedFieldGroups; }
  public void setAppliedFieldGroups(List<UUID> appliedFieldGroups) {
    this.appliedFieldGroups = appliedFieldGroups;
    this.updatedAt = Instant.now();
  }
}
```

**Key observations for Phase 14**:
- Has `status` field (String, length 20) currently used for "ACTIVE"/"ARCHIVED"
- Phase 14 adds `lifecycle_status` as a separate field (PROSPECT/ONBOARDING/ACTIVE/DORMANT/OFFBOARDED)
- Already implements `TenantAware` (being simplified by Phase 13 branch)
- Has `custom_fields` JSONB and `applied_field_groups` JSONB
- Constructor defaults `status` to "ACTIVE"

### 7.2 DocumentTemplate Entity (Recent Pattern Reference)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/template/DocumentTemplate.java`

```java
package io.b2mash.b2b.b2bstrawman.template;

import io.b2mash.b2b.b2bstrawman.exception.InvalidStateException;
import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAware;
import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAwareEntityListener;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.time.Instant;
import java.util.UUID;
import java.util.regex.Pattern;
import org.hibernate.annotations.Filter;
import org.hibernate.annotations.FilterDef;
import org.hibernate.annotations.ParamDef;

@Entity
@Table(name = "document_templates")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class DocumentTemplate implements TenantAware {

  private static final Pattern SLUG_PATTERN = Pattern.compile("^[a-z][a-z0-9-]*$");

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "name", nullable = false, length = 200)
  private String name;

  @Column(name = "slug", nullable = false, length = 200)
  private String slug;

  @Column(name = "description", columnDefinition = "TEXT")
  private String description;

  @Enumerated(EnumType.STRING)
  @Column(name = "category", nullable = false, length = 30)
  private TemplateCategory category;

  @Enumerated(EnumType.STRING)
  @Column(name = "primary_entity_type", nullable = false, length = 20)
  private TemplateEntityType primaryEntityType;

  @Column(name = "content", nullable = false, columnDefinition = "TEXT")
  private String content;

  @Column(name = "css", columnDefinition = "TEXT")
  private String css;

  @Enumerated(EnumType.STRING)
  @Column(name = "source", nullable = false, length = 20)
  private TemplateSource source;

  @Column(name = "source_template_id")
  private UUID sourceTemplateId;

  @Column(name = "pack_id", length = 100)
  private String packId;

  @Column(name = "pack_template_key", length = 100)
  private String packTemplateKey;

  @Column(name = "active", nullable = false)
  private boolean active;

  @Column(name = "sort_order", nullable = false)
  private int sortOrder;

  @Column(name = "tenant_id")
  private String tenantId;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  protected DocumentTemplate() {}

  public DocumentTemplate(
      TemplateEntityType primaryEntityType,
      String name,
      String slug,
      TemplateCategory category,
      String content) {
    this.primaryEntityType = primaryEntityType;
    this.name = name;
    this.slug = slug;
    this.category = category;
    this.content = content;
    this.source = TemplateSource.ORG_CUSTOM;
    this.active = true;
    this.sortOrder = 0;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public static String generateSlug(String name) {
    if (name == null || name.isBlank()) {
      throw new InvalidStateException("Invalid slug", "Template name cannot be blank");
    }
    String slug =
        name.toLowerCase()
            .replaceAll("[\\s]+", "-")
            .replaceAll("[^a-z0-9-]", "")
            .replaceAll("-+", "-")
            .replaceAll("^-|-$", "");
    if (slug.isEmpty() || !SLUG_PATTERN.matcher(slug).matches()) {
      throw new InvalidStateException(
          "Invalid slug",
          "Generated slug '" + slug + "' from name '" + name
              + "' does not match pattern ^[a-z][a-z0-9-]*$");
    }
    return slug;
  }

  public void updateContent(String name, String description, String content, String css) {
    this.name = name;
    this.description = description;
    this.content = content;
    this.css = css;
    this.updatedAt = Instant.now();
  }

  public void deactivate() {
    this.active = false;
    this.updatedAt = Instant.now();
  }

  // Getters + setters for mutable fields (css, description, sortOrder, packId,
  // packTemplateKey, sourceTemplateId, source) ...
  // Standard TenantAware getTenantId()/setTenantId() ...
}
```

**Key patterns to follow**:
- `@Enumerated(EnumType.STRING)` for enum columns
- `pack_id` / `pack_template_key` for pack-seeded entities
- `source` field (PLATFORM vs ORG_CUSTOM) for distinguishing seeded vs user-created
- Protected no-arg constructor + public constructor with required fields
- Business methods (updateContent, deactivate) with `updatedAt = Instant.now()`

### 7.3 OrgSettings Entity

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/settings/OrgSettings.java`

```java
package io.b2mash.b2b.b2bstrawman.settings;

import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAware;
import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAwareEntityListener;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.time.Instant;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import org.hibernate.annotations.Filter;
import org.hibernate.annotations.FilterDef;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.annotations.ParamDef;
import org.hibernate.type.SqlTypes;

@Entity
@Table(name = "org_settings")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class OrgSettings implements TenantAware {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "default_currency", nullable = false, length = 3)
  private String defaultCurrency;

  @Column(name = "tenant_id")
  private String tenantId;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "field_pack_status", columnDefinition = "jsonb")
  private List<Map<String, Object>> fieldPackStatus;

  @Column(name = "logo_s3_key", length = 500)
  private String logoS3Key;

  @Column(name = "brand_color", length = 7)
  private String brandColor;

  @Column(name = "document_footer_text", columnDefinition = "TEXT")
  private String documentFooterText;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "template_pack_status", columnDefinition = "jsonb")
  private List<Map<String, Object>> templatePackStatus;

  protected OrgSettings() {}

  public OrgSettings(String defaultCurrency) {
    this.defaultCurrency = defaultCurrency;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void updateCurrency(String currency) {
    this.defaultCurrency = currency;
    this.updatedAt = Instant.now();
  }

  // Getters for: id, defaultCurrency, createdAt, updatedAt, tenantId
  // TenantAware: getTenantId(), setTenantId()
  // Field pack: getFieldPackStatus(), setFieldPackStatus(), recordPackApplication(packId, version)
  // Branding: getLogoS3Key()/set, getBrandColor()/set, getDocumentFooterText()/set
  // Template pack: getTemplatePackStatus(), setTemplatePackStatus(), recordTemplatePackApplication(packId, version)

  public void recordPackApplication(String packId, int version) {
    if (this.fieldPackStatus == null) {
      this.fieldPackStatus = new ArrayList<>();
    }
    var entry = new HashMap<String, Object>();
    entry.put("packId", packId);
    entry.put("version", version);
    entry.put("appliedAt", Instant.now().toString());
    this.fieldPackStatus.add(entry);
    this.updatedAt = Instant.now();
  }

  public void recordTemplatePackApplication(String packId, int version) {
    if (this.templatePackStatus == null) {
      this.templatePackStatus = new ArrayList<>();
    }
    var entry = new HashMap<String, Object>();
    entry.put("packId", packId);
    entry.put("version", version);
    entry.put("appliedAt", Instant.now().toString());
    this.templatePackStatus.add(entry);
    this.updatedAt = Instant.now();
  }
}
```

**Current OrgSettings columns**: id, default_currency, tenant_id, created_at, updated_at, field_pack_status (jsonb), logo_s3_key, brand_color, document_footer_text, template_pack_status (jsonb)

**Phase 14 additions needed**: `dormancy_threshold_days` (integer), `data_request_deadline_days` (integer), plus likely `compliance_pack_status` (jsonb) for the compliance pack seeder

---

## 8. Recent ADR Format Template

From `adr/ADR-064-dedicated-schema-only.md`:

```markdown
# ADR-064: Dedicated Schema for All Tenants

**Status**: Accepted
**Supersedes**: [ADR-012](ADR-012-row-level-isolation.md), partially supersedes [ADR-015](ADR-015-provisioning-per-tier.md)

**Context**:

[Multiple paragraphs describing the current situation, problems, and motivation]

**Options Considered**:

1. **Option name (status quo / chosen)** -- Brief description.
   - Pros: ...
   - Cons: ...

2. **Option name (chosen)** -- Brief description.
   - Pros: ...
   - Cons: ...

3. **Option name** -- Brief description.
   - Pros: ...
   - Cons: ...

**Decision**: Option N -- brief statement.

**Rationale**:

[Multiple paragraphs explaining why]

**Consequences**:

- Positive:
  - ...

- Negative:
  - ...

- Neutral:
  - ...
```

---

## 9. TenantAware Interface (Current State on Phase 13 Branch)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/multitenancy/TenantAware.java`

```java
package io.b2mash.b2b.b2bstrawman.multitenancy;

/**
 * Marker interface for tenant-scoped entities. Retained as a stub so existing {@code implements
 * TenantAware} declarations and {@code @Override getTenantId()/setTenantId()} compile until Epic 97
 * strips them.
 */
public interface TenantAware {
  String getTenantId();
  void setTenantId(String tenantId);
}
```

**Note**: Phase 13 (dedicated-schema-only branch) is in progress. The `TenantAwareEntityListener` and `TenantFilterTransactionManager` have been **deleted** on this branch. `TenantInfo` has been **deleted**. `TenantAware` is retained as a stub. Entity classes still `implements TenantAware` but this will be stripped in a follow-up epic (97).

---

## 10. Pack Seeder Pattern

### Directory Structure

```
backend/src/main/resources/
├── field-packs/
│   ├── common-customer.json      # Flat JSON, one pack per file
│   └── common-project.json
└── template-packs/
    └── common/                   # Directory per pack
        ├── pack.json             # Pack manifest
        ├── engagement-letter.html
        ├── invoice-cover-letter.html
        └── project-summary.html
```

### Field Pack JSON Format (`field-packs/*.json`)

```json
{
  "packId": "common-customer",
  "version": 1,
  "entityType": "CUSTOMER",
  "group": {
    "slug": "contact_address",
    "name": "Contact & Address",
    "description": "Standard contact and address fields for customers"
  },
  "fields": [
    {
      "slug": "address_line1",
      "name": "Address Line 1",
      "fieldType": "TEXT",
      "description": "Street address",
      "required": false,
      "sortOrder": 1
    }
  ]
}
```

### Template Pack JSON Format (`template-packs/*/pack.json`)

```json
{
  "packId": "common",
  "version": 1,
  "name": "Common Templates",
  "description": "Standard document templates for all organizations",
  "templates": [
    {
      "templateKey": "engagement-letter",
      "name": "Standard Engagement Letter",
      "category": "ENGAGEMENT_LETTER",
      "primaryEntityType": "PROJECT",
      "contentFile": "engagement-letter.html",
      "cssFile": null,
      "description": "Client engagement letter template",
      "sortOrder": 1
    }
  ]
}
```

### Seeder Class Pattern (Common to Both)

Both `FieldPackSeeder` and `TemplatePackSeeder` follow the same pattern:

1. **Classpath scanning**: `ResourcePatternResolver.getResources("classpath:*-packs/*.json")`
2. **Idempotency via OrgSettings**: Check `OrgSettings.fieldPackStatus` / `templatePackStatus` (JSONB list of `{packId, version, appliedAt}`)
3. **ScopedValue binding**: `ScopedValue.where(RequestScopes.TENANT_ID, tenantId).where(RequestScopes.ORG_ID, orgId).run(...)`
4. **TransactionTemplate**: All seeding within a single transaction
5. **Called from provisioning**: `TenantProvisioningService` calls seeders after Flyway migrations
6. **OrgSettings upsert**: If no OrgSettings exists, creates one with defaults

### Seeder Method Signature

```java
public void seedPacksForTenant(String tenantId, String orgId)
```

### TemplatePackSeeder (Full Source)

```java
@Service
public class TemplatePackSeeder {
  private static final String PACK_LOCATION = "classpath:template-packs/*/pack.json";

  private final ResourcePatternResolver resourceResolver;
  private final ObjectMapper objectMapper;
  private final DocumentTemplateRepository documentTemplateRepository;
  private final OrgSettingsRepository orgSettingsRepository;
  private final TransactionTemplate transactionTemplate;

  public void seedPacksForTenant(String tenantId, String orgId) {
    ScopedValue.where(RequestScopes.TENANT_ID, tenantId)
        .where(RequestScopes.ORG_ID, orgId)
        .run(() -> transactionTemplate.executeWithoutResult(tx -> doSeedPacks(tenantId)));
  }

  private void doSeedPacks(String tenantId) {
    List<PackWithResource> packs = loadPacks();
    // ... get or create OrgSettings ...
    for (PackWithResource packEntry : packs) {
      if (isPackAlreadyApplied(settings, pack.packId())) continue;
      applyPack(pack, packEntry.packResource());
      settings.recordTemplatePackApplication(pack.packId(), pack.version());
    }
    orgSettingsRepository.save(settings);
  }

  private boolean isPackAlreadyApplied(OrgSettings settings, String packId) {
    if (settings.getTemplatePackStatus() == null) return false;
    return settings.getTemplatePackStatus().stream()
        .anyMatch(entry -> packId.equals(entry.get("packId")));
  }

  private void applyPack(TemplatePackDefinition pack, Resource packJsonResource) {
    for (TemplatePackTemplate templateDef : pack.templates()) {
      // ... create DocumentTemplate from pack definition ...
      dt.setSource(TemplateSource.PLATFORM);
      dt.setPackId(pack.packId());
      dt.setPackTemplateKey(templateDef.templateKey());
      documentTemplateRepository.save(dt);
    }
  }
}
```

### For Phase 14 Compliance Packs

The compliance pack seeder should follow the same pattern:
- Directory: `backend/src/main/resources/compliance-packs/`
- Pack manifest: JSON with `packId`, `version`, checklist template definitions
- Seeder class: `CompliancePackSeeder` in the `checklist/` (or `compliance/`) package
- Idempotency: Add `compliance_pack_status` JSONB column to `OrgSettings`
- Called from `TenantProvisioningService.seedPacksForTenant()`

---

## Quick Reference Summary

| Item | Current Highest | Next Available |
|------|----------------|----------------|
| ARCHITECTURE.md section | 10 | 11 |
| ADR number | 064 | 065 |
| Global migration | V7 | V8 |
| Tenant migration | V30 | V31 |
| Entity count | 32 | -- |
| Backend packages | 33 | -- |
| Frontend page routes | 21 | -- |
