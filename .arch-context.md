# Architecture Context Inventory — Invoice/Billing Phase

Generated: 2026-02-14 | Domain: invoice, invoicing, billing, payment, PSP, line item, unbilled time, customer

---

## 1. Numbering

- **Next architecture section**: 11 (last numbered = `## 10. Phase 4`; appendices are unnumbered)
- **Next ADR**: 048 (last = `adr/ADR-047-dashboard-layout-strategy.md`)
- **Next tenant migration**: V22 (last = `V21__add_project_budget_version.sql`)

---

## 2. Relevant Entities

### Directly relevant (billing/rate/customer domain)

| Entity | Package | Table | File |
|--------|---------|-------|------|
| `BillingRate` | `billingrate` | `billing_rates` | `backend/src/main/java/.../billingrate/BillingRate.java` |
| `CostRate` | `costrate` | `cost_rates` | `backend/src/main/java/.../costrate/CostRate.java` |
| `Customer` | `customer` | `customers` | `backend/src/main/java/.../customer/Customer.java` |
| `CustomerProject` | `customer` | `customer_projects` | `backend/src/main/java/.../customer/CustomerProject.java` |
| `TimeEntry` | `timeentry` | `time_entries` | `backend/src/main/java/.../timeentry/TimeEntry.java` |
| `ProjectBudget` | `budget` | `project_budgets` | `backend/src/main/java/.../budget/ProjectBudget.java` |
| `OrgSettings` | `settings` | `org_settings` | `backend/src/main/java/.../settings/OrgSettings.java` |
| `Subscription` | `billing` | `subscriptions` | `backend/src/main/java/.../billing/Subscription.java` |

### Referenced entities (via FK relationships)

| Entity | Table | Relevant FK |
|--------|-------|-------------|
| `Project` | `projects` | BillingRate.projectId, ProjectBudget.projectId, TimeEntry via Task |
| `Member` | `members` | BillingRate.memberId, CostRate.memberId, TimeEntry.memberId |
| `Task` | `tasks` | TimeEntry.taskId |

---

## 3. Reference Entity Pattern (ProjectBudget — most recent, Phase 8)

```java
package io.b2mash.b2b.b2bstrawman.budget;

import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAware;
import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAwareEntityListener;
import jakarta.persistence.*;
import java.math.BigDecimal;
import java.time.Instant;
import java.util.UUID;
import org.hibernate.annotations.Filter;
import org.hibernate.annotations.FilterDef;
import org.hibernate.annotations.ParamDef;

@Entity
@Table(name = "project_budgets")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class ProjectBudget implements TenantAware {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "project_id", nullable = false, unique = true)
  private UUID projectId;

  @Column(name = "budget_hours", precision = 10, scale = 2)
  private BigDecimal budgetHours;

  @Column(name = "budget_amount", precision = 14, scale = 2)
  private BigDecimal budgetAmount;

  @Column(name = "budget_currency", length = 3)
  private String budgetCurrency;

  @Column(name = "alert_threshold_pct", nullable = false)
  private int alertThresholdPct = 80;

  @Column(name = "threshold_notified", nullable = false)
  private boolean thresholdNotified = false;

  @Column(name = "notes", columnDefinition = "TEXT")
  private String notes;

  @Version private Long version;

  @Column(name = "tenant_id")
  private String tenantId;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  protected ProjectBudget() {}

  public ProjectBudget(UUID projectId, BigDecimal budgetHours, BigDecimal budgetAmount,
      String budgetCurrency, int alertThresholdPct, String notes) {
    this.projectId = projectId;
    this.budgetHours = budgetHours;
    this.budgetAmount = budgetAmount;
    this.budgetCurrency = budgetCurrency;
    this.alertThresholdPct = alertThresholdPct;
    this.notes = notes;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  // Domain methods: updateBudget(), resetThresholdNotified(), markThresholdNotified()
  // Standard: TenantAware (getTenantId/setTenantId), getters, no setters (except via domain methods)
}
```

**Pattern notes:**
- All entities implement `TenantAware` with `@FilterDef`/`@Filter`/`@EntityListeners(TenantAwareEntityListener.class)`
- UUID primary key with `GenerationType.UUID`
- `tenant_id` column (set by listener, not constructor)
- `created_at`/`updated_at` Instant fields (set in constructor, not `@PrePersist`)
- Protected no-arg constructor + public business constructor
- Domain methods for mutations (not raw setters)
- `@Version` for optimistic locking where needed

---

## 4. Reference ADR Template (ADR-047)

```markdown
# ADR-047: Dashboard Layout — Opinionated Fixed Layout

**Status**: Accepted

**Context**: [2-3 paragraphs describing the problem, constraints, and domain context]

**Options Considered**:

1. **Option name** -- Description
   - Pros: [bulleted list]
   - Cons: [bulleted list]

2. **Option name** -- Description
   - Pros: [bulleted list]
   - Cons: [bulleted list]

3. **Option name** -- Description
   - Pros: [bulleted list]
   - Cons: [bulleted list]

**Decision**: [Selected option with brief reference]

**Rationale**:
1. [Numbered reasoning points, each with a bold label and explanation]

**Consequences**:
- [Bulleted list of concrete implications for the codebase]
```

---

## 5. Existing Billing/Rate Infrastructure

### BillingRate fields
| Field | Type | Notes |
|-------|------|-------|
| `id` | `UUID` | PK |
| `memberId` | `UUID` | Required — rate is per-member |
| `projectId` | `UUID` | Nullable — project override scope |
| `customerId` | `UUID` | Nullable — customer override scope |
| `currency` | `String(3)` | ISO currency code |
| `hourlyRate` | `BigDecimal(12,2)` | |
| `effectiveFrom` | `LocalDate` | Required |
| `effectiveTo` | `LocalDate` | Nullable (open-ended) |
| Scope hierarchy: `PROJECT_OVERRIDE` > `CUSTOMER_OVERRIDE` > `MEMBER_DEFAULT` |

### CostRate fields
| Field | Type | Notes |
|-------|------|-------|
| `id` | `UUID` | PK |
| `memberId` | `UUID` | Required |
| `currency` | `String(3)` | |
| `hourlyCost` | `BigDecimal(12,2)` | |
| `effectiveFrom` | `LocalDate` | Required |
| `effectiveTo` | `LocalDate` | Nullable |

### TimeEntry fields (billing-relevant)
| Field | Type | Notes |
|-------|------|-------|
| `id` | `UUID` | PK |
| `taskId` | `UUID` | Links to Task (which links to Project) |
| `memberId` | `UUID` | Who logged the time |
| `date` | `LocalDate` | |
| `durationMinutes` | `int` | |
| `billable` | `boolean` | Key flag for invoicing |
| `billingRateSnapshot` | `BigDecimal(12,2)` | Snapshotted at creation/re-snapshot |
| `billingRateCurrency` | `String(3)` | |
| `costRateSnapshot` | `BigDecimal(12,2)` | |
| `costRateCurrency` | `String(3)` | |
| `rateCents` | `Integer` | **@Deprecated** — legacy field |
| Computed: `getBillableValue()` = (minutes/60) * billingRateSnapshot |
| Computed: `getCostValue()` = (minutes/60) * costRateSnapshot |

### Customer fields
| Field | Type | Notes |
|-------|------|-------|
| `id` | `UUID` | PK |
| `name` | `String(255)` | |
| `email` | `String(255)` | |
| `phone` | `String(50)` | Nullable |
| `idNumber` | `String(100)` | Nullable — tax/company ID |
| `status` | `String(20)` | `ACTIVE` / `ARCHIVED` |
| `notes` | `TEXT` | Nullable |
| `createdBy` | `UUID` | Member who created |

### OrgSettings fields
| Field | Type | Notes |
|-------|------|-------|
| `id` | `UUID` | PK |
| `defaultCurrency` | `String(3)` | ISO currency — used as fallback for rates/budgets |

### Subscription fields
| Field | Type | Notes |
|-------|------|-------|
| `id` | `UUID` | PK |
| `organizationId` | `UUID` | |
| `planSlug` | `String` | e.g. `starter-plan`, `pro-plan` |
| `status` | `SubscriptionStatus` | Enum |
| `currentPeriodStart` / `End` | `Instant` | |

### Notification types (string constants)
- `TASK_ASSIGNED` — when a task is assigned to a member
- `COMMENT_ADDED` — when a comment is posted on a task/document
- `BUDGET_ALERT` — when a project budget threshold is reached

### Audit event types (string constants, `entity.action` format)
- `project.created`, `project.updated`, `project.deleted`
- `document.created`, `document.uploaded`, `document.deleted`, `document.accessed`, `document.visibility_changed`
- `security.document_accessed`
- `member.synced`, `member.role_changed`, `member.removed`
- `project_member.added`, `project_member.removed`, `project_member.role_changed`
- `time_entry.created`, `time_entry.updated`, `time_entry.deleted`, `time_entry.rate_re_snapshot`
- `comment.created`, `comment.updated`, `comment.deleted`, `comment.visibility_changed`
- `org_settings.updated`

---

## 6. Key Relationships for Invoice Design

```
Customer (1) --< CustomerProject >-- (1) Project
Project  (1) --< Task (1) --< TimeEntry (billable=true, billingRateSnapshot)
Member   (1) --< BillingRate (scoped: member-default / customer-override / project-override)
Member   (1) --< CostRate
OrgSettings --> defaultCurrency (fallback for new rates/invoices)
```

**Unbilled time entry query shape**: `TimeEntry WHERE billable=true AND NOT YET invoiced` — requires a new FK or status flag linking TimeEntry to an InvoiceLineItem.

**Rate snapshot pattern**: Rates are snapshotted onto TimeEntry at creation (and can be re-snapshotted via `time_entry.rate_re_snapshot` audit event). Invoices should use the snapshotted rate on the TimeEntry, not re-resolve from BillingRate.
