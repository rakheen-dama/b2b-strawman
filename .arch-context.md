# Architecture Context Inventory

Collected 2026-02-14 for phase design involving: field definition, custom field, tag, saved view, field pack, field group, JSONB storage, entity type enum.

---

## 1. Numbering

- **Next architecture section**: 11 (last numbered in `ARCHITECTURE.md` is `## 10. Phase 4`; phases 5+ use separate `architecture/phase{N}-*.md` files)
- **Next ADR number**: 052 (last on disk: `adr/ADR-051-psp-adapter-design.md`)
- **Next tenant migration**: V23 (last: `V22__add_dashboard_indexes.sql`)
- **Next global migration**: V8 (last: `V7__create_portal_schema.sql`)

---

## 2. Relevant Entities

Entities that will be referenced or extended by custom fields, tags, and saved views:

| Entity | Package | Table | Relevance |
|--------|---------|-------|-----------|
| `Project` | `project/` | `projects` | Target entity type for custom fields and tags |
| `Task` | `task/` | `tasks` | Target entity type for custom fields and tags |
| `Customer` | `customer/` | `customers` | Target entity type for custom fields and tags |
| `OrgSettings` | `settings/` | `org_settings` | Org-level config; field packs may extend this |
| `AuditEvent` | `audit/` | `audit_events` | **Only existing JSONB usage** (`Map<String, Object> details`) |
| `BillingRate` | `billingrate/` | `billing_rates` | Scoped entity pattern (nullable member/project/customer FKs) |

All paths relative to `backend/src/main/java/io/b2mash/b2b/b2bstrawman/`.

### Common Entity Boilerplate

```java
@Entity
@Table(name = "table_name")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class Foo implements TenantAware {
    @Id @GeneratedValue(strategy = GenerationType.UUID) private UUID id;
    @Column(name = "tenant_id") private String tenantId;
    @Column(name = "created_at", nullable = false, updatable = false) private Instant createdAt;
    @Column(name = "updated_at", nullable = false) private Instant updatedAt;
    protected Foo() {}
    // constructor sets createdAt = updatedAt = Instant.now()
}
```

### Existing Enum / Type Patterns

The codebase uses **string columns** for type discrimination, not Java `@Enumerated`:
- `Task.status` -- `"OPEN"`, `"IN_PROGRESS"` (String, length 20)
- `Task.priority` -- `"MEDIUM"` etc. (String, length 20)
- `Customer.status` -- `"ACTIVE"`, `"ARCHIVED"` (String, length 20)
- `AuditEvent.entityType` -- `"PROJECT"`, `"TASK"` etc. (String, length 50)

### JSONB Pattern (AuditEvent)

```java
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

@JdbcTypeCode(SqlTypes.JSON)
@Column(name = "details", columnDefinition = "jsonb")
private Map<String, Object> details;
```

Migration SQL: `details JSONB,`

---

## 3. Reference Entity Pattern (OrgSettings -- simplest tenant-scoped entity)

```java
package io.b2mash.b2b.b2bstrawman.settings;

import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAware;
import io.b2mash.b2b.b2bstrawman.multitenancy.TenantAwareEntityListener;
import jakarta.persistence.*;
import java.time.Instant;
import java.util.UUID;
import org.hibernate.annotations.Filter;
import org.hibernate.annotations.FilterDef;
import org.hibernate.annotations.ParamDef;

@Entity
@Table(name = "org_settings")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class OrgSettings implements TenantAware {

  @Id @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "default_currency", nullable = false, length = 3)
  private String defaultCurrency;

  @Column(name = "tenant_id")
  private String tenantId;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  protected OrgSettings() {}

  public OrgSettings(String defaultCurrency) {
    this.defaultCurrency = defaultCurrency;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void updateCurrency(String currency) {
    this.defaultCurrency = currency;
    this.updatedAt = Instant.now();
  }

  // getters + TenantAware impl (getTenantId/setTenantId)
}
```

---

## 4. Reference ADR Template (ADR-051, truncated)

```markdown
# ADR-051: PSP Adapter Design

**Status**: Accepted

**Context**: Phase 10 introduces a "Record Payment" action on invoices. In v1,
no external PSP is integrated -- payment recording is a manual action by staff.
However, the architecture must establish a clean seam for future PSP integration.

Key constraints:
- No PSP SDKs or external service dependencies in this phase.
- The mock implementation must validate that the interface is usable.
- Provider selection must be configuration-driven, not code-change-driven.

**Options Considered**:

1. **Synchronous PaymentProvider interface with @ConditionalOnProperty** -- ...
   - Pros: [bullets]
   - Cons: [bullets]

2. **Event-driven payment abstraction** -- ...
   - Pros: [bullets]
   - Cons: [bullets]

3. **No abstraction -- inline mock logic** -- ...
   - Pros: [bullets]
   - Cons: [bullets]

**Decision**: Synchronous PaymentProvider interface (Option 1).

**Rationale**: The synchronous interface strikes the right balance between
proving the seam and avoiding premature complexity. [1-2 paragraphs]

**Consequences**:
- New PaymentProvider interface in invoice/ (or payment/ sub-package).
- PaymentRequest and PaymentResult records alongside the interface.
- MockPaymentProvider: always returns success with reference "MOCK-PAY-{UUID}".
```

---

## 5. Migration Pattern

Tenant: `backend/src/main/resources/db/migration/tenant/V{N}__{description}.sql`
Global: `backend/src/main/resources/db/migration/global/V{N}__{description}.sql`
Managed by Flyway via `FlywayConfig` + `TenantMigrationRunner` (not auto-configured).

Example (V19, rate/budget tables):
```sql
CREATE TABLE billing_rates (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    member_id       UUID          NOT NULL,
    project_id      UUID,
    customer_id     UUID,
    currency        VARCHAR(3)    NOT NULL,
    hourly_rate     NUMERIC(12,2) NOT NULL,
    effective_from  DATE          NOT NULL,
    effective_to    DATE,
    tenant_id       VARCHAR(100),
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
CREATE INDEX idx_billing_rates_member ON billing_rates(member_id);
```

---

## Quick Reference

| Item | Next Available |
|------|---------------|
| Architecture section | 11 |
| ADR number | 052 |
| Tenant migration | V23 |
| Global migration | V8 |
| Base package | `io.b2mash.b2b.b2bstrawman` |
| Entity interface | `TenantAware` (in `multitenancy/`) |
| Entity listener | `TenantAwareEntityListener` |
| Filter name | `tenantFilter` (all entities) |
| ID strategy | UUID (GenerationType.UUID) |
| JSONB Hibernate | `@JdbcTypeCode(SqlTypes.JSON)` + `columnDefinition = "jsonb"` |
| Type discrimination | String columns (not Java enums) |
