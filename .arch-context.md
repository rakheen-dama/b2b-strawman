# Architecture Context Inventory

Generated: 2026-02-19

---

## 1. ARCHITECTURE.md Section Headers

File: `architecture/ARCHITECTURE.md`

| Line | Section |
|------|---------|
| 3 | `## 1. Overview` |
| 50 | `## 2. Architecture Decision Records` |
| 409 | `## 3. Component Architecture` |
| 704 | `## 4. Sequence Diagrams` |
| 874 | `## 5. Data Flow Diagrams` |
| 980 | `## 6. Security Architecture` |
| 1083 | `## 7. Infrastructure Architecture` |
| 1236 | `## 8. Database Architecture` |
| 1344 | `## 9. Phase 2 — Billing & Tiered Tenancy` |
| 1874 | `## 10. Phase 4 — Customers, Document Scopes & Tasks` |
| 2446 | `## Appendix A: Clerk JWT Claims` |
| 2460 | `## Appendix B: Environment Variables Reference` |

- **Last numbered section**: 10 (Phase 4)
- **Next available section number**: 11
- Note: Phases 5+ have standalone architecture docs in `architecture/phase{N}-*.md`

---

## 2. ADR Numbering

Directory: `adr/`

Total ADR files: 62 (ADR-010 through ADR-071)
ADRs 001-009 are inline in `architecture/ARCHITECTURE.md`.

| Range | Phase/Topic |
|-------|-------------|
| 010-016 | Phase 2 (Billing & Tenancy) |
| 017-020 | Phase 4 (Customers, Document Scopes, Tasks) |
| 021-024 | Phase 5 (Task & Time Lifecycle) |
| 025-029 | Phase 6 (Audit & Compliance) |
| 030-033 | Phase 7 (Customer Portal) |
| 034-038 | Phase 6.5 (Notifications, Comments, Activity) |
| 039-043 | Phase 8 (Rate Cards, Budgets, Profitability) |
| 044-047 | Phase 9 (Dashboard) |
| 048-051 | Phase 10 (Invoicing) |
| 052-055 | Phase 11 (Custom Fields, Tags, Views) |
| 056-059 | Phase 12 (Document Templates) |
| 060-063 | Phase 14 (Customer Compliance & Lifecycle) |
| 064 | Phase 13 (Dedicated Schema Only) |
| 065-067 | Phase 15 (Setup Guidance & Detail Pages) |
| 068-071 | Phase 16 (Recurring Work) |

- **Highest ADR number**: 071 (Daily Batch Scheduler)
- **Next available ADR number**: 072

---

## 3. Migration Numbering

### Global Migrations (`db/migration/global/`)

| File | Description |
|------|-------------|
| V1 | create_org_schema_mapping |
| V2 | create_organizations |
| V3 | create_processed_webhooks |
| V4 | add_org_tier |
| V5 | drop_schema_name_unique |
| V6 | add_subscriptions |
| V7 | create_portal_schema |

- **Highest global migration**: V7
- **Next available global migration**: V8

### Tenant Migrations (`db/migration/tenant/`)

| File | Description |
|------|-------------|
| V1 | create_projects |
| V2 | create_documents |
| V3 | create_members |
| V4 | migrate_ownership_to_members |
| V5 | create_project_members |
| V6 | add_missing_fk_indexes |
| V7 | create_customers |
| V8 | create_customer_projects |
| V9 | create_tasks |
| V10 | extend_documents_scope |
| V11 | create_time_entries |
| V12 | create_audit_events |
| V13 | create_comments |
| V14 | create_notifications |
| V15 | create_notification_preferences |
| V16 | create_portal_contacts_and_magic_link_tokens |
| V17 | create_rate_budget_tables |
| V18 | add_time_entry_rate_snapshots |
| V19 | add_project_budget_version |
| V20 | add_dashboard_indexes |
| V21 | create_invoices |
| V22 | add_field_definitions_groups |
| V23 | add_tags |
| V24 | add_field_pack_status |
| V25 | add_custom_field_columns |
| V26 | add_saved_views |
| V27 | create_document_templates |
| V28 | add_branding_and_template_pack_status |
| V29 | customer_compliance_lifecycle |

- **Highest tenant migration**: V29
- **Next available tenant migration**: V30

---

## 4. Entity Inventory (38 @Entity classes)

All paths relative to `backend/src/main/java/io/b2mash/b2b/b2bstrawman/`

| Entity | Package | File |
|--------|---------|------|
| AuditEvent | audit | `audit/AuditEvent.java` |
| BillingRate | billingrate | `billingrate/BillingRate.java` |
| Subscription | billing | `billing/Subscription.java` |
| ProjectBudget | budget | `budget/ProjectBudget.java` |
| ChecklistTemplate | checklist | `checklist/ChecklistTemplate.java` |
| ChecklistInstance | checklist | `checklist/ChecklistInstance.java` |
| ChecklistInstanceItem | checklist | `checklist/ChecklistInstanceItem.java` |
| ChecklistTemplateItem | checklist | `checklist/ChecklistTemplateItem.java` |
| Comment | comment | `comment/Comment.java` |
| CostRate | costrate | `costrate/CostRate.java` |
| Customer | customer | `customer/Customer.java` |
| CustomerProject | customer | `customer/CustomerProject.java` |
| DataSubjectRequest | datarequest | `datarequest/DataSubjectRequest.java` |
| Document | document | `document/Document.java` |
| FieldDefinition | fielddefinition | `fielddefinition/FieldDefinition.java` |
| FieldGroup | fielddefinition | `fielddefinition/FieldGroup.java` |
| FieldGroupMember | fielddefinition | `fielddefinition/FieldGroupMember.java` |
| Invoice | invoice | `invoice/Invoice.java` |
| InvoiceLine | invoice | `invoice/InvoiceLine.java` |
| InvoiceCounter | invoice | `invoice/InvoiceCounter.java` |
| Member | member | `member/Member.java` |
| ProjectMember | member | `member/ProjectMember.java` |
| OrgSchemaMapping | multitenancy | `multitenancy/OrgSchemaMapping.java` |
| Notification | notification | `notification/Notification.java` |
| NotificationPreference | notification | `notification/NotificationPreference.java` |
| Organization | provisioning | `provisioning/Organization.java` |
| PortalContact | portal | `portal/PortalContact.java` |
| MagicLinkToken | portal | `portal/MagicLinkToken.java` |
| Project | project | `project/Project.java` |
| RetentionPolicy | retention | `retention/RetentionPolicy.java` |
| OrgSettings | settings | `settings/OrgSettings.java` |
| Tag | tag | `tag/Tag.java` |
| EntityTag | tag | `tag/EntityTag.java` |
| Task | task | `task/Task.java` |
| DocumentTemplate | template | `template/DocumentTemplate.java` |
| GeneratedDocument | template | `template/GeneratedDocument.java` |
| TimeEntry | timeentry | `timeentry/TimeEntry.java` |
| SavedView | view | `view/SavedView.java` |

---

## 5. Backend Package Structure

Base: `src/main/java/io/b2mash/b2b/b2bstrawman/`

```
activity/          # Activity feed (direct audit query)
audit/             # AuditEvent entity, repository, service, controller, builder
billing/           # Subscription entity, Clerk billing integration
billingrate/       # BillingRate entity (3-level hierarchy)
budget/            # ProjectBudget entity, service, controller
checklist/         # ChecklistTemplate, ChecklistInstance entities
comment/           # Comment entity, service, controller
compliance/        # Compliance pack seeding, FICA/POPI
config/            # Spring config beans (Security, Hibernate, S3, Flyway, etc.)
costrate/          # CostRate entity, service
customer/          # Customer, CustomerProject entities + service + controller
customerbackend/   # Customer portal backend APIs
dashboard/         # Dashboard aggregation, health scoring
datarequest/       # DataSubjectRequest (POPI/GDPR)
dev/               # Dev-only Thymeleaf portal harness
document/          # Document entity + S3 presigned URLs
event/             # Spring application events (domain events)
exception/         # Shared semantic exceptions (ResourceNotFoundException, etc.)
fielddefinition/   # FieldDefinition, FieldGroup entities (custom fields)
invoice/           # Invoice, InvoiceLine, InvoiceCounter entities + service
member/            # Member, ProjectMember entities + sync service
multitenancy/      # RequestScopes, connection provider, identifier resolver, filters
mywork/            # Cross-project "My Work" view
notification/      # Notification, NotificationPreference + channels + templates
portal/            # PortalContact, MagicLinkToken entities
project/           # Project entity + service + controller
provisioning/      # Organization entity, tenant provisioning
report/            # Profitability reports (project/customer/org/utilization)
retention/         # RetentionPolicy entity (data retention)
s3/                # S3 presigned URL service
security/          # JWT auth filter, API key filter, role converter
settings/          # OrgSettings entity (branding, currency, etc.)
setupstatus/       # Setup guidance status checks
tag/               # Tag, EntityTag (polymorphic join table)
task/              # Task entity + service + controller
template/          # DocumentTemplate, GeneratedDocument + rendering pipeline
timeentry/         # TimeEntry entity + service + controller
view/              # SavedView entity (saved filters)
```

---

## 6. Frontend Route Structure

Base: `frontend/app/(app)/org/[slug]/`

```
compliance/                          # Compliance overview
compliance/requests/                 # Data subject requests list
compliance/requests/[id]/            # Data subject request detail
customers/                           # Customer list
customers/[id]/                      # Customer detail
dashboard/                           # Dashboard (charts, health)
documents/                           # Document list
invoices/                            # Invoice list
invoices/[id]/                       # Invoice detail
my-work/                             # Cross-project "My Work"
notifications/                       # Notifications list
profitability/                       # Profitability reports
projects/                            # Project list
projects/[id]/                       # Project detail (tabs: overview, tasks, time, docs, budget, financials, activity)
settings/                            # General settings
settings/billing/                    # Billing/subscription settings
settings/checklists/                 # Checklist template management
settings/compliance/                 # Compliance settings (packs)
settings/custom-fields/              # Custom field management
settings/notifications/              # Notification preferences
settings/rates/                      # Rate card management
settings/tags/                       # Tag management
settings/templates/                  # Document template list
settings/templates/[id]/edit/        # Template editor
settings/templates/new/              # New template
team/                                # Team member management
```

---

## 7. Reference Entity Patterns

### Entity Pattern Summary

All tenant-scoped entities follow these conventions:
- `@Entity` + `@Table(name = "table_name")` — no multitenancy boilerplate needed (dedicated schema handles isolation)
- UUID primary key with `@GeneratedValue(strategy = GenerationType.UUID)`
- `protected` no-arg constructor (JPA requirement)
- Public constructor for creation with business defaults
- `Instant createdAt` / `Instant updatedAt` managed in constructors and mutators (no `@PrePersist`)
- Business methods on the entity for state transitions (rich domain model)
- Getters only (no setters except where mutation is a business operation)
- FK references stored as `UUID` columns (not `@ManyToOne` JPA relationships)
- Enums stored as `@Enumerated(EnumType.STRING)` with `length` constraint
- JSONB fields use `@JdbcTypeCode(SqlTypes.JSON)` + `columnDefinition = "jsonb"`

### Invoice (Full Source)

```java
package io.b2mash.b2b.b2bstrawman.invoice;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.math.BigDecimal;
import java.time.Instant;
import java.time.LocalDate;
import java.util.UUID;

@Entity
@Table(name = "invoices")
public class Invoice {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "customer_id", nullable = false)
  private UUID customerId;

  @Column(name = "invoice_number", length = 20)
  private String invoiceNumber;

  @Enumerated(EnumType.STRING)
  @Column(name = "status", nullable = false, length = 20)
  private InvoiceStatus status;

  @Column(name = "currency", nullable = false, length = 3)
  private String currency;

  @Column(name = "issue_date")
  private LocalDate issueDate;

  @Column(name = "due_date")
  private LocalDate dueDate;

  @Column(name = "subtotal", nullable = false, precision = 14, scale = 2)
  private BigDecimal subtotal;

  @Column(name = "tax_amount", nullable = false, precision = 14, scale = 2)
  private BigDecimal taxAmount;

  @Column(name = "total", nullable = false, precision = 14, scale = 2)
  private BigDecimal total;

  @Column(name = "notes", columnDefinition = "TEXT")
  private String notes;

  @Column(name = "payment_terms", length = 100)
  private String paymentTerms;

  @Column(name = "payment_reference", length = 255)
  private String paymentReference;

  @Column(name = "paid_at")
  private Instant paidAt;

  @Column(name = "customer_name", nullable = false, length = 255)
  private String customerName;

  @Column(name = "customer_email", length = 255)
  private String customerEmail;

  @Column(name = "customer_address", columnDefinition = "TEXT")
  private String customerAddress;

  @Column(name = "org_name", nullable = false, length = 255)
  private String orgName;

  @Column(name = "created_by", nullable = false)
  private UUID createdBy;

  @Column(name = "approved_by")
  private UUID approvedBy;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  protected Invoice() {}

  public Invoice(
      UUID customerId,
      String currency,
      String customerName,
      String customerEmail,
      String customerAddress,
      String orgName,
      UUID createdBy) {
    this.customerId = customerId;
    this.currency = currency;
    this.status = InvoiceStatus.DRAFT;
    this.subtotal = BigDecimal.ZERO;
    this.taxAmount = BigDecimal.ZERO;
    this.total = BigDecimal.ZERO;
    this.customerName = customerName;
    this.customerEmail = customerEmail;
    this.customerAddress = customerAddress;
    this.orgName = orgName;
    this.createdBy = createdBy;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void updateDraft(
      LocalDate dueDate, String notes, String paymentTerms, BigDecimal taxAmount) {
    if (this.status != InvoiceStatus.DRAFT) {
      throw new IllegalStateException("Only draft invoices can be edited");
    }
    this.dueDate = dueDate;
    this.notes = notes;
    this.paymentTerms = paymentTerms;
    this.taxAmount = taxAmount != null ? taxAmount : BigDecimal.ZERO;
    this.total = this.subtotal.add(this.taxAmount);
    this.updatedAt = Instant.now();
  }

  public void recalculateTotals(BigDecimal subtotal) {
    this.subtotal = subtotal;
    this.total = this.subtotal.add(this.taxAmount);
    this.updatedAt = Instant.now();
  }

  public void approve(String invoiceNumber, UUID approvedBy) {
    if (this.status != InvoiceStatus.DRAFT) {
      throw new IllegalStateException("Only draft invoices can be approved");
    }
    this.status = InvoiceStatus.APPROVED;
    this.invoiceNumber = invoiceNumber;
    this.approvedBy = approvedBy;
    if (this.issueDate == null) {
      this.issueDate = LocalDate.now();
    }
    this.updatedAt = Instant.now();
  }

  public void markSent() {
    if (this.status != InvoiceStatus.APPROVED) {
      throw new IllegalStateException("Only approved invoices can be sent");
    }
    this.status = InvoiceStatus.SENT;
    this.updatedAt = Instant.now();
  }

  public void recordPayment(String paymentReference) {
    if (this.status != InvoiceStatus.SENT) {
      throw new IllegalStateException("Only sent invoices can be paid");
    }
    this.status = InvoiceStatus.PAID;
    this.paidAt = Instant.now();
    this.paymentReference = paymentReference;
    this.updatedAt = Instant.now();
  }

  public void voidInvoice() {
    if (this.status != InvoiceStatus.APPROVED && this.status != InvoiceStatus.SENT) {
      throw new IllegalStateException("Only approved or sent invoices can be voided");
    }
    this.status = InvoiceStatus.VOID;
    this.updatedAt = Instant.now();
  }

  // Getters: getId(), getCustomerId(), getInvoiceNumber(), getStatus(), getCurrency(),
  //   getIssueDate(), getDueDate(), getSubtotal(), getTaxAmount(), getTotal(), getNotes(),
  //   getPaymentTerms(), getPaymentReference(), getPaidAt(), getCustomerName(),
  //   getCustomerEmail(), getCustomerAddress(), getOrgName(), getCreatedBy(),
  //   getApprovedBy(), getCreatedAt(), getUpdatedAt()
}
```

### InvoiceLine (Full Source)

```java
package io.b2mash.b2b.b2bstrawman.invoice;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.Instant;
import java.util.UUID;

@Entity
@Table(name = "invoice_lines")
public class InvoiceLine {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "invoice_id", nullable = false)
  private UUID invoiceId;

  @Column(name = "project_id")
  private UUID projectId;

  @Column(name = "time_entry_id")
  private UUID timeEntryId;

  @Column(name = "description", nullable = false, columnDefinition = "TEXT")
  private String description;

  @Column(name = "quantity", nullable = false, precision = 10, scale = 4)
  private BigDecimal quantity;

  @Column(name = "unit_price", nullable = false, precision = 12, scale = 2)
  private BigDecimal unitPrice;

  @Column(name = "amount", nullable = false, precision = 14, scale = 2)
  private BigDecimal amount;

  @Column(name = "sort_order", nullable = false)
  private int sortOrder;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  protected InvoiceLine() {}

  public InvoiceLine(
      UUID invoiceId,
      UUID projectId,
      UUID timeEntryId,
      String description,
      BigDecimal quantity,
      BigDecimal unitPrice,
      int sortOrder) {
    this.invoiceId = invoiceId;
    this.projectId = projectId;
    this.timeEntryId = timeEntryId;
    this.description = description;
    this.quantity = quantity;
    this.unitPrice = unitPrice;
    this.amount = quantity.multiply(unitPrice).setScale(2, RoundingMode.HALF_UP);
    this.sortOrder = sortOrder;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  public void recalculateAmount() {
    this.amount = this.quantity.multiply(this.unitPrice).setScale(2, RoundingMode.HALF_UP);
    this.updatedAt = Instant.now();
  }

  public void update(String description, BigDecimal quantity, BigDecimal unitPrice, int sortOrder) {
    this.description = description;
    this.quantity = quantity;
    this.unitPrice = unitPrice;
    this.sortOrder = sortOrder;
    recalculateAmount();
  }

  // Getters: getId(), getInvoiceId(), getProjectId(), getTimeEntryId(), getDescription(),
  //   getQuantity(), getUnitPrice(), getAmount(), getSortOrder(), getCreatedAt(), getUpdatedAt()
}
```

### Customer (Full Source)

```java
package io.b2mash.b2b.b2bstrawman.customer;

import io.b2mash.b2b.b2bstrawman.exception.InvalidStateException;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.time.Instant;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

@Entity
@Table(name = "customers")
public class Customer {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "name", nullable = false, length = 255)
  private String name;

  @Column(name = "email", nullable = false, length = 255)
  private String email;

  @Column(name = "phone", length = 50)
  private String phone;

  @Column(name = "id_number", length = 100)
  private String idNumber;

  @Column(name = "status", nullable = false, length = 20)
  private String status;

  @Column(name = "notes", columnDefinition = "TEXT")
  private String notes;

  @Column(name = "created_by", nullable = false)
  private UUID createdBy;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "custom_fields", columnDefinition = "jsonb")
  private Map<String, Object> customFields = new HashMap<>();

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "applied_field_groups", columnDefinition = "jsonb")
  private List<UUID> appliedFieldGroups;

  @Enumerated(EnumType.STRING)
  @Column(name = "customer_type", nullable = false, length = 20)
  private CustomerType customerType;

  @Enumerated(EnumType.STRING)
  @Column(name = "lifecycle_status", nullable = false, length = 20)
  private LifecycleStatus lifecycleStatus;

  @Column(name = "lifecycle_status_changed_at")
  private Instant lifecycleStatusChangedAt;

  @Column(name = "lifecycle_status_changed_by")
  private UUID lifecycleStatusChangedBy;

  @Column(name = "offboarded_at")
  private Instant offboardedAt;

  protected Customer() {}

  public Customer(
      String name, String email, String phone, String idNumber, String notes, UUID createdBy) {
    this.name = name;
    this.email = email;
    this.phone = phone;
    this.idNumber = idNumber;
    this.status = "ACTIVE";
    this.notes = notes;
    this.createdBy = createdBy;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
    this.customerType = CustomerType.INDIVIDUAL;
    this.lifecycleStatus = LifecycleStatus.ACTIVE;
  }

  public Customer(String name, String email, String phone, String idNumber,
      String notes, UUID createdBy, CustomerType customerType) {
    this(name, email, phone, idNumber, notes, createdBy);
    this.customerType = customerType != null ? customerType : CustomerType.INDIVIDUAL;
  }

  public Customer(String name, String email, String phone, String idNumber,
      String notes, UUID createdBy, CustomerType customerType, LifecycleStatus lifecycleStatus) {
    this(name, email, phone, idNumber, notes, createdBy, customerType);
    this.lifecycleStatus = lifecycleStatus != null ? lifecycleStatus : LifecycleStatus.ACTIVE;
  }

  public void update(String name, String email, String phone, String idNumber, String notes) {
    this.name = name;
    this.email = email;
    this.phone = phone;
    this.idNumber = idNumber;
    this.notes = notes;
    this.updatedAt = Instant.now();
  }

  public void archive() {
    this.status = "ARCHIVED";
    this.updatedAt = Instant.now();
  }

  public void transitionLifecycleStatus(LifecycleStatus targetStatus, UUID actorId) {
    if (!this.lifecycleStatus.canTransitionTo(targetStatus)) {
      throw new InvalidStateException(
          "Invalid lifecycle transition",
          "Cannot transition from " + this.lifecycleStatus + " to " + targetStatus);
    }
    this.lifecycleStatus = targetStatus;
    this.lifecycleStatusChangedAt = Instant.now();
    this.lifecycleStatusChangedBy = actorId;
    if (targetStatus == LifecycleStatus.OFFBOARDED) {
      this.offboardedAt = Instant.now();
    }
    this.updatedAt = Instant.now();
  }

  public void anonymize(String replacementName) {
    this.name = replacementName;
    this.email = "anon-" + this.id + "@anonymized.invalid";
    this.phone = null;
    this.idNumber = null;
    this.updatedAt = Instant.now();
  }

  // Getters + setCustomFields(), setAppliedFieldGroups(), setOffboardedAt()
}
```

### RecurringSchedule / ScheduleExecution

These entities do **not yet exist** in the codebase. They are referenced in ADR-070 (Pre-calculated Next Execution Date) and ADR-071 (Daily Batch Scheduler) as part of a planned Phase 16 (Recurring Work) implementation.

### TimeEntry (Key Fields)

```
Table: time_entries
Fields: id (UUID PK), taskId, memberId, date (LocalDate), durationMinutes (int),
  billable (boolean), billingRateSnapshot (BigDecimal 12,2), billingRateCurrency (3),
  costRateSnapshot (BigDecimal 12,2), costRateCurrency (3), invoiceId (UUID, nullable),
  description (TEXT), createdAt, updatedAt
Deprecated: rateCents (Integer) -- replaced by billingRateSnapshot
Methods: snapshotBillingRate(), snapshotCostRate(), getBillableValue() (computed), getCostValue() (computed)
```

### BillingRate (Key Fields)

```
Table: billing_rates
Fields: id (UUID PK), memberId, projectId (nullable), customerId (nullable),
  currency (3), hourlyRate (BigDecimal 12,2), effectiveFrom (LocalDate),
  effectiveTo (LocalDate, nullable), createdAt, updatedAt
Scope hierarchy: PROJECT_OVERRIDE > CUSTOMER_OVERRIDE > MEMBER_DEFAULT
  (determined by which nullable FK is set)
Methods: update(), getScope()
```

### InvoiceCounter (Key Fields)

```
Table: invoice_counters
Fields: id (UUID PK), nextNumber (int, default 1), singleton (boolean, default true)
Usage: Singleton per tenant schema. Used by InvoiceNumberService for sequential invoice numbers.
```

---

## 8. ADR Format Template

Based on ADR-071 (the most recent, highest-numbered ADR):

```markdown
# ADR-{NNN}: {Title}

**Status**: Accepted
**Date**: YYYY-MM-DD

**Context**:

{1-2 paragraphs explaining the problem, current state, and constraints.
Reference existing codebase patterns and infrastructure.}

**Options Considered**:

1. **{Option name} (chosen)** -- {Brief description.}
   - Pros: {semicolon-separated list}
   - Cons: {semicolon-separated list}

2. **{Option name}** -- {Brief description.}
   - Pros: {semicolon-separated list}
   - Cons: {semicolon-separated list}

3. **{Option name}** -- {Brief description.}
   - Pros: {semicolon-separated list}
   - Cons: {semicolon-separated list}

4. **{Option name}** -- {Brief description.}
   - Pros: {semicolon-separated list}
   - Cons: {semicolon-separated list}

**Decision**: Option N -- {chosen option name}.

**Rationale**:

{2-3 paragraphs explaining WHY this option was chosen.
Reference domain characteristics, scale considerations, and existing patterns.
Address the most significant con from the chosen option.}

**Consequences**:

- Positive:
  - {Bullet points}

- Negative:
  - {Bullet points with mitigations in parentheses}
```

---

## Quick Reference

| Resource | Current Max | Next Available |
|----------|-------------|----------------|
| ARCHITECTURE.md section | 10 | 11 |
| ADR number | 071 | 072 |
| Global migration | V7 | V8 |
| Tenant migration | V29 | V30 |
| Entity count | 38 | -- |
| Backend packages | 38 | -- |
| Frontend routes | 26 pages | -- |
