# Architecture Context Inventory — Phase 12 (Document Templates & PDF Generation)

Generated: 2026-02-15. Domain keywords: document template, PDF generation, OpenHTMLToPDF, org branding, template pack, generated document, Thymeleaf rendering.

---

## 1. Numbering

- **Next architecture section**: Phase docs are standalone files (each uses `## 11` or similar). Main `ARCHITECTURE.md` has `## 10` + Appendices.
- **Next ADR number**: ADR-056 (latest: `adr/ADR-055-saved-view-filter-execution.md`)
- **Next tenant migration**: V24 (latest: `V23__create_invoices.sql`). Note: Phase 11 plans V24 for custom fields -- coordinate if parallel.

---

## 2. Relevant Entities

### Directly relevant

| Entity | File | Relevance |
|--------|------|-----------|
| `Document` | `document/Document.java` | Generated PDFs stored as Documents (S3 key, scope, visibility) |
| `Invoice` | `invoice/Invoice.java` | Existing Thymeleaf rendering target; orgName, customer snapshot |
| `InvoiceLine` | `invoice/InvoiceLine.java` | Line items rendered in invoice template |
| `OrgSettings` | `settings/OrgSettings.java` | Branding fields to add (logo, colors, address) |
| `Customer` | `customer/Customer.java` | Template context data |
| `Project` | `project/Project.java` | Template context data |

### Referenced via relationships

| Entity | File | Referenced by |
|--------|------|---------------|
| `InvoiceCounter` | `invoice/InvoiceCounter.java` | Invoice numbering sequence |
| `TimeEntry` | `timeentry/TimeEntry.java` | InvoiceLine (via `time_entry_id`) |
| `Member` | `member/Member.java` | Invoice (`created_by`, `approved_by`) |

All paths relative to `backend/src/main/java/io/b2mash/b2b/b2bstrawman/`.

---

## 3. Reference Entity Pattern — `InvoiceLine`

Most recently created `@Entity` (Phase 10). Standard pattern: UUID PK, `@FilterDef`/`@Filter`, `TenantAware`, `TenantAwareEntityListener`, protected no-arg constructor, business constructor setting timestamps, domain methods.

```java
@Entity
@Table(name = "invoice_lines")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId")
@EntityListeners(TenantAwareEntityListener.class)
public class InvoiceLine implements TenantAware {

  @Id @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "invoice_id", nullable = false)
  private UUID invoiceId;

  @Column(name = "project_id")
  private UUID projectId;

  @Column(name = "description", nullable = false, columnDefinition = "TEXT")
  private String description;

  @Column(name = "quantity", nullable = false, precision = 10, scale = 4)
  private BigDecimal quantity;

  @Column(name = "unit_price", nullable = false, precision = 12, scale = 2)
  private BigDecimal unitPrice;

  @Column(name = "amount", nullable = false, precision = 14, scale = 2)
  private BigDecimal amount;

  @Column(name = "sort_order", nullable = false)
  private int sortOrder;

  @Column(name = "tenant_id")
  private String tenantId;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  protected InvoiceLine() {}

  public InvoiceLine(UUID invoiceId, UUID projectId, UUID timeEntryId,
      String description, BigDecimal quantity, BigDecimal unitPrice, int sortOrder) {
    // field assignment...
    this.amount = quantity.multiply(unitPrice).setScale(2, RoundingMode.HALF_UP);
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  // Domain methods: recalculateAmount(), update(...)
  // Getters + TenantAware impl
}
```

---

## 4. Reference ADR Template — ADR-055

```markdown
# ADR-055: Saved View Filter Execution

**Status**: Accepted

**Context**: [2-3 paragraphs: problem statement, key tensions, secondary questions]

**Options Considered**:

1. **Option name** — Description.
   - Pros: [bulleted list]
   - Cons: [bulleted list]

2. **Option name** — Description.
   - Pros / Cons same format.

3. **Option name** — Description.

**Decision**: [Chosen option (Option N)].

**Rationale**: [2-3 paragraphs explaining why chosen over alternatives]

**Consequences**:
- New components, packages, patterns introduced.
- What changes in the codebase.
- Future considerations.
```

---

## 5. Template Pack Pattern (Phase 11 FieldPackSeeder -- Designed, Not Yet Implemented)

This is the closest existing pattern for "template packs" in document template domain.

### Seeding mechanism (ADR-053)

- **JSON files**: `src/main/resources/field-packs/common-customer.json`, `common-project.json`
- **DTOs**: `FieldPackDefinition(packId, version, entityType, group, fields)` record
- **Service**: `FieldPackSeeder.seedPacksForTenant(String tenantId)` -- scans `classpath:field-packs/*.json`, deserializes, creates tenant-scoped records
- **Trigger**: Called during `POST /internal/orgs/provision`, after Flyway migrations
- **Idempotency**: Checks `OrgSettings.fieldPackStatus` JSONB array for already-applied packs
- **Tracking**: Each seeded record has `pack_id` + `pack_field_key` columns
- **Vertical forks**: Just add JSON files to `classpath:field-packs/`

### Pack JSON format

```json
{
  "packId": "common-customer",
  "version": 1,
  "entityType": "CUSTOMER",
  "group": { "slug": "contact-address", "name": "Contact & Address" },
  "fields": [
    { "slug": "address_line1", "name": "Address Line 1", "fieldType": "TEXT", "sortOrder": 1 },
    { "slug": "country", "name": "Country", "fieldType": "DROPDOWN",
      "options": [{"value":"US","label":"United States"}] }
  ]
}
```

---

## 6. Existing Thymeleaf Usage (Invoice Preview -- Phase 10)

### Dependency & config

`spring-boot-starter-thymeleaf` in `pom.xml`. Auto-configured by Spring Boot (no explicit `@Bean`). Default template location: `classpath:templates/`.

### Template files

| Template | Location |
|----------|----------|
| `invoice-preview.html` | `templates/invoice-preview.html` |
| Portal dashboard | `templates/portal/dashboard.html` |
| Portal project detail | `templates/portal/project-detail.html` |
| Portal magic link | `templates/portal/generate-link.html` |

### Rendering code (`InvoiceService.renderPreview`)

```java
import org.thymeleaf.ITemplateEngine;
import org.thymeleaf.context.Context;

// Constructor-injected: ITemplateEngine templateEngine

@Transactional(readOnly = true)
public String renderPreview(UUID invoiceId) {
    var invoice = invoiceRepository.findOneById(invoiceId).orElseThrow(...);
    var lines = lineRepository.findByInvoiceIdOrderBySortOrder(invoiceId);

    // Group lines by project name into LinkedHashMap
    var groupedLines = new LinkedHashMap<String, List<InvoiceLine>>();
    // ... grouping + subtotal computation ...

    Context ctx = new Context();
    ctx.setVariable("invoice", invoice);
    ctx.setVariable("groupedLines", groupedLines);
    ctx.setVariable("groupSubtotals", groupSubtotals);

    return templateEngine.process("invoice-preview", ctx);
}
```

### Template features used in `invoice-preview.html`

- `th:text`, `th:if`, `th:each`, `th:classappend` for dynamic content
- `${#numbers.formatDecimal(...)}` for number formatting
- Inline `<style>` CSS (no external stylesheets) -- designed for print/PDF
- `@media print` styles, A4-like layout (`max-width: 210mm`)
- Self-contained HTML document (important for OpenHTMLToPDF compatibility)

---

## 7. OrgSettings Entity -- Field List (Branding Extension Point)

**File**: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/settings/OrgSettings.java`

| Field | Type | Column | Notes |
|-------|------|--------|-------|
| `id` | `UUID` | PK, auto-generated | |
| `defaultCurrency` | `String(3)` | `default_currency` | ISO currency code |
| `tenantId` | `String` | `tenant_id` | TenantAware |
| `createdAt` | `Instant` | `created_at` | Immutable |
| `updatedAt` | `Instant` | `updated_at` | Updated on mutation |

**Phase 11 planned addition**: `fieldPackStatus` (JSONB) -- tracks applied field packs.

**Branding extension candidates**: `logoS3Key`, `brandColor`, `companyName`, `companyAddress`, `companyPhone`, `companyEmail`, `companyWebsite`, `taxId`.

---

## 8. Document Entity -- Field List (Generated Document Linking)

**File**: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/document/Document.java`

| Field | Type | Column | Notes |
|-------|------|--------|-------|
| `id` | `UUID` | PK | |
| `projectId` | `UUID` | `project_id` | Nullable (org/customer-scoped docs) |
| `fileName` | `String(500)` | `file_name` | |
| `contentType` | `String(100)` | `content_type` | MIME type (e.g., `application/pdf`) |
| `size` | `long` | `size` | Bytes |
| `s3Key` | `String(1000)` | `s3_key` | S3 object key |
| `status` | `Status` enum | `status` | PENDING, UPLOADED, FAILED |
| `uploadedBy` | `UUID` | `uploaded_by` | Member ID |
| `uploadedAt` | `Instant` | `uploaded_at` | |
| `scope` | `String(20)` | `scope` | PROJECT, ORG, CUSTOMER |
| `customerId` | `UUID` | `customer_id` | Nullable |
| `visibility` | `String(20)` | `visibility` | INTERNAL, SHARED |
| `tenantId` | `String` | `tenant_id` | TenantAware |
| `createdAt` | `Instant` | `created_at` | Immutable |

**Inner constants**: `Scope` (PROJECT/ORG/CUSTOMER), `Visibility` (INTERNAL/SHARED), `Status` (PENDING/UPLOADED/FAILED)

**Extension options**: Add `source` field (e.g., `"GENERATED"` vs `"UPLOADED"`) and `sourceEntityId` (UUID of invoice/template that produced it). Or create a separate `GeneratedDocument` entity referencing `Document`.

---

## Quick Reference

| Item | Value |
|------|-------|
| Next ADR | ADR-056 |
| Next tenant migration | V24 (coordinate with Phase 11) |
| Base package | `io.b2mash.b2b.b2bstrawman` |
| Entity interface | `TenantAware` (in `multitenancy/`) |
| Entity listener | `TenantAwareEntityListener` |
| Filter name | `tenantFilter` (all entities) |
| ID strategy | UUID (`GenerationType.UUID`) |
| JSONB Hibernate | `@JdbcTypeCode(SqlTypes.JSON)` + `columnDefinition = "jsonb"` |
| Thymeleaf engine | `ITemplateEngine` (Spring auto-configured) |
| Template location | `classpath:templates/` |
| S3 upload pattern | Document entity with `s3Key`, browser uploads via presigned URL |
| Type discrimination | String columns (not Java `@Enumerated`, except Invoice/InvoiceLine which use `@Enumerated(EnumType.STRING)`) |
