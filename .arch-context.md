# Architecture Context Inventory

Generated: 2026-02-22

---

## 1. ARCHITECTURE.md Section Headers

Grepped from `architecture/ARCHITECTURE.md` (2400+ lines, NOT read in full):

```
Line 3:    ## 1. Overview
Line 50:   ## 2. Architecture Decision Records
Line 409:  ## 3. Component Architecture
Line 704:  ## 4. Sequence Diagrams
Line 874:  ## 5. Data Flow Diagrams
Line 980:  ## 6. Security Architecture
Line 1083: ## 7. Infrastructure Architecture
Line 1236: ## 8. Database Architecture
Line 1344: ## 9. Phase 2 — Billing & Tiered Tenancy
Line 1874: ## 10. Phase 4 — Customers, Document Scopes & Tasks
Line 2446: ## Appendix A: Clerk JWT Claims
Line 2460: ## Appendix B: Environment Variables Reference
```

**Last numbered section**: `## 10. Phase 4 — Customers, Document Scopes & Tasks`
**Next available section number**: `11`

Note: Phase 5 onward use standalone files in `architecture/` rather than sections in ARCHITECTURE.md.

---

## 2. ADR Numbering

All files in `adr/` directory (note: filenames have a leading non-breaking space prefix in the filesystem):

Highest ADR: **ADR-087** (`ADR-087-e2e-seed-strategy.md`)

**Next available ADR number**: `088`

Complete list:
- ADR-010: billing-integration
- ADR-011: tiered-tenancy
- ADR-012: row-level-isolation
- ADR-013: plan-state-propagation
- ADR-014: plan-enforcement
- ADR-015: provisioning-per-tier
- ADR-016: tier-upgrade-migration
- ADR-017: customer-as-org-child
- ADR-018: document-scope-model
- ADR-019: task-claim-workflow
- ADR-020: customer-portal-approach
- ADR-021: time-tracking-model
- ADR-022: time-aggregation-strategy
- ADR-023: my-work-cross-project-query
- ADR-024: portal-task-time-seams
- ADR-025: audit-storage-location
- ADR-026: audit-event-granularity
- ADR-027: audit-retention-strategy
- ADR-028: audit-integrity-approach
- ADR-029: audit-logging-abstraction
- ADR-030: magic-link-auth-for-customers
- ADR-031: separate-portal-read-model-schema
- ADR-032: spring-application-events-for-portal
- ADR-033: local-only-thymeleaf-test-harness
- ADR-034: flat-comments-with-threading-schema
- ADR-035: activity-feed-direct-audit-query
- ADR-036: synchronous-notification-fanout
- ADR-037: comment-visibility-model
- ADR-038: polling-for-notification-delivery
- ADR-039: rate-resolution-hierarchy
- ADR-040: point-in-time-rate-snapshotting
- ADR-041: multi-currency-store-in-original
- ADR-042: single-budget-per-project
- ADR-043: margin-aware-profitability
- ADR-044: dashboard-aggregation-caching
- ADR-045: project-health-scoring
- ADR-046: dashboard-charting-approach
- ADR-047: dashboard-layout-strategy
- ADR-048: invoice-numbering-strategy
- ADR-049: line-item-granularity
- ADR-050: double-billing-prevention
- ADR-051: psp-adapter-design
- ADR-052: jsonb-vs-eav-custom-field-storage
- ADR-053: field-pack-seeding-strategy
- ADR-054: tag-storage-join-table-vs-array
- ADR-055: saved-view-filter-execution
- ADR-056: pdf-engine-selection
- ADR-057: template-storage
- ADR-058: rendering-context-assembly
- ADR-059: template-customization-model
- ADR-060: lifecycle-status-core-field
- ADR-061: checklist-first-class-entities
- ADR-062: anonymization-over-hard-deletion
- ADR-063: compliance-packs-bundled-seed-data
- ADR-064: dedicated-schema-only
- ADR-065: hardcoded-setup-checks
- ADR-066: computed-status-over-persisted
- ADR-067: entity-detail-page-action-surface
- ADR-068: snapshot-based-templates
- ADR-069: role-based-assignment-hints
- ADR-070: pre-calculated-next-execution-date
- ADR-071: daily-batch-scheduler
- ADR-072: admin-triggered-period-close
- ADR-073: standard-billing-rate-for-overage
- ADR-074: query-based-consumption
- ADR-075: one-active-retainer-per-customer
- ADR-076: separate-portal-app
- ADR-077: portal-jwt-storage
- ADR-078: portal-read-model-extension
- ADR-079: portal-org-identification
- ADR-080: task-detail-sheet-panel
- ADR-081: report-query-strategy-pattern
- ADR-082: report-template-storage
- ADR-083: csv-generation-approach
- ADR-084: parameter-schema-design
- ADR-085: auth-provider-abstraction
- ADR-086: mock-idp-strategy
- ADR-087: e2e-seed-strategy

---

## 3. Migration Numbering

### Global Migrations (`db/migration/global/`)

```
V1__create_org_schema_mapping.sql
V2__create_organizations.sql
V3__create_processed_webhooks.sql
V4__add_org_tier.sql
V5__drop_schema_name_unique.sql
V6__add_subscriptions.sql
V7__create_portal_schema.sql
```

**Highest global migration**: V7

### Tenant Migrations (`db/migration/tenant/`)

```
V1__create_projects.sql
V2__create_documents.sql
V3__create_members.sql
V4__migrate_ownership_to_members.sql
V5__create_project_members.sql
V6__add_missing_fk_indexes.sql
V7__create_customers.sql
V8__create_customer_projects.sql
V9__create_tasks.sql
V10__extend_documents_scope.sql
V11__create_time_entries.sql
V12__create_audit_events.sql
V13__create_comments.sql
V14__create_notifications.sql
V15__create_notification_preferences.sql
V16__create_portal_contacts_and_magic_link_tokens.sql
V17__create_rate_budget_tables.sql
V18__add_time_entry_rate_snapshots.sql
V19__add_project_budget_version.sql
V20__add_dashboard_indexes.sql
V21__create_invoices.sql
V22__add_field_definitions_groups.sql
V23__add_tags.sql
V24__add_field_pack_status.sql
V25__add_custom_field_columns.sql
V26__add_saved_views.sql
V27__create_document_templates.sql
V28__add_branding_and_template_pack_status.sql
V29__customer_compliance_lifecycle.sql
V30__project_templates_recurring_schedules.sql
V31__create_retainer_tables.sql
V32__rename_external_to_shared_visibility.sql
V33__create_task_items.sql
V34__create_template_task_items.sql
V35__create_report_definitions.sql
```

**Highest tenant migration**: V35

**Next available tenant migration**: V36

---

## 4. Entity Inventory

All `@Entity` classes in `backend/src/main/java/io/b2mash/b2b/b2bstrawman/`:

| Class | Package | File |
|-------|---------|------|
| `AuditEvent` | audit | `audit/AuditEvent.java` |
| `Subscription` | billing | `billing/Subscription.java` |
| `BillingRate` | billingrate | `billingrate/BillingRate.java` |
| `ProjectBudget` | budget | `budget/ProjectBudget.java` |
| `ChecklistInstance` | checklist | `checklist/ChecklistInstance.java` |
| `ChecklistInstanceItem` | checklist | `checklist/ChecklistInstanceItem.java` |
| `ChecklistTemplate` | checklist | `checklist/ChecklistTemplate.java` |
| `ChecklistTemplateItem` | checklist | `checklist/ChecklistTemplateItem.java` |
| `Comment` | comment | `comment/Comment.java` |
| `CostRate` | costrate | `costrate/CostRate.java` |
| `Customer` | customer | `customer/Customer.java` |
| `CustomerProject` | customer | `customer/CustomerProject.java` |
| `DataSubjectRequest` | datarequest | `datarequest/DataSubjectRequest.java` |
| `Document` | document | `document/Document.java` |
| `FieldDefinition` | fielddefinition | `fielddefinition/FieldDefinition.java` |
| `FieldGroup` | fielddefinition | `fielddefinition/FieldGroup.java` |
| `FieldGroupMember` | fielddefinition | `fielddefinition/FieldGroupMember.java` |
| `Invoice` | invoice | `invoice/Invoice.java` |
| `InvoiceCounter` | invoice | `invoice/InvoiceCounter.java` |
| `InvoiceLine` | invoice | `invoice/InvoiceLine.java` |
| `Member` | member | `member/Member.java` |
| `ProjectMember` | member | `member/ProjectMember.java` |
| `OrgSchemaMapping` | multitenancy | `multitenancy/OrgSchemaMapping.java` |
| `Notification` | notification | `notification/Notification.java` |
| `NotificationPreference` | notification | `notification/NotificationPreference.java` |
| `MagicLinkToken` | portal | `portal/MagicLinkToken.java` |
| `PortalContact` | portal | `portal/PortalContact.java` |
| `Project` | project | `project/Project.java` |
| `ProjectTemplate` | projecttemplate | `projecttemplate/ProjectTemplate.java` |
| `TemplateTask` | projecttemplate | `projecttemplate/TemplateTask.java` |
| `TemplateTaskItem` | projecttemplate | `projecttemplate/TemplateTaskItem.java` |
| `Organization` | provisioning | `provisioning/Organization.java` |
| `ReportDefinition` | reporting | `reporting/ReportDefinition.java` |
| `RetainerAgreement` | retainer | `retainer/RetainerAgreement.java` |
| `RetainerPeriod` | retainer | `retainer/RetainerPeriod.java` |
| `RetentionPolicy` | retention | `retention/RetentionPolicy.java` |
| `RecurringSchedule` | schedule | `schedule/RecurringSchedule.java` |
| `ScheduleExecution` | schedule | `schedule/ScheduleExecution.java` |
| `OrgSettings` | settings | `settings/OrgSettings.java` |
| `EntityTag` | tag | `tag/EntityTag.java` |
| `Tag` | tag | `tag/Tag.java` |
| `Task` | task | `task/Task.java` |
| `TaskItem` | task | `task/TaskItem.java` |
| `DocumentTemplate` | template | `template/DocumentTemplate.java` |
| `GeneratedDocument` | template | `template/GeneratedDocument.java` |
| `TimeEntry` | timeentry | `timeentry/TimeEntry.java` |
| `SavedView` | view | `view/SavedView.java` |

**Total**: 47 entities

---

## 5. Backend Package Structure

All packages under `src/main/java/io/b2mash/b2b/b2bstrawman/`:

```
activity/
audit/
billing/
billingrate/
budget/
checklist/
comment/
compliance/
config/
costrate/
customer/
customerbackend/
dashboard/
datarequest/
dev/
document/
event/
exception/
fielddefinition/
invoice/
member/
multitenancy/
mywork/
notification/
portal/
project/
projecttemplate/
provisioning/
report/
reporting/
retainer/
retention/
s3/
schedule/
security/
settings/
setupstatus/
tag/
task/
template/
timeentry/
view/
BackendApplication.java
```

---

## 6. Frontend Route Structure

All directories under `frontend/app/(app)/org/[slug]/`:

```
compliance/
compliance/requests/
compliance/requests/[id]/
customers/
customers/[id]/
dashboard/
documents/
invoices/
invoices/[id]/
my-work/
notifications/
profitability/
projects/
projects/[id]/
reports/
reports/[reportSlug]/
retainers/
retainers/[id]/
schedules/
schedules/[id]/
settings/
settings/billing/
settings/checklists/
settings/checklists/[id]/
settings/checklists/[id]/edit/
settings/checklists/new/
settings/compliance/
settings/custom-fields/
settings/notifications/
settings/project-templates/
settings/project-templates/[id]/
settings/rates/
settings/tags/
settings/templates/
settings/templates/[id]/
settings/templates/[id]/edit/
settings/templates/new/
team/
```

---

## 7. Existing Integration-Related Patterns

### 7a. PaymentProvider Interface (port pattern)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/invoice/PaymentProvider.java`

```java
package io.b2mash.b2b.b2bstrawman.invoice;

public interface PaymentProvider {
  PaymentResult recordPayment(PaymentRequest request);
}
```

Note: Minimal port — single method. `PaymentResult` and `PaymentRequest` are in the same package. No `channelId()` or `isEnabled()` — simpler than NotificationChannel.

---

### 7b. NotificationChannel Interface (port pattern)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/notification/channel/NotificationChannel.java`

```java
package io.b2mash.b2b.b2bstrawman.notification.channel;

import io.b2mash.b2b.b2bstrawman.notification.Notification;

/**
 * Abstraction for notification delivery channels. Each channel handles one delivery mechanism
 * (in-app, email, push, etc.).
 */
public interface NotificationChannel {

  /** Unique identifier for this channel (e.g., "in-app", "email"). */
  String channelId();

  /**
   * Delivers a notification via this channel.
   *
   * @param notification the notification to deliver
   * @param recipientEmail the recipient's email address (for email channels)
   */
  void deliver(Notification notification, String recipientEmail);

  /** Whether this channel is currently enabled/available. */
  boolean isEnabled();
}
```

Note: Richer port — has `channelId()` for self-identification and `isEnabled()` for feature-flag gating. This is the preferred pattern for pluggable integrations.

---

### 7c. S3PresignedUrlService (current S3 usage — presign only)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/s3/S3PresignedUrlService.java`

```java
package io.b2mash.b2b.b2bstrawman.s3;

import io.b2mash.b2b.b2bstrawman.config.S3Config.S3Properties;
import java.time.Duration;
import java.util.regex.Pattern;
import org.springframework.stereotype.Service;
import software.amazon.awssdk.services.s3.model.GetObjectRequest;
import software.amazon.awssdk.services.s3.model.PutObjectRequest;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;
import software.amazon.awssdk.services.s3.presigner.model.GetObjectPresignRequest;
import software.amazon.awssdk.services.s3.presigner.model.PutObjectPresignRequest;

@Service
public class S3PresignedUrlService {

  private static final Duration URL_EXPIRY = Duration.ofHours(1);
  // Validates: org/{orgId}/(project/{projectId}|org-docs|customer/{customerId}|branding|generated|exports)/{id}
  private static final Pattern S3_KEY_PATTERN =
      Pattern.compile(
          "^org/[^/]+/(project/[^/]+|org-docs|customer/[^/]+|branding|generated|exports)/[^/]+$");

  private final S3Presigner presigner;
  private final String bucketName;

  public S3PresignedUrlService(S3Presigner presigner, S3Properties s3Properties) { ... }

  // Presign PUT for project-scoped docs: org/{orgId}/project/{projectId}/{docId}
  public PresignedUploadResult generateUploadUrl(
      String orgId, String projectId, String documentId, String contentType) { ... }

  // Presign PUT for org-scoped docs: org/{orgId}/org-docs/{docId}
  public PresignedUploadResult generateOrgUploadUrl(
      String orgId, String documentId, String contentType) { ... }

  // Presign PUT for customer-scoped docs: org/{orgId}/customer/{customerId}/{docId}
  public PresignedUploadResult generateCustomerUploadUrl(
      String orgId, String customerId, String documentId, String contentType) { ... }

  // Presign GET — validates key against S3_KEY_PATTERN before generating URL
  public PresignedDownloadResult generateDownloadUrl(String s3Key) { ... }

  // Key builders (package-private static)
  static String buildKey(String orgId, String projectId, String documentId) { ... }
  static String buildOrgKey(String orgId, String documentId) { ... }
  static String buildCustomerKey(String orgId, String customerId, String documentId) { ... }

  public record PresignedUploadResult(String url, String s3Key, long expiresInSeconds) {}
  public record PresignedDownloadResult(String url, long expiresInSeconds) {}
}
```

**S3 key structure** (all paths): `org/{tenantId}/{scope}/...`
- project docs: `org/{tenantId}/project/{projectId}/{docId}`
- org docs: `org/{tenantId}/org-docs/{docId}`
- customer docs: `org/{tenantId}/customer/{customerId}/{docId}`
- branding (logo): `org/{tenantId}/branding/logo.{ext}`
- generated PDFs: `org/{tenantId}/generated/{fileName}`
- data exports: `org/{tenantId}/exports/{requestId}.zip`

---

### 7d. OrgSettings Entity (will be extended with feature flags)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/settings/OrgSettings.java`

```java
@Entity
@Table(name = "org_settings")
public class OrgSettings {

  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "default_currency", nullable = false, length = 3)
  private String defaultCurrency;

  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "field_pack_status", columnDefinition = "jsonb")
  private List<Map<String, Object>> fieldPackStatus;

  @Column(name = "logo_s3_key", length = 500)
  private String logoS3Key;

  @Column(name = "brand_color", length = 7)
  private String brandColor;

  @Column(name = "document_footer_text", columnDefinition = "TEXT")
  private String documentFooterText;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "template_pack_status", columnDefinition = "jsonb")
  private List<Map<String, Object>> templatePackStatus;

  @Column(name = "dormancy_threshold_days")
  private Integer dormancyThresholdDays;

  @Column(name = "data_request_deadline_days")
  private Integer dataRequestDeadlineDays;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "compliance_pack_status", columnDefinition = "jsonb")
  private List<Map<String, Object>> compliancePackStatus;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(name = "report_pack_status", columnDefinition = "jsonb")
  private List<Map<String, Object>> reportPackStatus;

  protected OrgSettings() {}

  public OrgSettings(String defaultCurrency) {
    this.defaultCurrency = defaultCurrency;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  // Domain methods: updateCurrency(), recordPackApplication(), recordTemplatePackApplication(),
  //   recordCompliancePackApplication(), recordReportPackApplication()
  // All mutation methods update updatedAt = Instant.now()
  // Getters and setters for all fields
}
```

**Pattern for pack status**: JSONB `List<Map<String, Object>>` with keys `packId`, `version`, `appliedAt`.
New feature-flag boolean columns should use a simple `@Column(name = "...", nullable = false)` boolean field with a default value in the migration.

---

### 7e. OrgSettingsService (uses S3 directly — refactoring target)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/settings/OrgSettingsService.java`

**S3 usage**: Injects both `S3Client` (for direct PUT/DELETE) and `S3PresignedUrlService` (for presigned GET).

Key methods and their S3 involvement:
- `getSettings()` — read-only, no S3
- `getSettingsWithBranding()` — read-only, calls `generateLogoUrl()` which calls `s3PresignedUrlService.generateDownloadUrl()`
- `updateSettingsWithBranding(...)` — no S3
- `uploadLogo(MultipartFile, memberId, orgRole)` — **direct S3 PUT** via `s3Client.putObject()`; rolls back orphaned S3 object on DB failure using `s3Client.deleteObject()`
- `deleteLogo(memberId, orgRole)` — **direct S3 DELETE** via `s3Client.deleteObject()`
- `getDefaultCurrency()` — read-only, no S3
- `updateComplianceSettings(...)` — no S3

**Constructor dependencies**: `OrgSettingsRepository`, `AuditService`, `S3Client`, `S3PresignedUrlService`, `S3Properties`

---

### 7f. GeneratedDocumentService (uses S3 directly — refactoring target)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/template/GeneratedDocumentService.java`

**S3 usage**: Injects `S3Client` and `S3Properties` for direct PUT.

Key method: `generateDocument(templateId, entityId, saveToDocuments, memberId)`
1. Renders PDF via `PdfRenderingService`
2. **Direct S3 PUT**: private helper `uploadToS3(s3Key, pdfBytes)` calls `s3Client.putObject(PutObjectRequest, RequestBody.fromBytes(pdfBytes))`
3. S3 key pattern: `org/{tenantId}/generated/{fileName}`
4. Creates `GeneratedDocument` record, optionally links `Document`
5. Publishes `DocumentGeneratedEvent` and logs audit event

Other methods: `listByEntity()`, `getById()`, `delete()` — no S3 involvement.

**Constructor dependencies**: `GeneratedDocumentRepository`, `DocumentTemplateRepository`, `MemberRepository`, `PdfRenderingService`, `DocumentTemplateService`, `S3Client`, `S3Properties`, `DocumentRepository`, `AuditService`, `ApplicationEventPublisher`

---

### 7g. DataExportService (uses S3 directly — refactoring target)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/datarequest/DataExportService.java`

**S3 usage**: Injects `S3Client` and `S3Properties` for direct PUT.

Key method: `generateExport(requestId, actorId)`
1. Collects customer data (customer, projects, documents, invoices, time entries, comments)
2. Serializes to JSON + generates summary CSV, creates ZIP
3. **Direct S3 PUT**: `s3Client.putObject(putRequest, RequestBody.fromBytes(zipBytes))`
4. S3 key pattern: `org/{tenantId}/exports/{requestId}.zip`
5. Updates `DataSubjectRequest.exportFileKey` with the S3 key; logs audit event

**Constructor dependencies**: `DataSubjectRequestRepository`, `CustomerRepository`, `CustomerProjectRepository`, `DocumentRepository`, `InvoiceRepository`, `TimeEntryRepository`, `CommentRepository`, `S3Client`, `S3Properties`, `ObjectMapper`, `AuditService`

---

### 7h. DataAnonymizationService (uses S3 directly — refactoring target)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/datarequest/DataAnonymizationService.java`

**S3 usage**: Injects `S3Client` and `S3Properties` for best-effort DELETE.

Key method: `executeAnonymization(requestId, confirmCustomerName, actorId)`
1. Anonymizes customer PII, redacts portal-visible comments
2. **Best-effort S3 DELETE**: `s3Client.deleteObject(...)` for each customer-scoped document; failures logged as WARN and do NOT rethrow
3. Anonymizes portal contacts, transitions lifecycle to OFFBOARDED, completes request; logs audit event

**Constructor dependencies**: `DataSubjectRequestRepository`, `CustomerRepository`, `DocumentRepository`, `CommentRepository`, `PortalContactRepository`, `InvoiceRepository`, `CustomerLifecycleService`, `S3Client`, `S3Properties`, `AuditService`

---

### 7i. RetentionService (uses S3 directly — refactoring target)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/retention/RetentionService.java`

**S3 usage**: Injects `S3Client` and `S3Properties` for best-effort DELETE.

Key methods:
- `runCheck()` — queries expired records by policy; no S3, only flags IDs
- `executePurge(recordType, recordIds)` — handles CUSTOMER, AUDIT_EVENT, COMMENT, DOCUMENT types
  - For DOCUMENT type: **best-effort S3 DELETE** before DB delete — same try/catch/warn pattern as DataAnonymizationService
  - Key path read from `doc.getS3Key()`

**Constructor dependencies**: `RetentionPolicyRepository`, `CustomerRepository`, `AuditEventRepository`, `DocumentRepository`, `CommentRepository`, `AuditService`, `S3Client`, `S3Properties`

---

### 7j. S3Config — S3Client and S3Presigner bean setup

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/config/S3Config.java`

```java
@Configuration
@EnableConfigurationProperties({S3Config.S3Properties.class, S3Config.AwsCredentialsProperties.class})
public class S3Config {

  @ConfigurationProperties("aws.s3")
  public record S3Properties(String endpoint, String region, String bucketName) {}

  @ConfigurationProperties("aws.credentials")
  public record AwsCredentialsProperties(String accessKeyId, String secretAccessKey) {}

  @Bean(destroyMethod = "close")
  S3Client s3Client(S3Properties s3Props, AwsCredentialsProperties credProps) {
    // If endpoint non-blank (LocalStack): pathStyleAccess=true + StaticCredentialsProvider
    // If endpoint blank (real AWS): DefaultCredentialsProvider
  }

  @Bean(destroyMethod = "close")
  S3Presigner s3Presigner(S3Properties s3Props, AwsCredentialsProperties credProps) {
    // Same dual-mode logic as s3Client
  }
}
```

**Config properties**:
- `aws.s3.endpoint` — LocalStack endpoint (e.g., `http://b2mash.local:4566`); blank for real AWS
- `aws.s3.region` — e.g., `us-east-1`
- `aws.s3.bucketName` — bucket name
- `aws.credentials.accessKeyId` / `aws.credentials.secretAccessKey` — used only when endpoint is set (LocalStack mode)

---

## 8. Recent ADR Format Template

Source: `adr/ ADR-087-e2e-seed-strategy.md` (most recently numbered ADR)

```markdown
# ADR-087: E2E Seed Data Strategy

**Status**: Proposed

**Context**:
[1-3 paragraphs explaining the problem, constraints, and context]

**Options Considered**:

1. **Option Name (chosen)** — description
   - Pros: ...
   - Cons: ...

2. **Option Name** — description
   - Pros: ...
   - Cons: ...

**Decision**: Option N — [chosen option name]

**Rationale**:
[Paragraph explaining why the chosen option was selected over alternatives]

**Consequences**:

- Positive:
  - ...

- Negative:
  - ...

- Neutral:
  - ...
```

---

## 9. Recent Entity Format — DocumentTemplate (Phase 12 Reference)

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/template/DocumentTemplate.java`

```java
package io.b2mash.b2b.b2bstrawman.template;

import io.b2mash.b2b.b2bstrawman.exception.InvalidStateException;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import java.time.Instant;
import java.util.UUID;
import java.util.regex.Pattern;

@Entity
@Table(name = "document_templates")
public class DocumentTemplate {

  // No @Filter, no tenant_id — schema boundary handles isolation automatically
  @Id
  @GeneratedValue(strategy = GenerationType.UUID)
  private UUID id;

  @Column(name = "name", nullable = false, length = 200)
  private String name;

  @Column(name = "slug", nullable = false, length = 200)
  private String slug;

  @Column(name = "description", columnDefinition = "TEXT")
  private String description;

  // Enums stored as STRING with explicit length constraints
  @Enumerated(EnumType.STRING)
  @Column(name = "category", nullable = false, length = 30)
  private TemplateCategory category;

  @Enumerated(EnumType.STRING)
  @Column(name = "primary_entity_type", nullable = false, length = 20)
  private TemplateEntityType primaryEntityType;

  @Column(name = "content", nullable = false, columnDefinition = "TEXT")
  private String content;

  @Column(name = "css", columnDefinition = "TEXT")
  private String css;

  @Enumerated(EnumType.STRING)
  @Column(name = "source", nullable = false, length = 20)
  private TemplateSource source;

  // Cross-entity FK stored as UUID only (no @ManyToOne — avoids lazy loading issues)
  @Column(name = "source_template_id")
  private UUID sourceTemplateId;

  @Column(name = "pack_id", length = 100)
  private String packId;

  @Column(name = "pack_template_key", length = 100)
  private String packTemplateKey;

  @Column(name = "active", nullable = false)
  private boolean active;

  @Column(name = "sort_order", nullable = false)
  private int sortOrder;

  // Timestamps: createdAt has updatable = false
  @Column(name = "created_at", nullable = false, updatable = false)
  private Instant createdAt;

  @Column(name = "updated_at", nullable = false)
  private Instant updatedAt;

  // JPA-required: protected (not public) no-arg constructor
  protected DocumentTemplate() {}

  // Public constructor takes only required fields; sets sensible defaults
  public DocumentTemplate(
      TemplateEntityType primaryEntityType,
      String name,
      String slug,
      TemplateCategory category,
      String content) {
    this.primaryEntityType = primaryEntityType;
    this.name = name;
    this.slug = slug;
    this.category = category;
    this.content = content;
    this.source = TemplateSource.ORG_CUSTOM;
    this.active = true;
    this.sortOrder = 0;
    this.createdAt = Instant.now();
    this.updatedAt = Instant.now();
  }

  // Static utility / factory methods allowed
  public static String generateSlug(String name) { ... }

  // Domain mutation methods (not bare setters) — always update updatedAt
  public void updateContent(String name, String description, String content, String css) {
    this.name = name;
    this.description = description;
    this.content = content;
    this.css = css;
    this.updatedAt = Instant.now();
  }

  public void deactivate() {
    this.active = false;
    this.updatedAt = Instant.now();
  }

  // Getters for all fields
  // Setters ONLY for optional mutable fields (not id, not createdAt, not required fields)
}
```

**Key patterns enforced in this codebase**:
1. No multitenancy boilerplate (`@Filter`, `@FilterDef`, `tenant_id`) — schema boundary handles isolation
2. `protected DocumentTemplate()` no-arg constructor for JPA, never public
3. Public constructor only takes required fields; optional fields default in constructor
4. `createdAt` has `updatable = false`; all domain mutations update `updatedAt = Instant.now()`
5. Cross-entity FKs stored as `UUID` (not `@ManyToOne`) — avoids lazy loading, keeps code simple
6. Enums stored as `STRING` with explicit `length` constraints matching the Java enum name lengths
7. No Lombok — Java 25 records and pattern matching cover all cases

---

## 10. AuditService Method Signatures

File: `backend/src/main/java/io/b2mash/b2b/b2bstrawman/audit/AuditService.java`

```java
package io.b2mash.b2b.b2bstrawman.audit;

import java.util.List;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

/**
 * Service interface for recording and querying audit events.
 * Implementations are tenant-scoped — queries return only events in the current tenant's schema.
 */
public interface AuditService {

  /**
   * Records a single audit event within the current transaction.
   * If the enclosing transaction rolls back, the audit event is also rolled back (no REQUIRES_NEW).
   */
  void log(AuditEventRecord record);

  /**
   * Queries audit events matching the given filter, scoped to the current tenant schema.
   * All filter fields are optional — null means "no filter on this field".
   * Returns page ordered by occurredAt DESC.
   */
  Page<AuditEvent> findEvents(AuditEventFilter filter, Pageable pageable);

  /**
   * Counts audit events grouped by event type for the current tenant schema.
   * Returns list ordered by count descending.
   */
  List<AuditEventRepository.EventTypeCount> countEventsByType();
}
```

**Usage pattern** (consistent across all services):

```java
auditService.log(
    AuditEventBuilder.builder()
        .eventType("domain.action")          // dot-separated: entity_type.verb
        .entityType("entity_name")           // snake_case
        .entityId(entity.getId())            // UUID
        .details(Map.of("key", "value"))     // arbitrary key-value map; use Map.of()
        .build());
```

Examples of event type naming conventions seen in codebase:
- `"org_settings.updated"`, `"org_settings.logo_uploaded"`, `"org_settings.logo_deleted"`
- `"document.generated"`
- `"data.export.generated"`, `"data.deletion.executed"`
- `"retention.check.executed"`, `"retention.purge.executed"`
