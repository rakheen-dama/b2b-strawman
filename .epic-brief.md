# Epic 68B — Project + Customer Rate Overrides Tabs

## Scope

Add project-level and customer-level billing rate override UIs. This involves:
1. A `ProjectRatesTab` component added to the project detail page
2. An `AddProjectRateDialog` for creating project-scoped billing rate overrides
3. A `CustomerRatesTab` component added to the customer detail page
4. Server actions for project and customer rate CRUD
5. Modifications to `ProjectTabs` and `CustomerTabs` to add "Rates" tab
6. Tests for both project and customer rate UIs

**NOT in scope**: Cost rates (only billing rate overrides are project/customer-scoped), settings page changes (68A), any backend changes.

---

## Tasks (Full Descriptions)

### 68.8 — Create ProjectRatesTab component
`frontend/components/rates/project-rates-tab.tsx` — "use client". Table of project-level billing rate overrides. Columns: Member, Hourly Rate, Currency, Effective From-To, Actions (edit/delete). "Add Override" button opens AddProjectRateDialog. Fetches rates via GET /api/billing-rates?projectId=X (data passed as props from server component). Pattern: follow `frontend/components/projects/project-members-panel.tsx` tab pattern.

### 68.9 — Create AddProjectRateDialog component
`frontend/components/rates/add-project-rate-dialog.tsx` — "use client". Select member from project members, enter hourly rate, currency, date range. Scope pre-set to PROJECT_OVERRIDE with projectId. On submit calls server action. Shows existing resolved rate for context ("Current rate: $200/hr from member default"). Pattern: follow AddRateDialog from 68A (with projectId scope).

### 68.10 — Integrate project rates tab into project detail page
Modify `frontend/app/(app)/org/[slug]/projects/[id]/page.tsx` — add "Rates" tab to project tabs (visible to project leads + admin/owner). Add server action for project rate overrides in `frontend/app/(app)/org/[slug]/projects/[id]/rate-actions.ts`. Fetch project billing rates in the page's server component. Pattern: follow existing tab pattern in project-tabs.tsx.

### 68.11 — Create CustomerRatesTab component
`frontend/components/rates/customer-rates-tab.tsx` — "use client". Table of customer-level billing rate overrides. Same structure as ProjectRatesTab but scoped to customerId. Fetches rates via GET /api/billing-rates?customerId=X. "Add Override" button. Pattern: follow ProjectRatesTab from 68.8.

### 68.12 — Integrate customer rates tab into customer detail page
Modify `frontend/app/(app)/org/[slug]/customers/[id]/page.tsx` — add "Rates" tab. Add `frontend/app/(app)/org/[slug]/customers/[id]/rate-actions.ts` for customer rate server actions. Visible to admin/owner only. Pattern: follow project rates integration from 68.10.

### 68.13 — Add project/customer rate UI tests
`frontend/__tests__/project-rates.test.tsx` (~4 tests): renders project rate overrides table, add override dialog, edit/delete actions. `frontend/__tests__/customer-rates.test.tsx` (~4 tests): renders customer rates table, add/edit customer override. Pattern: follow `frontend/__tests__/rates-settings.test.tsx`.

---

## File Plan

### New Files
| File | Purpose |
|------|---------|
| `frontend/components/rates/project-rates-tab.tsx` | Project rate overrides table component |
| `frontend/components/rates/add-project-rate-dialog.tsx` | Dialog for adding project-scoped billing rate |
| `frontend/components/rates/customer-rates-tab.tsx` | Customer rate overrides table component |
| `frontend/app/(app)/org/[slug]/projects/[id]/rate-actions.ts` | Server actions for project rate CRUD |
| `frontend/app/(app)/org/[slug]/customers/[id]/rate-actions.ts` | Server actions for customer rate CRUD |
| `frontend/__tests__/project-rates.test.tsx` | Project rates UI tests |
| `frontend/__tests__/customer-rates.test.tsx` | Customer rates UI tests |

### Modified Files
| File | Change |
|------|--------|
| `frontend/components/projects/project-tabs.tsx` | Add "Rates" tab definition + ratesPanel prop |
| `frontend/components/customers/customer-tabs.tsx` | Add "Rates" tab definition + ratesPanel prop |
| `frontend/app/(app)/org/[slug]/projects/[id]/page.tsx` | Fetch billing rates, pass ProjectRatesTab as ratesPanel |
| `frontend/app/(app)/org/[slug]/customers/[id]/page.tsx` | Fetch billing rates, pass CustomerRatesTab as ratesPanel |

---

## Reference Patterns (FULL SOURCE)

### 1. Types (`frontend/lib/types.ts` — relevant sections)

```typescript
export interface Project {
  id: string;
  name: string;
  description: string | null;
  createdBy: string;
  createdAt: string;
  updatedAt: string;
  projectRole: ProjectRole | null;
}

export interface OrgMember {
  id: string;
  name: string;
  email: string;
  avatarUrl: string | null;
  orgRole: string;
}

export type ProjectRole = "lead" | "member";

export interface ProjectMember {
  id: string;
  memberId: string;
  name: string;
  email: string;
  avatarUrl: string | null;
  projectRole: ProjectRole;
  createdAt: string;
}

export type CustomerStatus = "ACTIVE" | "ARCHIVED";

export interface Customer {
  id: string;
  name: string;
  email: string;
  phone: string | null;
  idNumber: string | null;
  status: CustomerStatus;
  notes: string | null;
  createdBy: string;
  createdAt: string;
  updatedAt: string;
}

export type BillingRateScope =
  | "MEMBER_DEFAULT"
  | "PROJECT_OVERRIDE"
  | "CUSTOMER_OVERRIDE";

export interface BillingRate {
  id: string;
  memberId: string;
  memberName: string;
  projectId: string | null;
  projectName: string | null;
  customerId: string | null;
  customerName: string | null;
  scope: BillingRateScope;
  currency: string;
  hourlyRate: number;
  effectiveFrom: string;
  effectiveTo: string | null;
  createdAt: string;
  updatedAt: string;
}

export interface CreateBillingRateRequest {
  memberId: string;
  projectId?: string;
  customerId?: string;
  currency: string;
  hourlyRate: number;
  effectiveFrom: string;
  effectiveTo?: string;
}

export interface UpdateBillingRateRequest {
  currency: string;
  hourlyRate: number;
  effectiveFrom: string;
  effectiveTo?: string;
}

export interface ResolvedRate {
  hourlyRate: number;
  currency: string;
  source: string;
  billingRateId: string;
}

export interface CostRate {
  id: string;
  memberId: string;
  memberName: string;
  currency: string;
  hourlyCost: number;
  effectiveFrom: string;
  effectiveTo: string | null;
  createdAt: string;
  updatedAt: string;
}

export interface OrgSettings {
  defaultCurrency: string;
}
```

### 2. API Client (`frontend/lib/api.ts`)

```typescript
import "server-only";

import { auth } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import { notFound } from "next/navigation";
import type { ProblemDetail } from "@/lib/types";

const BACKEND_URL = process.env.BACKEND_URL || "http://localhost:8080";

export class ApiError extends Error {
  constructor(
    public status: number,
    message: string,
    public detail?: ProblemDetail
  ) {
    super(message);
    this.name = "ApiError";
  }
}

interface ApiRequestOptions {
  method?: "GET" | "POST" | "PUT" | "DELETE" | "PATCH";
  body?: unknown;
  cache?: RequestCache;
  next?: NextFetchRequestConfig;
  headers?: Record<string, string>;
}

async function apiRequest<T>(endpoint: string, options: ApiRequestOptions = {}): Promise<T> {
  const { getToken } = await auth();
  const token = await getToken();

  if (!token) {
    redirect("/sign-in");
  }

  const response = await fetch(`${BACKEND_URL}${endpoint}`, {
    method: options.method || "GET",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
      ...options.headers,
    },
    body: options.body ? JSON.stringify(options.body) : undefined,
    cache: options.cache,
    next: options.next,
  });

  if (!response.ok) {
    let detail: ProblemDetail | undefined;
    let message = response.statusText;

    try {
      const contentType = response.headers.get("content-type");
      if (
        contentType?.includes("application/json") ||
        contentType?.includes("application/problem+json")
      ) {
        detail = await response.json();
        message = detail?.detail || detail?.title || message;
      } else {
        message = (await response.text()) || message;
      }
    } catch {
      // Failed to parse error body — use statusText
    }

    throw new ApiError(response.status, message, detail);
  }

  const contentLength = response.headers.get("content-length");
  if (response.status === 204 || contentLength === "0") {
    return undefined as T;
  }

  const text = await response.text();
  if (!text) {
    return undefined as T;
  }

  return JSON.parse(text) as T;
}

export function handleApiError(error: unknown): never {
  if (error instanceof ApiError) {
    if (error.status === 401) {
      redirect("/sign-in");
    }
    if (error.status === 404) {
      notFound();
    }
  }
  throw error;
}

export const api = {
  get: <T>(endpoint: string, options?: Omit<ApiRequestOptions, "method" | "body">) =>
    apiRequest<T>(endpoint, { ...options, method: "GET" }),

  post: <T>(
    endpoint: string,
    body?: unknown,
    options?: Omit<ApiRequestOptions, "method" | "body">
  ) => apiRequest<T>(endpoint, { ...options, method: "POST", body }),

  put: <T>(
    endpoint: string,
    body?: unknown,
    options?: Omit<ApiRequestOptions, "method" | "body">
  ) => apiRequest<T>(endpoint, { ...options, method: "PUT", body }),

  patch: <T>(
    endpoint: string,
    body?: unknown,
    options?: Omit<ApiRequestOptions, "method" | "body">
  ) => apiRequest<T>(endpoint, { ...options, method: "PATCH", body }),

  delete: <T>(endpoint: string, options?: Omit<ApiRequestOptions, "method" | "body">) =>
    apiRequest<T>(endpoint, { ...options, method: "DELETE" }),
};
```

### 3. Existing Settings Rates Actions (`frontend/app/(app)/org/[slug]/settings/rates/actions.ts`)

The project/customer rate actions should follow this EXACT pattern but with different revalidatePath targets.

```typescript
"use server";

import { api, ApiError } from "@/lib/api";
import { revalidatePath } from "next/cache";
import type {
  OrgSettings,
  UpdateOrgSettingsRequest,
  BillingRate,
  CreateBillingRateRequest,
  UpdateBillingRateRequest,
  CostRate,
  CreateCostRateRequest,
  UpdateCostRateRequest,
} from "@/lib/types";

interface ActionResult {
  success: boolean;
  error?: string;
}

export async function updateDefaultCurrency(
  slug: string,
  currency: string,
): Promise<ActionResult> {
  const body: UpdateOrgSettingsRequest = { defaultCurrency: currency };

  try {
    await api.put<OrgSettings>("/api/settings", body);
  } catch (error) {
    if (error instanceof ApiError) {
      if (error.status === 403) {
        return {
          success: false,
          error: "Only admins and owners can update currency settings.",
        };
      }
      return { success: false, error: error.message };
    }
    return { success: false, error: "An unexpected error occurred." };
  }

  revalidatePath(`/org/${slug}/settings/rates`);
  return { success: true };
}

export async function createBillingRate(
  slug: string,
  data: CreateBillingRateRequest,
): Promise<ActionResult> {
  try {
    await api.post<BillingRate>("/api/billing-rates", data);
  } catch (error) {
    if (error instanceof ApiError) {
      if (error.status === 403) {
        return {
          success: false,
          error: "You do not have permission to create billing rates.",
        };
      }
      if (error.status === 409) {
        return {
          success: false,
          error:
            "A billing rate already exists for this period. Please adjust the dates to avoid overlap.",
        };
      }
      return { success: false, error: error.message };
    }
    return { success: false, error: "An unexpected error occurred." };
  }

  revalidatePath(`/org/${slug}/settings/rates`);
  return { success: true };
}

export async function updateBillingRate(
  slug: string,
  id: string,
  data: UpdateBillingRateRequest,
): Promise<ActionResult> {
  try {
    await api.put<BillingRate>(`/api/billing-rates/${id}`, data);
  } catch (error) {
    if (error instanceof ApiError) {
      if (error.status === 403) {
        return {
          success: false,
          error: "You do not have permission to update billing rates.",
        };
      }
      if (error.status === 409) {
        return {
          success: false,
          error:
            "A billing rate already exists for this period. Please adjust the dates to avoid overlap.",
        };
      }
      return { success: false, error: error.message };
    }
    return { success: false, error: "An unexpected error occurred." };
  }

  revalidatePath(`/org/${slug}/settings/rates`);
  return { success: true };
}

export async function deleteBillingRate(
  slug: string,
  id: string,
): Promise<ActionResult> {
  try {
    await api.delete(`/api/billing-rates/${id}`);
  } catch (error) {
    if (error instanceof ApiError) {
      if (error.status === 403) {
        return {
          success: false,
          error: "You do not have permission to delete billing rates.",
        };
      }
      return { success: false, error: error.message };
    }
    return { success: false, error: "An unexpected error occurred." };
  }

  revalidatePath(`/org/${slug}/settings/rates`);
  return { success: true };
}

export async function createCostRate(
  slug: string,
  data: CreateCostRateRequest,
): Promise<ActionResult> {
  try {
    await api.post<CostRate>("/api/cost-rates", data);
  } catch (error) {
    if (error instanceof ApiError) {
      if (error.status === 403) {
        return {
          success: false,
          error: "You do not have permission to create cost rates.",
        };
      }
      if (error.status === 409) {
        return {
          success: false,
          error:
            "A cost rate already exists for this period. Please adjust the dates to avoid overlap.",
        };
      }
      return { success: false, error: error.message };
    }
    return { success: false, error: "An unexpected error occurred." };
  }

  revalidatePath(`/org/${slug}/settings/rates`);
  return { success: true };
}

export async function updateCostRate(
  slug: string,
  id: string,
  data: UpdateCostRateRequest,
): Promise<ActionResult> {
  try {
    await api.put<CostRate>(`/api/cost-rates/${id}`, data);
  } catch (error) {
    if (error instanceof ApiError) {
      if (error.status === 403) {
        return {
          success: false,
          error: "You do not have permission to update cost rates.",
        };
      }
      if (error.status === 409) {
        return {
          success: false,
          error:
            "A cost rate already exists for this period. Please adjust the dates to avoid overlap.",
        };
      }
      return { success: false, error: error.message };
    }
    return { success: false, error: "An unexpected error occurred." };
  }

  revalidatePath(`/org/${slug}/settings/rates`);
  return { success: true };
}

export async function deleteCostRate(
  slug: string,
  id: string,
): Promise<ActionResult> {
  try {
    await api.delete(`/api/cost-rates/${id}`);
  } catch (error) {
    if (error instanceof ApiError) {
      if (error.status === 403) {
        return {
          success: false,
          error: "You do not have permission to delete cost rates.",
        };
      }
      return { success: false, error: error.message };
    }
    return { success: false, error: "An unexpected error occurred." };
  }

  revalidatePath(`/org/${slug}/settings/rates`);
  return { success: true };
}
```

### 4. Existing ProjectTabs (`frontend/components/projects/project-tabs.tsx`)

```typescript
"use client";

import { useState, type ReactNode } from "react";
import { Tabs as TabsPrimitive } from "radix-ui";
import { motion } from "motion/react";
import { cn } from "@/lib/utils";

interface ProjectTabsProps {
  documentsPanel: ReactNode;
  membersPanel: ReactNode;
  customersPanel: ReactNode;
  tasksPanel: ReactNode;
  timePanel: ReactNode;
  activityPanel: ReactNode;
}

const tabs = [
  { id: "documents", label: "Documents" },
  { id: "members", label: "Members" },
  { id: "customers", label: "Customers" },
  { id: "tasks", label: "Tasks" },
  { id: "time", label: "Time" },
  { id: "activity", label: "Activity" },
] as const;

type TabId = (typeof tabs)[number]["id"];

export function ProjectTabs({ documentsPanel, membersPanel, customersPanel, tasksPanel, timePanel, activityPanel }: ProjectTabsProps) {
  const [activeTab, setActiveTab] = useState<TabId>("documents");

  return (
    <TabsPrimitive.Root value={activeTab} onValueChange={(v) => setActiveTab(v as TabId)}>
      {/* Radix List provides role="tablist" + arrow-key navigation + roving focus */}
      <TabsPrimitive.List className="relative flex gap-6 border-b border-olive-200 dark:border-olive-800">
        {tabs.map((tab) => (
          <TabsPrimitive.Trigger
            key={tab.id}
            value={tab.id}
            className={cn(
              "relative pb-3 text-sm font-medium transition-colors outline-none",
              "text-olive-600 hover:text-olive-900 dark:text-olive-400 dark:hover:text-olive-200",
              "data-[state=active]:text-olive-950 dark:data-[state=active]:text-olive-50",
              "focus-visible:outline-2 focus-visible:outline-indigo-500 focus-visible:outline-offset-2"
            )}
          >
            {tab.label}
            {activeTab === tab.id && (
              <motion.span
                className="absolute inset-x-0 bottom-0 h-0.5 bg-indigo-500"
                layoutId="project-tab-indicator"
                transition={{ type: "spring", stiffness: 300, damping: 25 }}
                aria-hidden="true"
              />
            )}
          </TabsPrimitive.Trigger>
        ))}
      </TabsPrimitive.List>

      {/* Radix Content provides role="tabpanel" + aria-labelledby */}
      <TabsPrimitive.Content value="documents" className="pt-6 outline-none">
        {documentsPanel}
      </TabsPrimitive.Content>
      <TabsPrimitive.Content value="members" className="pt-6 outline-none">
        {membersPanel}
      </TabsPrimitive.Content>
      <TabsPrimitive.Content value="customers" className="pt-6 outline-none">
        {customersPanel}
      </TabsPrimitive.Content>
      <TabsPrimitive.Content value="tasks" className="pt-6 outline-none">
        {tasksPanel}
      </TabsPrimitive.Content>
      <TabsPrimitive.Content value="time" className="pt-6 outline-none">
        {timePanel}
      </TabsPrimitive.Content>
      <TabsPrimitive.Content value="activity" className="pt-6 outline-none">
        {activityPanel}
      </TabsPrimitive.Content>
    </TabsPrimitive.Root>
  );
}
```

### 5. Existing CustomerTabs (`frontend/components/customers/customer-tabs.tsx`)

```typescript
"use client";

import { useState, type ReactNode } from "react";
import { Tabs as TabsPrimitive } from "radix-ui";
import { motion } from "motion/react";
import { cn } from "@/lib/utils";

interface CustomerTabsProps {
  projectsPanel: ReactNode;
  documentsPanel: ReactNode;
}

const tabs = [
  { id: "projects", label: "Projects" },
  { id: "documents", label: "Documents" },
] as const;

type TabId = (typeof tabs)[number]["id"];

export function CustomerTabs({ projectsPanel, documentsPanel }: CustomerTabsProps) {
  const [activeTab, setActiveTab] = useState<TabId>("projects");

  return (
    <TabsPrimitive.Root value={activeTab} onValueChange={(v) => setActiveTab(v as TabId)}>
      <TabsPrimitive.List className="relative flex gap-6 border-b border-olive-200 dark:border-olive-800">
        {tabs.map((tab) => (
          <TabsPrimitive.Trigger
            key={tab.id}
            value={tab.id}
            className={cn(
              "relative pb-3 text-sm font-medium transition-colors outline-none",
              "text-olive-600 hover:text-olive-900 dark:text-olive-400 dark:hover:text-olive-200",
              "data-[state=active]:text-olive-950 dark:data-[state=active]:text-olive-50",
              "focus-visible:outline-2 focus-visible:outline-indigo-500 focus-visible:outline-offset-2"
            )}
          >
            {tab.label}
            {activeTab === tab.id && (
              <motion.span
                className="absolute inset-x-0 bottom-0 h-0.5 bg-indigo-500"
                layoutId="customer-tab-indicator"
                transition={{ type: "spring", stiffness: 300, damping: 25 }}
                aria-hidden="true"
              />
            )}
          </TabsPrimitive.Trigger>
        ))}
      </TabsPrimitive.List>

      <TabsPrimitive.Content value="projects" className="pt-6 outline-none">
        {projectsPanel}
      </TabsPrimitive.Content>
      <TabsPrimitive.Content value="documents" className="pt-6 outline-none">
        {documentsPanel}
      </TabsPrimitive.Content>
    </TabsPrimitive.Root>
  );
}
```

### 6. Existing Project Detail Page (`frontend/app/(app)/org/[slug]/projects/[id]/page.tsx`)

```typescript
import { auth, currentUser } from "@clerk/nextjs/server";
import { api, handleApiError } from "@/lib/api";
import type { OrgMember, Project, Customer, Document, ProjectMember, ProjectRole, Task, ProjectTimeSummary, MemberTimeSummary, TaskTimeSummary } from "@/lib/types";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { EditProjectDialog } from "@/components/projects/edit-project-dialog";
import { DeleteProjectDialog } from "@/components/projects/delete-project-dialog";
import { DocumentsPanel } from "@/components/documents/documents-panel";
import { ProjectMembersPanel } from "@/components/projects/project-members-panel";
import { TaskListPanel } from "@/components/tasks/task-list-panel";
import { TimeSummaryPanel } from "@/components/projects/time-summary-panel";
import { ActivityFeed } from "@/components/activity/activity-feed";
import { ProjectCustomersPanel } from "@/components/projects/project-customers-panel";
import { ProjectTabs } from "@/components/projects/project-tabs";
import { formatDate } from "@/lib/format";
import { ArrowLeft, Pencil, Trash2 } from "lucide-react";
import Link from "next/link";

const ROLE_BADGE: Record<ProjectRole, { label: string; variant: "lead" | "member" }> = {
  lead: { label: "Lead", variant: "lead" },
  member: { label: "Member", variant: "member" },
};

export default async function ProjectDetailPage({
  params,
}: {
  params: Promise<{ slug: string; id: string }>;
}) {
  const { slug, id } = await params;
  const { orgRole, userId } = await auth();

  const isAdmin = orgRole === "org:admin" || orgRole === "org:owner";
  const isOwner = orgRole === "org:owner";

  let project: Project;
  try {
    project = await api.get<Project>(`/api/projects/${id}`);
  } catch (error) {
    handleApiError(error);
  }

  const canEdit = isAdmin || project.projectRole === "lead";
  const isCurrentLead = project.projectRole === "lead";
  const canManage = isAdmin || isCurrentLead;

  let documents: Document[] = [];
  try {
    documents = await api.get<Document[]>(`/api/projects/${id}/documents`);
  } catch {
    // Non-fatal: show empty documents list if fetch fails
  }

  let members: ProjectMember[] = [];
  try {
    members = await api.get<ProjectMember[]>(`/api/projects/${id}/members`);
  } catch {
    // Non-fatal: show empty members list if fetch fails
  }

  let tasks: Task[] = [];
  try {
    tasks = await api.get<Task[]>(`/api/projects/${id}/tasks`);
  } catch {
    // Non-fatal: show empty tasks list if fetch fails
  }

  let customers: Customer[] = [];
  try {
    customers = await api.get<Customer[]>(`/api/projects/${id}/customers`);
  } catch {
    // Non-fatal: show empty customers list if fetch fails
  }

  // Time summary data for the "Time" tab
  let timeSummary: ProjectTimeSummary = {
    billableMinutes: 0,
    nonBillableMinutes: 0,
    totalMinutes: 0,
    contributorCount: 0,
    entryCount: 0,
  };
  let timeSummaryByTask: TaskTimeSummary[] = [];
  let timeSummaryByMember: MemberTimeSummary[] | null = null;
  try {
    const [summaryRes, byTaskRes, byMemberRes] = await Promise.all([
      api.get<ProjectTimeSummary>(`/api/projects/${id}/time-summary`),
      api.get<TaskTimeSummary[]>(`/api/projects/${id}/time-summary/by-task`),
      api
        .get<MemberTimeSummary[]>(`/api/projects/${id}/time-summary/by-member`)
        .catch(() => null),
    ]);
    timeSummary = summaryRes;
    timeSummaryByTask = byTaskRes;
    timeSummaryByMember = byMemberRes;
  } catch {
    // Non-fatal: show empty time summary if fetch fails
  }

  // Resolve current user's backend member ID for "My Tasks" filter and claim/release actions.
  let currentMemberId: string | null = null;
  try {
    const [user, orgMembers] = await Promise.all([
      currentUser(),
      api.get<OrgMember[]>("/api/members"),
    ]);
    const email = user?.primaryEmailAddress?.emailAddress;
    if (email) {
      const match = orgMembers.find((m) => m.email === email);
      if (match) currentMemberId = match.id;
    }
  } catch {
    // Non-fatal
  }

  const roleBadge = project.projectRole ? ROLE_BADGE[project.projectRole] : null;

  return (
    <div className="space-y-8">
      {/* Back link */}
      <div>
        <Link
          href={`/org/${slug}/projects`}
          className="inline-flex items-center text-sm text-olive-600 transition-colors hover:text-olive-900 dark:text-olive-400 dark:hover:text-olive-100"
        >
          <ArrowLeft className="mr-1.5 size-4" />
          Back to Projects
        </Link>
      </div>

      {/* Project Header */}
      <div className="flex items-start justify-between gap-4">
        <div className="min-w-0">
          <div className="flex items-center gap-3">
            <h1 className="font-display text-2xl text-olive-950 dark:text-olive-50">
              {project.name}
            </h1>
            {roleBadge && <Badge variant={roleBadge.variant}>{roleBadge.label}</Badge>}
          </div>
          {project.description ? (
            <p className="mt-2 text-olive-600 dark:text-olive-400">{project.description}</p>
          ) : (
            <p className="mt-2 text-sm italic text-olive-400 dark:text-olive-600">
              No description
            </p>
          )}
          <p className="mt-3 text-sm text-olive-400 dark:text-olive-600">
            Created {formatDate(project.createdAt)} &middot; {documents.length}{" "}
            {documents.length === 1 ? "document" : "documents"} &middot; {members.length}{" "}
            {members.length === 1 ? "member" : "members"} &middot; {tasks.length}{" "}
            {tasks.length === 1 ? "task" : "tasks"}
          </p>
        </div>

        {(canEdit || isOwner) && (
          <div className="flex shrink-0 gap-2">
            {canEdit && (
              <EditProjectDialog project={project} slug={slug}>
                <Button variant="outline" size="sm">
                  <Pencil className="mr-1.5 size-4" />
                  Edit
                </Button>
              </EditProjectDialog>
            )}
            {isOwner && (
              <DeleteProjectDialog slug={slug} projectId={project.id} projectName={project.name}>
                <Button variant="ghost" size="sm" className="text-red-600 hover:bg-red-50 hover:text-red-700 dark:text-red-400 dark:hover:bg-red-950 dark:hover:text-red-300">
                  <Trash2 className="mr-1.5 size-4" />
                  Delete
                </Button>
              </DeleteProjectDialog>
            )}
          </div>
        )}
      </div>

      {/* Tabbed Content */}
      <ProjectTabs
        documentsPanel={
          <DocumentsPanel
            documents={documents}
            projectId={id}
            slug={slug}
            currentMemberId={currentMemberId}
            canManageVisibility={canManage}
          />
        }
        customersPanel={
          <ProjectCustomersPanel
            customers={customers}
            slug={slug}
            projectId={id}
            canManage={canManage}
          />
        }
        membersPanel={
          <ProjectMembersPanel
            members={members}
            slug={slug}
            projectId={id}
            canManage={canManage}
            isCurrentLead={isCurrentLead}
            currentUserId={userId ?? ""}
          />
        }
        tasksPanel={
          <TaskListPanel
            tasks={tasks}
            slug={slug}
            projectId={id}
            canManage={canManage}
            currentMemberId={currentMemberId}
            orgRole={orgRole}
          />
        }
        timePanel={
          <TimeSummaryPanel
            projectId={id}
            initialSummary={timeSummary}
            initialByTask={timeSummaryByTask}
            initialByMember={timeSummaryByMember}
          />
        }
        activityPanel={
          <ActivityFeed projectId={id} orgSlug={slug} />
        }
      />
    </div>
  );
}
```

### 7. Existing Customer Detail Page (`frontend/app/(app)/org/[slug]/customers/[id]/page.tsx`)

```typescript
import { auth } from "@clerk/nextjs/server";
import { api, handleApiError } from "@/lib/api";
import type { Customer, CustomerStatus, Document, Project } from "@/lib/types";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { EditCustomerDialog } from "@/components/customers/edit-customer-dialog";
import { ArchiveCustomerDialog } from "@/components/customers/archive-customer-dialog";
import { CustomerProjectsPanel } from "@/components/customers/customer-projects-panel";
import { CustomerDocumentsPanel } from "@/components/documents/customer-documents-panel";
import { CustomerTabs } from "@/components/customers/customer-tabs";
import { formatDate } from "@/lib/format";
import { ArrowLeft, Pencil, Archive } from "lucide-react";
import Link from "next/link";

const STATUS_BADGE: Record<CustomerStatus, { label: string; variant: "success" | "neutral" }> = {
  ACTIVE: { label: "Active", variant: "success" },
  ARCHIVED: { label: "Archived", variant: "neutral" },
};

export default async function CustomerDetailPage({
  params,
}: {
  params: Promise<{ slug: string; id: string }>;
}) {
  const { slug, id } = await params;
  const { orgRole } = await auth();

  const isAdmin = orgRole === "org:admin" || orgRole === "org:owner";

  let customer: Customer;
  try {
    customer = await api.get<Customer>(`/api/customers/${id}`);
  } catch (error) {
    handleApiError(error);
  }

  let linkedProjects: Project[] = [];
  try {
    linkedProjects = await api.get<Project[]>(`/api/customers/${id}/projects`);
  } catch {
    // Non-fatal
  }

  let customerDocuments: Document[] = [];
  try {
    customerDocuments = await api.get<Document[]>(
      `/api/documents?scope=CUSTOMER&customerId=${id}`
    );
  } catch {
    // Non-fatal
  }

  const statusBadge = STATUS_BADGE[customer.status];

  return (
    <div className="space-y-8">
      {/* Back link */}
      <div>
        <Link
          href={`/org/${slug}/customers`}
          className="inline-flex items-center text-sm text-olive-600 transition-colors hover:text-olive-900 dark:text-olive-400 dark:hover:text-olive-100"
        >
          <ArrowLeft className="mr-1.5 size-4" />
          Back to Customers
        </Link>
      </div>

      {/* Customer Header */}
      <div className="flex items-start justify-between gap-4">
        <div className="min-w-0">
          <div className="flex items-center gap-3">
            <h1 className="font-display text-2xl text-olive-950 dark:text-olive-50">
              {customer.name}
            </h1>
            <Badge variant={statusBadge.variant}>{statusBadge.label}</Badge>
          </div>
          <p className="mt-1 text-olive-600 dark:text-olive-400">{customer.email}</p>
          <p className="mt-3 text-sm text-olive-400 dark:text-olive-600">
            {customer.phone && (
              <>
                {customer.phone} &middot;{" "}
              </>
            )}
            {customer.idNumber && (
              <>
                {customer.idNumber} &middot;{" "}
              </>
            )}
            Created {formatDate(customer.createdAt)} &middot; {linkedProjects.length}{" "}
            {linkedProjects.length === 1 ? "project" : "projects"}
          </p>
          {customer.notes && (
            <p className="mt-3 text-sm text-olive-600 dark:text-olive-400">{customer.notes}</p>
          )}
        </div>

        {isAdmin && customer.status === "ACTIVE" && (
          <div className="flex shrink-0 gap-2">
            <EditCustomerDialog customer={customer} slug={slug}>
              <Button variant="outline" size="sm">
                <Pencil className="mr-1.5 size-4" />
                Edit
              </Button>
            </EditCustomerDialog>
            <ArchiveCustomerDialog slug={slug} customerId={customer.id} customerName={customer.name}>
              <Button
                variant="ghost"
                size="sm"
                className="text-red-600 hover:bg-red-50 hover:text-red-700 dark:text-red-400 dark:hover:bg-red-950 dark:hover:text-red-300"
              >
                <Archive className="mr-1.5 size-4" />
                Archive
              </Button>
            </ArchiveCustomerDialog>
          </div>
        )}
      </div>

      {/* Tabbed Content */}
      <CustomerTabs
        projectsPanel={
          <CustomerProjectsPanel
            projects={linkedProjects}
            slug={slug}
            customerId={id}
            canManage={isAdmin && customer.status === "ACTIVE"}
          />
        }
        documentsPanel={
          <CustomerDocumentsPanel
            documents={customerDocuments}
            slug={slug}
            customerId={id}
            canManage={isAdmin && customer.status === "ACTIVE"}
          />
        }
      />
    </div>
  );
}
```

### 8. Existing MemberRatesTable (`frontend/components/rates/member-rates-table.tsx`)

```typescript
"use client";

import { useMemo, useState } from "react";
import { Pencil, Plus, Trash2, Users } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { AvatarCircle } from "@/components/ui/avatar-circle";
import { EmptyState } from "@/components/empty-state";
import { CurrencySelector } from "@/components/rates/currency-selector";
import { AddRateDialog } from "@/components/rates/add-rate-dialog";
import { EditRateDialog } from "@/components/rates/edit-rate-dialog";
import { DeleteRateDialog } from "@/components/rates/delete-rate-dialog";
import { updateDefaultCurrency } from "@/app/(app)/org/[slug]/settings/rates/actions";
import { formatDate } from "@/lib/format";
import type { OrgMember, BillingRate, CostRate } from "@/lib/types";

function formatCurrency(amount: number, currency: string): string {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency,
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(amount);
}

function getActiveRate<T extends { effectiveFrom: string; effectiveTo: string | null }>(
  rates: T[],
): T | undefined {
  const today = new Date().toLocaleDateString("en-CA");
  return rates.find((r) => {
    if (r.effectiveFrom > today) return false;
    if (r.effectiveTo && r.effectiveTo < today) return false;
    return true;
  });
}

interface MemberRatesTableProps {
  slug: string;
  members: OrgMember[];
  billingRates: BillingRate[];
  costRates: CostRate[];
  defaultCurrency: string;
}

export function MemberRatesTable({
  slug,
  members,
  billingRates,
  costRates,
  defaultCurrency,
}: MemberRatesTableProps) {
  const [currency, setCurrency] = useState(defaultCurrency);
  const [isSavingCurrency, setIsSavingCurrency] = useState(false);
  const [currencyMessage, setCurrencyMessage] = useState<string | null>(null);

  const billingRatesByMember = useMemo(() => {
    const map = new Map<string, BillingRate[]>();
    for (const rate of billingRates) {
      const existing = map.get(rate.memberId) ?? [];
      existing.push(rate);
      map.set(rate.memberId, existing);
    }
    return map;
  }, [billingRates]);

  const costRatesByMember = useMemo(() => {
    const map = new Map<string, CostRate[]>();
    for (const rate of costRates) {
      const existing = map.get(rate.memberId) ?? [];
      existing.push(rate);
      map.set(rate.memberId, existing);
    }
    return map;
  }, [costRates]);

  async function handleCurrencyChange(newCurrency: string) {
    setCurrency(newCurrency);
    setCurrencyMessage(null);
    setIsSavingCurrency(true);

    try {
      const result = await updateDefaultCurrency(slug, newCurrency);
      if (result.success) {
        setCurrencyMessage("Default currency updated.");
      } else {
        setCurrencyMessage(result.error ?? "Failed to update currency.");
        setCurrency(defaultCurrency);
      }
    } catch {
      setCurrencyMessage("An unexpected error occurred.");
      setCurrency(defaultCurrency);
    } finally {
      setIsSavingCurrency(false);
    }
  }

  if (members.length === 0) {
    return (
      <EmptyState
        icon={Users}
        title="No members found"
        description="Organization members will appear here."
      />
    );
  }

  return (
    <div className="space-y-8">
      {/* Currency selector */}
      <div className="rounded-lg border border-olive-200 bg-white p-6 dark:border-olive-800 dark:bg-olive-950">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-lg font-semibold text-olive-950 dark:text-olive-50">
              Default Currency
            </h2>
            <p className="mt-1 text-sm text-olive-600 dark:text-olive-400">
              This currency will be pre-selected when creating new rates.
            </p>
          </div>
          <CurrencySelector
            value={currency}
            onChange={handleCurrencyChange}
            disabled={isSavingCurrency}
          />
        </div>
        {currencyMessage && (
          <p
            className={`mt-2 text-sm ${
              currencyMessage.includes("updated")
                ? "text-green-600 dark:text-green-400"
                : "text-red-600 dark:text-red-400"
            }`}
          >
            {currencyMessage}
          </p>
        )}
      </div>

      {/* Rates tabs */}
      <Tabs defaultValue="billing">
        <TabsList>
          <TabsTrigger value="billing">Billing Rates</TabsTrigger>
          <TabsTrigger value="cost">Cost Rates</TabsTrigger>
        </TabsList>

        <TabsContent value="billing" className="mt-4">
          <div className="rounded-lg border border-olive-200 bg-white dark:border-olive-800 dark:bg-olive-950">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Member</TableHead>
                  <TableHead>Hourly Rate</TableHead>
                  <TableHead>Currency</TableHead>
                  <TableHead>Effective From</TableHead>
                  <TableHead>Effective To</TableHead>
                  <TableHead className="text-right">Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {members.map((member) => {
                  const memberRates = billingRatesByMember.get(member.id) ?? [];
                  const activeRate = getActiveRate(memberRates);

                  return (
                    <TableRow key={member.id}>
                      <TableCell>
                        <div className="flex items-center gap-3">
                          <AvatarCircle name={member.name} size={32} />
                          <div className="min-w-0">
                            <p className="truncate font-medium text-olive-900 dark:text-olive-100">
                              {member.name}
                            </p>
                            <p className="truncate text-xs text-olive-500 dark:text-olive-400">
                              {member.email}
                            </p>
                          </div>
                        </div>
                      </TableCell>
                      <TableCell>
                        {activeRate ? (
                          <span className="font-medium">
                            {formatCurrency(
                              activeRate.hourlyRate,
                              activeRate.currency,
                            )}
                          </span>
                        ) : (
                          <span className="text-olive-400 dark:text-olive-600">
                            Not set
                          </span>
                        )}
                      </TableCell>
                      <TableCell>
                        {activeRate ? (
                          activeRate.currency
                        ) : (
                          <span className="text-olive-400 dark:text-olive-600">
                            —
                          </span>
                        )}
                      </TableCell>
                      <TableCell>
                        {activeRate ? (
                          formatDate(activeRate.effectiveFrom)
                        ) : (
                          <span className="text-olive-400 dark:text-olive-600">
                            —
                          </span>
                        )}
                      </TableCell>
                      <TableCell>
                        {activeRate?.effectiveTo ? (
                          formatDate(activeRate.effectiveTo)
                        ) : activeRate ? (
                          <span className="text-olive-400 dark:text-olive-600">
                            Ongoing
                          </span>
                        ) : (
                          <span className="text-olive-400 dark:text-olive-600">
                            —
                          </span>
                        )}
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex items-center justify-end gap-1">
                          {activeRate ? (
                            <>
                              <EditRateDialog
                                slug={slug}
                                rate={activeRate}
                                rateType="billing"
                              >
                                <Button
                                  variant="plain"
                                  size="sm"
                                  aria-label={`Edit billing rate for ${member.name}`}
                                >
                                  <Pencil className="size-4" />
                                </Button>
                              </EditRateDialog>
                              <DeleteRateDialog
                                slug={slug}
                                rateId={activeRate.id}
                                rateType="billing"
                                memberName={member.name}
                              >
                                <Button
                                  variant="plain"
                                  size="sm"
                                  aria-label={`Delete billing rate for ${member.name}`}
                                >
                                  <Trash2 className="size-4 text-red-500" />
                                </Button>
                              </DeleteRateDialog>
                            </>
                          ) : (
                            <AddRateDialog
                              slug={slug}
                              member={member}
                              defaultCurrency={currency}
                            >
                              <Button
                                variant="plain"
                                size="sm"
                                aria-label={`Add rate for ${member.name}`}
                              >
                                <Plus className="size-4" />
                                <span className="ml-1">Add Rate</span>
                              </Button>
                            </AddRateDialog>
                          )}
                        </div>
                      </TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>
          </div>
        </TabsContent>

        <TabsContent value="cost" className="mt-4">
          {/* Cost rates tab — same structure but with hourlyCost field */}
          {/* See full source in MemberRatesTable */}
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

### 9. Existing AddRateDialog (`frontend/components/rates/add-rate-dialog.tsx`)

```typescript
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { CurrencySelector } from "@/components/rates/currency-selector";
import {
  createBillingRate,
  createCostRate,
} from "@/app/(app)/org/[slug]/settings/rates/actions";
import type { OrgMember } from "@/lib/types";

interface AddRateDialogProps {
  slug: string;
  member: OrgMember;
  defaultCurrency: string;
  children: React.ReactNode;
}

export function AddRateDialog({
  slug,
  member,
  defaultCurrency,
  children,
}: AddRateDialogProps) {
  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [rateType, setRateType] = useState<"billing" | "cost">("billing");
  const [hourlyRate, setHourlyRate] = useState("");
  const [currency, setCurrency] = useState(defaultCurrency);
  const [effectiveFrom, setEffectiveFrom] = useState(
    new Date().toLocaleDateString("en-CA"),
  );
  const [effectiveTo, setEffectiveTo] = useState("");

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);

    const rate = parseFloat(hourlyRate);
    if (isNaN(rate) || rate <= 0) {
      setError("Hourly rate must be greater than 0.");
      return;
    }
    if (!currency) {
      setError("Currency is required.");
      return;
    }
    if (!effectiveFrom) {
      setError("Effective from date is required.");
      return;
    }

    setIsSubmitting(true);

    try {
      let result;
      if (rateType === "billing") {
        result = await createBillingRate(slug, {
          memberId: member.id,
          currency,
          hourlyRate: rate,
          effectiveFrom,
          effectiveTo: effectiveTo || undefined,
        });
      } else {
        result = await createCostRate(slug, {
          memberId: member.id,
          currency,
          hourlyCost: rate,
          effectiveFrom,
          effectiveTo: effectiveTo || undefined,
        });
      }

      if (result.success) {
        resetForm();
        setOpen(false);
      } else {
        setError(result.error ?? "Failed to create rate.");
      }
    } catch {
      setError("An unexpected error occurred.");
    } finally {
      setIsSubmitting(false);
    }
  }

  function resetForm() {
    setRateType("billing");
    setHourlyRate("");
    setCurrency(defaultCurrency);
    setEffectiveFrom(new Date().toLocaleDateString("en-CA"));
    setEffectiveTo("");
    setError(null);
  }

  function handleOpenChange(newOpen: boolean) {
    if (!newOpen) {
      resetForm();
    }
    setOpen(newOpen);
  }

  return (
    <Dialog open={open} onOpenChange={handleOpenChange}>
      <DialogTrigger asChild>{children}</DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Add Rate</DialogTitle>
          <DialogDescription>
            Create a new rate for {member.name}.
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label>Rate Type</Label>
            <div className="flex gap-2">
              <Button
                type="button"
                variant={rateType === "billing" ? "accent" : "plain"}
                size="sm"
                onClick={() => setRateType("billing")}
              >
                Billing Rate
              </Button>
              <Button
                type="button"
                variant={rateType === "cost" ? "accent" : "plain"}
                size="sm"
                onClick={() => setRateType("cost")}
              >
                Cost Rate
              </Button>
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="add-hourly-rate">
              {rateType === "billing" ? "Hourly Rate" : "Hourly Cost"}
            </Label>
            <Input
              id="add-hourly-rate"
              type="number"
              min="0.01"
              step="0.01"
              value={hourlyRate}
              onChange={(e) => setHourlyRate(e.target.value)}
              placeholder="0.00"
              required
            />
          </div>

          <div className="space-y-2">
            <Label>Currency</Label>
            <CurrencySelector
              value={currency}
              onChange={setCurrency}
              className="w-full"
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="add-effective-from">Effective From</Label>
            <Input
              id="add-effective-from"
              type="date"
              value={effectiveFrom}
              onChange={(e) => setEffectiveFrom(e.target.value)}
              required
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="add-effective-to">
              Effective To{" "}
              <span className="font-normal text-olive-500">(optional)</span>
            </Label>
            <Input
              id="add-effective-to"
              type="date"
              value={effectiveTo}
              onChange={(e) => setEffectiveTo(e.target.value)}
            />
          </div>

          {error && <p className="text-sm text-destructive">{error}</p>}

          <DialogFooter>
            <Button
              type="button"
              variant="plain"
              onClick={() => setOpen(false)}
              disabled={isSubmitting}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? "Creating..." : "Create Rate"}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

### 10. Existing EditRateDialog (`frontend/components/rates/edit-rate-dialog.tsx`)

```typescript
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { CurrencySelector } from "@/components/rates/currency-selector";
import {
  updateBillingRate,
  updateCostRate,
} from "@/app/(app)/org/[slug]/settings/rates/actions";
import type { BillingRate, CostRate } from "@/lib/types";

interface EditBillingRateDialogProps {
  slug: string;
  rate: BillingRate;
  children: React.ReactNode;
}

interface EditCostRateDialogProps {
  slug: string;
  rate: CostRate;
  children: React.ReactNode;
}

type EditRateDialogProps =
  | (EditBillingRateDialogProps & { rateType: "billing" })
  | (EditCostRateDialogProps & { rateType: "cost" });

export function EditRateDialog(props: EditRateDialogProps) {
  const { slug, rateType, children } = props;
  const rate = props.rate;

  const initialRate =
    rateType === "billing"
      ? (rate as BillingRate).hourlyRate
      : (rate as CostRate).hourlyCost;

  const [open, setOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [hourlyRate, setHourlyRate] = useState(initialRate.toString());
  const [currency, setCurrency] = useState(rate.currency);
  const [effectiveFrom, setEffectiveFrom] = useState(rate.effectiveFrom);
  const [effectiveTo, setEffectiveTo] = useState(rate.effectiveTo ?? "");

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);

    const parsedRate = parseFloat(hourlyRate);
    if (isNaN(parsedRate) || parsedRate <= 0) {
      setError("Hourly rate must be greater than 0.");
      return;
    }
    if (!currency) {
      setError("Currency is required.");
      return;
    }
    if (!effectiveFrom) {
      setError("Effective from date is required.");
      return;
    }

    setIsSubmitting(true);

    try {
      let result;
      if (rateType === "billing") {
        result = await updateBillingRate(slug, rate.id, {
          currency,
          hourlyRate: parsedRate,
          effectiveFrom,
          effectiveTo: effectiveTo || undefined,
        });
      } else {
        result = await updateCostRate(slug, rate.id, {
          currency,
          hourlyCost: parsedRate,
          effectiveFrom,
          effectiveTo: effectiveTo || undefined,
        });
      }

      if (result.success) {
        setOpen(false);
      } else {
        setError(result.error ?? "Failed to update rate.");
      }
    } catch {
      setError("An unexpected error occurred.");
    } finally {
      setIsSubmitting(false);
    }
  }

  function handleOpenChange(newOpen: boolean) {
    if (newOpen) {
      setHourlyRate(initialRate.toString());
      setCurrency(rate.currency);
      setEffectiveFrom(rate.effectiveFrom);
      setEffectiveTo(rate.effectiveTo ?? "");
      setError(null);
    }
    setOpen(newOpen);
  }

  const memberName =
    rateType === "billing"
      ? (rate as BillingRate).memberName
      : (rate as CostRate).memberName;

  return (
    <Dialog open={open} onOpenChange={handleOpenChange}>
      <DialogTrigger asChild>{children}</DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>
            Edit {rateType === "billing" ? "Billing" : "Cost"} Rate
          </DialogTitle>
          <DialogDescription>
            Update the {rateType === "billing" ? "billing" : "cost"} rate for{" "}
            {memberName}.
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="edit-hourly-rate">
              {rateType === "billing" ? "Hourly Rate" : "Hourly Cost"}
            </Label>
            <Input
              id="edit-hourly-rate"
              type="number"
              min="0.01"
              step="0.01"
              value={hourlyRate}
              onChange={(e) => setHourlyRate(e.target.value)}
              placeholder="0.00"
              required
            />
          </div>

          <div className="space-y-2">
            <Label>Currency</Label>
            <CurrencySelector
              value={currency}
              onChange={setCurrency}
              className="w-full"
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="edit-effective-from">Effective From</Label>
            <Input
              id="edit-effective-from"
              type="date"
              value={effectiveFrom}
              onChange={(e) => setEffectiveFrom(e.target.value)}
              required
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="edit-effective-to">
              Effective To{" "}
              <span className="font-normal text-olive-500">(optional)</span>
            </Label>
            <Input
              id="edit-effective-to"
              type="date"
              value={effectiveTo}
              onChange={(e) => setEffectiveTo(e.target.value)}
            />
          </div>

          {error && <p className="text-sm text-destructive">{error}</p>}

          <DialogFooter>
            <Button
              type="button"
              variant="plain"
              onClick={() => setOpen(false)}
              disabled={isSubmitting}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? "Saving..." : "Save Changes"}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

### 11. Existing DeleteRateDialog (`frontend/components/rates/delete-rate-dialog.tsx`)

```typescript
"use client";

import { useState } from "react";
import {
  AlertDialog,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";
import {
  deleteBillingRate,
  deleteCostRate,
} from "@/app/(app)/org/[slug]/settings/rates/actions";

interface DeleteRateDialogProps {
  slug: string;
  rateId: string;
  rateType: "billing" | "cost";
  memberName: string;
  children: React.ReactNode;
}

export function DeleteRateDialog({
  slug,
  rateId,
  rateType,
  memberName,
  children,
}: DeleteRateDialogProps) {
  const [open, setOpen] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  async function handleDelete() {
    setError(null);
    setIsDeleting(true);

    try {
      const result =
        rateType === "billing"
          ? await deleteBillingRate(slug, rateId)
          : await deleteCostRate(slug, rateId);

      if (result.success) {
        setOpen(false);
      } else {
        setError(result.error ?? "Failed to delete rate.");
      }
    } catch {
      setError("An unexpected error occurred.");
    } finally {
      setIsDeleting(false);
    }
  }

  function handleOpenChange(newOpen: boolean) {
    if (newOpen) {
      setError(null);
    }
    setOpen(newOpen);
  }

  const typeLabel = rateType === "billing" ? "billing" : "cost";

  return (
    <AlertDialog open={open} onOpenChange={handleOpenChange}>
      <AlertDialogTrigger asChild>{children}</AlertDialogTrigger>
      <AlertDialogContent className="border-t-4 border-t-red-500">
        <AlertDialogHeader>
          <div className="flex justify-center">
            <div className="flex size-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-950">
              <AlertTriangle className="size-6 text-red-600 dark:text-red-400" />
            </div>
          </div>
          <AlertDialogTitle className="text-center">
            Delete {rateType === "billing" ? "Billing" : "Cost"} Rate
          </AlertDialogTitle>
          <AlertDialogDescription className="text-center">
            Delete the {typeLabel} rate for {memberName}? This action cannot be
            undone.
          </AlertDialogDescription>
        </AlertDialogHeader>
        {error && <p className="text-sm text-destructive">{error}</p>}
        <AlertDialogFooter>
          <AlertDialogCancel variant="plain" disabled={isDeleting}>
            Cancel
          </AlertDialogCancel>
          <Button
            variant="destructive"
            onClick={handleDelete}
            disabled={isDeleting}
          >
            {isDeleting ? "Deleting..." : "Delete"}
          </Button>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

### 12. Existing CurrencySelector (`frontend/components/rates/currency-selector.tsx`)

```typescript
"use client";

import { useState } from "react";
import { Check, ChevronsUpDown } from "lucide-react";
import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from "@/components/ui/command";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";

interface Currency {
  code: string;
  name: string;
}

const COMMON_CURRENCIES: Currency[] = [
  { code: "USD", name: "US Dollar" },
  { code: "EUR", name: "Euro" },
  { code: "GBP", name: "British Pound" },
  { code: "ZAR", name: "South African Rand" },
  { code: "AUD", name: "Australian Dollar" },
  { code: "CAD", name: "Canadian Dollar" },
];

const OTHER_CURRENCIES: Currency[] = [
  { code: "AED", name: "UAE Dirham" },
  { code: "BRL", name: "Brazilian Real" },
  { code: "CHF", name: "Swiss Franc" },
  { code: "CNY", name: "Chinese Yuan" },
  { code: "DKK", name: "Danish Krone" },
  { code: "HKD", name: "Hong Kong Dollar" },
  { code: "INR", name: "Indian Rupee" },
  { code: "JPY", name: "Japanese Yen" },
  { code: "KRW", name: "South Korean Won" },
  { code: "MXN", name: "Mexican Peso" },
  { code: "NGN", name: "Nigerian Naira" },
  { code: "NOK", name: "Norwegian Krone" },
  { code: "NZD", name: "New Zealand Dollar" },
  { code: "PLN", name: "Polish Zloty" },
  { code: "SEK", name: "Swedish Krona" },
  { code: "SGD", name: "Singapore Dollar" },
  { code: "THB", name: "Thai Baht" },
  { code: "TRY", name: "Turkish Lira" },
  { code: "TWD", name: "New Taiwan Dollar" },
];

interface CurrencySelectorProps {
  value: string;
  onChange: (currency: string) => void;
  disabled?: boolean;
  className?: string;
}

export function CurrencySelector({
  value,
  onChange,
  disabled = false,
  className,
}: CurrencySelectorProps) {
  const [open, setOpen] = useState(false);

  const allCurrencies = [...COMMON_CURRENCIES, ...OTHER_CURRENCIES];
  const selectedCurrency = allCurrencies.find((c) => c.code === value);

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="plain"
          role="combobox"
          aria-expanded={open}
          disabled={disabled}
          className={cn(
            "w-[240px] justify-between border border-olive-200 bg-white px-3 font-normal dark:border-olive-800 dark:bg-olive-950",
            className,
          )}
        >
          {selectedCurrency
            ? `${selectedCurrency.code} — ${selectedCurrency.name}`
            : "Select currency..."}
          <ChevronsUpDown className="ml-2 size-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[240px] p-0" align="start">
        <Command>
          <CommandInput placeholder="Search currency..." />
          <CommandList>
            <CommandEmpty>No currency found.</CommandEmpty>
            <CommandGroup heading="Common">
              {COMMON_CURRENCIES.map((currency) => (
                <CommandItem
                  key={currency.code}
                  value={`${currency.code} ${currency.name}`}
                  onSelect={() => {
                    onChange(currency.code);
                    setOpen(false);
                  }}
                >
                  <Check
                    className={cn(
                      "mr-2 size-4",
                      value === currency.code ? "opacity-100" : "opacity-0",
                    )}
                  />
                  {currency.code} — {currency.name}
                </CommandItem>
              ))}
            </CommandGroup>
            <CommandGroup heading="Other">
              {OTHER_CURRENCIES.map((currency) => (
                <CommandItem
                  key={currency.code}
                  value={`${currency.code} ${currency.name}`}
                  onSelect={() => {
                    onChange(currency.code);
                    setOpen(false);
                  }}
                >
                  <Check
                    className={cn(
                      "mr-2 size-4",
                      value === currency.code ? "opacity-100" : "opacity-0",
                    )}
                  />
                  {currency.code} — {currency.name}
                </CommandItem>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </PopoverContent>
    </Popover>
  );
}
```

### 13. Existing Test Pattern (`frontend/__tests__/rates-settings.test.tsx`)

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from "vitest";
import { cleanup, render, screen, waitFor } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { MemberRatesTable } from "@/components/rates/member-rates-table";
import type { OrgMember, BillingRate, CostRate } from "@/lib/types";

const mockUpdateDefaultCurrency = vi.fn();
const mockCreateBillingRate = vi.fn();
const mockCreateCostRate = vi.fn();
const mockUpdateBillingRate = vi.fn();
const mockUpdateCostRate = vi.fn();
const mockDeleteBillingRate = vi.fn();
const mockDeleteCostRate = vi.fn();

vi.mock("@/app/(app)/org/[slug]/settings/rates/actions", () => ({
  updateDefaultCurrency: (...args: unknown[]) =>
    mockUpdateDefaultCurrency(...args),
  createBillingRate: (...args: unknown[]) => mockCreateBillingRate(...args),
  updateBillingRate: (...args: unknown[]) => mockUpdateBillingRate(...args),
  deleteBillingRate: (...args: unknown[]) => mockDeleteBillingRate(...args),
  createCostRate: (...args: unknown[]) => mockCreateCostRate(...args),
  updateCostRate: (...args: unknown[]) => mockUpdateCostRate(...args),
  deleteCostRate: (...args: unknown[]) => mockDeleteCostRate(...args),
}));

function makeMembers(): OrgMember[] {
  return [
    {
      id: "m1",
      name: "Alice Johnson",
      email: "alice@example.com",
      avatarUrl: null,
      orgRole: "org:admin",
    },
    {
      id: "m2",
      name: "Bob Smith",
      email: "bob@example.com",
      avatarUrl: null,
      orgRole: "org:member",
    },
  ];
}

const today = new Date().toLocaleDateString("en-CA");

function makeBillingRates(): BillingRate[] {
  return [
    {
      id: "br1",
      memberId: "m1",
      memberName: "Alice Johnson",
      projectId: null,
      projectName: null,
      customerId: null,
      customerName: null,
      scope: "MEMBER_DEFAULT",
      currency: "USD",
      hourlyRate: 150,
      effectiveFrom: "2025-01-01",
      effectiveTo: null,
      createdAt: "2025-01-01T00:00:00Z",
      updatedAt: "2025-01-01T00:00:00Z",
    },
  ];
}

function makeCostRates(): CostRate[] {
  return [
    {
      id: "cr1",
      memberId: "m1",
      memberName: "Alice Johnson",
      currency: "USD",
      hourlyCost: 80,
      effectiveFrom: "2025-01-01",
      effectiveTo: null,
      createdAt: "2025-01-01T00:00:00Z",
      updatedAt: "2025-01-01T00:00:00Z",
    },
  ];
}

describe("RatesSettings", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    cleanup();
  });

  it("renders currency selector with current currency", () => {
    render(
      <MemberRatesTable
        slug="acme"
        members={makeMembers()}
        billingRates={makeBillingRates()}
        costRates={makeCostRates()}
        defaultCurrency="USD"
      />,
    );

    expect(screen.getByText("Default Currency")).toBeInTheDocument();
    expect(screen.getByRole("combobox")).toHaveTextContent("USD");
  });

  it("renders member rates table with member names", () => {
    render(
      <MemberRatesTable
        slug="acme"
        members={makeMembers()}
        billingRates={makeBillingRates()}
        costRates={makeCostRates()}
        defaultCurrency="USD"
      />,
    );

    expect(screen.getByText("Alice Johnson")).toBeInTheDocument();
    expect(screen.getByText("Bob Smith")).toBeInTheDocument();
    expect(screen.getByText("$150.00")).toBeInTheDocument();
  });

  it("currency change triggers server action", async () => {
    mockUpdateDefaultCurrency.mockResolvedValue({ success: true });
    const user = userEvent.setup();

    render(
      <MemberRatesTable
        slug="acme"
        members={makeMembers()}
        billingRates={makeBillingRates()}
        costRates={makeCostRates()}
        defaultCurrency="USD"
      />,
    );

    const combobox = screen.getByRole("combobox");
    await user.click(combobox);

    const eurOption = await screen.findByText("EUR — Euro");
    await user.click(eurOption);

    await waitFor(() => {
      expect(mockUpdateDefaultCurrency).toHaveBeenCalledWith("acme", "EUR");
    });
  });

  it("add rate dialog opens with form fields", async () => {
    const user = userEvent.setup();

    render(
      <MemberRatesTable
        slug="acme"
        members={makeMembers()}
        billingRates={[]}
        costRates={[]}
        defaultCurrency="USD"
      />,
    );

    const addButton = screen.getByLabelText("Add rate for Alice Johnson");
    await user.click(addButton);

    await waitFor(() => {
      expect(
        screen.getByRole("heading", { name: "Add Rate" }),
      ).toBeInTheDocument();
    });

    expect(screen.getByText("Rate Type")).toBeInTheDocument();
    expect(screen.getByLabelText("Hourly Rate")).toBeInTheDocument();
    expect(screen.getByLabelText("Effective From")).toBeInTheDocument();
    expect(
      screen.getByRole("button", { name: "Create Rate" }),
    ).toBeInTheDocument();
  });

  it("edit rate dialog opens with pre-filled values", async () => {
    const user = userEvent.setup();

    render(
      <MemberRatesTable
        slug="acme"
        members={makeMembers()}
        billingRates={makeBillingRates()}
        costRates={makeCostRates()}
        defaultCurrency="USD"
      />,
    );

    const editButton = screen.getByLabelText("Edit billing rate for Alice Johnson");
    await user.click(editButton);

    await waitFor(() => {
      expect(
        screen.getByText("Edit Billing Rate", { selector: "h2" }),
      ).toBeInTheDocument();
    });

    const rateInput = screen.getByLabelText("Hourly Rate");
    expect(rateInput).toHaveValue(150);
  });

  it("delete rate shows confirmation and calls server action", async () => {
    mockDeleteBillingRate.mockResolvedValue({ success: true });
    const user = userEvent.setup();

    render(
      <MemberRatesTable
        slug="acme"
        members={makeMembers()}
        billingRates={makeBillingRates()}
        costRates={makeCostRates()}
        defaultCurrency="USD"
      />,
    );

    const deleteButton = screen.getByLabelText(
      "Delete billing rate for Alice Johnson",
    );
    await user.click(deleteButton);

    await waitFor(() => {
      expect(screen.getByText("Delete Billing Rate")).toBeInTheDocument();
    });

    await user.click(screen.getByRole("button", { name: "Delete" }));

    await waitFor(() => {
      expect(mockDeleteBillingRate).toHaveBeenCalledWith("acme", "br1");
    });
  });
});
```

### 14. EmptyState Component

```typescript
import type { LucideIcon } from "lucide-react";

interface EmptyStateProps {
  icon: LucideIcon;
  title: string;
  description: string;
  action?: React.ReactNode;
}

export function EmptyState({ icon: Icon, title, description, action }: EmptyStateProps) {
  return (
    <div className="flex flex-col items-center py-24 text-center gap-4">
      <Icon className="size-16 text-olive-300 dark:text-olive-700" />
      <h2 className="font-display text-xl text-olive-900 dark:text-olive-100">{title}</h2>
      <p className="text-sm text-olive-600 dark:text-olive-400">{description}</p>
      {action}
    </div>
  );
}
```

### 15. Format Utilities (`frontend/lib/format.ts`)

```typescript
export function formatDate(date: string | Date): string {
  return new Date(date).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

export function formatDuration(minutes: number): string {
  if (minutes <= 0) return "0m";
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  if (h > 0 && m > 0) return `${h}h ${m}m`;
  if (h > 0) return `${h}h`;
  return `${m}m`;
}
```

---

## Conventions (from frontend/CLAUDE.md)

### Key Conventions
- Prefer React Server Components (RSC) by default -- only add `"use client"` when needed
- Feature components go in `components/{feature}/` (e.g., `components/rates/`)
- Custom reusable components outside `ui/` should follow Shadcn patterns (forwardRef, CVA variants, cn())
- Async params: `params` are Promises in pages: `const { slug } = await params;`
- Path aliases: `@/*` maps to project root
- Use `interface` for component props, `type` for unions/utility types
- Vitest with `@testing-library/react` and `happy-dom`
- Radix UI components leak DOM between tests -- always add `afterEach(() => cleanup())` in test files using Dialog/AlertDialog
- Use unique trigger text per test file to avoid "multiple elements found" errors
- Use `cn()` from `@/lib/utils` to merge Tailwind classes

### Anti-Patterns -- NEVER DO
- Never use `@radix-ui/react-*` packages -- use unified `radix-ui` package instead
- Never put `"use client"` on a component unless it uses hooks, event handlers, or browser APIs
- Never call `auth()` in client components -- it's server-only
- Never access `params` without `await` -- Next.js 16 params are Promises
- Never skip `cssLayerName: "clerk"` on ClerkProvider
- Never use `npm` -- use `pnpm`
- Never use neutral/zinc/slate/gray color classes -- use olive scale instead
- Never import `motion` in server components -- it's client-only

### Design System
- Fonts: `font-display` (Instrument Serif) for h1/hero, Inter for UI
- Colors: olive OKLCH scale, indigo accent for interactive elements
- Sidebar: olive-950 dark background
- Buttons: pill-shaped, variants: primary, accent, soft, destructive, plain
- Cards: olive borders, no default shadow

---

## Integration Points

### Backend API Endpoints Used

1. **GET /api/billing-rates?projectId={id}** -- List billing rates filtered by project
2. **GET /api/billing-rates?customerId={id}** -- List billing rates filtered by customer
3. **POST /api/billing-rates** -- Create billing rate (with `projectId` or `customerId` in body for overrides)
4. **PUT /api/billing-rates/{id}** -- Update billing rate
5. **DELETE /api/billing-rates/{id}** -- Delete billing rate
6. **GET /api/billing-rates/resolve?memberId=X&projectId=Y&date=Z** -- Resolve effective rate (for context display)
7. **GET /api/projects/{id}/members** -- Already used, for member list in project rate tab
8. **GET /api/members** -- Org member list
9. **GET /api/settings** -- Org settings (default currency)

### Permission Model
- **Project rate overrides**: Admin, Owner, AND Project Leads (for their own projects) can manage
- **Customer rate overrides**: Admin/Owner only
- **Viewing rates**: The rates tabs should only be visible to users with manage permission

---

## Implementation Notes

### ProjectRatesTab Design
- Takes `billingRates: BillingRate[]`, `members: ProjectMember[]`, `projectId: string`, `slug: string`, `defaultCurrency: string` as props
- Shows a table of all project-scoped billing rate overrides (filtered where `scope === "PROJECT_OVERRIDE"`)
- Uses the same `formatCurrency` helper from MemberRatesTable
- Uses the same `getActiveRate` helper from MemberRatesTable
- "Add Override" button triggers AddProjectRateDialog
- Edit/Delete use the existing EditRateDialog and DeleteRateDialog (but with project rate-specific actions)

### AddProjectRateDialog Design
- Similar to AddRateDialog but:
  - No rate type selector (always billing)
  - Member selector from project members list (not all org members)
  - `projectId` always included in the CreateBillingRateRequest
  - Uses project-specific server action that revalidates the project detail path

### CustomerRatesTab Design
- Same pattern as ProjectRatesTab but with `customerId` instead of `projectId`
- Filtered where `scope === "CUSTOMER_OVERRIDE"`

### Server Actions Pattern
The project rate-actions.ts and customer rate-actions.ts should:
- Import `api` and `ApiError` from `@/lib/api`
- Use `revalidatePath` targeting the specific project/customer detail page
- Handle 403, 409, and general errors
- Follow the exact same ActionResult pattern as settings/rates/actions.ts

### Key Decision: Edit/Delete Dialogs
The existing EditRateDialog and DeleteRateDialog import their server actions from `settings/rates/actions.ts`. For project/customer rate tabs, you have two options:
1. **Option A**: Create new edit/delete dialog wrappers that accept an `onUpdate` / `onDelete` callback prop
2. **Option B** (recommended): Make the existing EditRateDialog and DeleteRateDialog accept an optional `updateAction` / `deleteAction` prop, OR create thin wrapper components in the rates directory that call the project/customer-specific server actions

**Recommended approach**: Create project-specific and customer-specific versions of the edit/delete functionality by passing the appropriate server actions as props. The simplest way:
- The ProjectRatesTab and CustomerRatesTab import their own server actions
- The edit/delete dialogs within these tabs call those specific server actions
- This can be done by creating new dialog components (AddProjectRateDialog, EditProjectRateDialog, DeleteProjectRateDialog) that follow the same pattern but import from the correct actions file, OR by making the existing dialogs accept action functions as props.

The cleanest approach: Make the existing `EditRateDialog` and `DeleteRateDialog` accept `onUpdate` and `onDelete` callback functions as props instead of importing actions directly. Then each parent component passes the appropriate bound server action. However, since the existing dialogs already work for settings, **avoid modifying them** -- create new thin wrappers for project/customer scope instead.

---

## Build & Verify

```bash
# Install dependencies
cd /Users/rakheendama/Projects/2026/worktree-epic-68B/frontend
NODE_OPTIONS="" /opt/homebrew/bin/pnpm install > /dev/null 2>&1

# Lint
NODE_OPTIONS="" /opt/homebrew/bin/pnpm run lint > /tmp/lint-epic-68B.log 2>&1; LINT_EXIT=$?; if [ $LINT_EXIT -ne 0 ]; then echo "LINT FAILED"; tail -20 /tmp/lint-epic-68B.log; fi

# Build
NODE_OPTIONS="" /opt/homebrew/bin/pnpm run build > /tmp/build-epic-68B.log 2>&1; BUILD_EXIT=$?; if [ $BUILD_EXIT -ne 0 ]; then echo "BUILD FAILED"; tail -30 /tmp/build-epic-68B.log; fi

# Test
NODE_OPTIONS="" /opt/homebrew/bin/pnpm test > /tmp/test-epic-68B.log 2>&1; TEST_EXIT=$?; if [ $TEST_EXIT -ne 0 ]; then echo "TESTS FAILED"; tail -30 /tmp/test-epic-68B.log; else echo "ALL TESTS PASSED"; tail -3 /tmp/test-epic-68B.log; fi
```

## Environment

- **pnpm**: `/opt/homebrew/bin/pnpm`
- **NODE_OPTIONS**: Must be set to `""` (user's shell has `--openssl-legacy-provider` which breaks Next.js)
- **Working directory**: `/Users/rakheendama/Projects/2026/worktree-epic-68B/frontend`
