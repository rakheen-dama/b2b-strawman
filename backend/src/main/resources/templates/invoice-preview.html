<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="'Invoice ' + (${invoice.invoiceNumber} != null ? ${invoice.invoiceNumber} : 'DRAFT')">Invoice Preview</title>
    <style>
        /* Reset and Base */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 210mm;
            margin: 0 auto;
            padding: 40px 24px;
            color: #1a1a1a;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }
        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
        }
        .header-right {
            text-align: right;
        }
        .header-right .invoice-number {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }
        .header-right .meta-line {
            font-size: 0.875rem;
            color: #475569;
            margin-bottom: 2px;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 8px;
        }
        .status-DRAFT { background: #fef3c7; color: #92400e; }
        .status-APPROVED { background: #dbeafe; color: #1e40af; }
        .status-SENT { background: #e0e7ff; color: #3730a3; }
        .status-PAID { background: #dcfce7; color: #166534; }
        .status-VOID { background: #fee2e2; color: #991b1b; }

        /* Bill To */
        .bill-to {
            margin-bottom: 32px;
        }
        .bill-to h2 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 8px;
        }
        .bill-to .customer-name {
            font-size: 1rem;
            font-weight: 600;
            color: #0f172a;
        }
        .bill-to .customer-detail {
            font-size: 0.875rem;
            color: #475569;
        }

        /* Line Items */
        .line-items {
            margin-bottom: 32px;
        }
        .project-group {
            margin-bottom: 20px;
        }
        .project-heading {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0f172a;
            padding: 8px 12px;
            background: #f1f5f9;
            border-left: 3px solid #3b82f6;
            margin-bottom: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        th {
            text-align: left;
            padding: 8px 12px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
            color: #475569;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        th.num, td.num {
            text-align: right;
        }
        td {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
        }
        tbody tr:nth-child(even) {
            background: #f8fafc;
        }
        .project-subtotal {
            text-align: right;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.875rem;
            color: #475569;
            border-top: 1px solid #cbd5e1;
        }

        /* Totals */
        .totals {
            margin-left: auto;
            width: 300px;
            margin-bottom: 32px;
        }
        .totals table {
            border: none;
        }
        .totals td {
            border: none;
            padding: 6px 12px;
        }
        .totals tr:last-child td {
            font-weight: 700;
            font-size: 1rem;
            border-top: 2px solid #0f172a;
            padding-top: 10px;
            color: #0f172a;
        }
        .totals .label {
            text-align: left;
            color: #475569;
        }
        .totals .value {
            text-align: right;
            color: #0f172a;
        }

        /* Tax */
        .tax-registration {
            font-size: 0.875rem;
            color: #475569;
            margin-top: 4px;
        }
        .tax-col {
            text-align: right;
            width: 15%;
        }
        .tax-note {
            font-style: italic;
            font-size: 0.8125rem;
            color: #64748b;
            text-align: right;
        }

        /* Footer */
        .footer {
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
            font-size: 0.875rem;
            color: #64748b;
        }
        .footer-row {
            margin-bottom: 8px;
        }
        .footer-label {
            font-weight: 600;
            color: #475569;
        }

        /* Print styles */
        @media print {
            body {
                padding: 20mm 15mm;
                font-size: 12px;
            }
            .status-badge {
                display: none;
            }
            .header {
                border-bottom-color: #000;
            }
            .project-heading {
                background: none;
                border-left-color: #000;
            }
            table th {
                background: none;
            }
            tbody tr:nth-child(even) {
                background: none;
            }
            table, th, td {
                border-color: #000;
            }
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1 th:text="${invoice.orgName}">Organization Name</h1>
        <div th:if="${taxRegistrationNumber != null}" class="tax-registration">
            <span th:text="${taxRegistrationLabel}">Tax Number</span>:
            <span th:text="${taxRegistrationNumber}">4012345678</span>
        </div>
    </div>
    <div class="header-right">
        <div class="invoice-number"
             th:text="'Invoice: ' + (${invoice.invoiceNumber} != null ? ${invoice.invoiceNumber} : 'DRAFT')">
            Invoice: INV-0001
        </div>
        <div class="meta-line" th:if="${invoice.issueDate != null}"
             th:text="'Date: ' + ${invoice.issueDate}">Date: 2025-01-31</div>
        <div class="meta-line" th:if="${invoice.dueDate != null}"
             th:text="'Due: ' + ${invoice.dueDate}">Due: 2025-02-28</div>
        <div th:if="${invoice.status != null}">
            <span class="status-badge"
                  th:classappend="'status-' + ${invoice.status.name()}"
                  th:text="${invoice.status.name()}">DRAFT</span>
        </div>
    </div>
</div>

<!-- Bill To -->
<div class="bill-to">
    <h2>Bill To</h2>
    <div class="customer-name" th:text="${invoice.customerName}">Customer Name</div>
    <div class="customer-detail" th:if="${invoice.customerEmail != null}"
         th:text="${invoice.customerEmail}">email@example.com</div>
    <div class="customer-detail" th:if="${invoice.customerAddress != null}"
         th:text="${invoice.customerAddress}">123 Main St</div>
</div>

<!-- Line Items -->
<div class="line-items">
    <div th:each="entry : ${groupedLines}" class="project-group">
        <div class="project-heading" th:text="${entry.key}">Project Name</div>
        <table>
            <thead>
                <tr>
                    <th th:style="${hasPerLineTax} ? 'width: 40%;' : 'width: 50%;'">Description</th>
                    <th class="num" style="width: 15%;">Qty</th>
                    <th class="num" style="width: 15%;">Rate</th>
                    <th class="num" th:style="${hasPerLineTax} ? 'width: 15%;' : 'width: 20%;'">Amount</th>
                    <th th:if="${hasPerLineTax}" class="num tax-col" th:text="${taxLabel}">Tax</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="line : ${entry.value}">
                    <td th:text="${line.description}">Backend API development</td>
                    <td class="num" th:text="${#numbers.formatDecimal(line.quantity, 1, 4)}">2.0000</td>
                    <td class="num" th:text="${#numbers.formatDecimal(line.unitPrice, 1, 2)}">1800.00</td>
                    <td class="num" th:text="${#numbers.formatDecimal(line.amount, 1, 2)}">3600.00</td>
                    <td th:if="${hasPerLineTax}" class="num tax-col">
                        <span th:if="${line.taxExempt}">Exempt</span>
                        <span th:unless="${line.taxExempt}"
                              th:text="${line.taxRateName != null} ? ${line.taxRateName + ' ' + line.taxRatePercent + '%'} : ''">VAT 15%</span>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="project-subtotal"
             th:text="'Subtotal: ' + ${#numbers.formatDecimal(groupSubtotals.get(entry.key), 1, 2)}">
            Subtotal: 0.00
        </div>
    </div>
</div>

<!-- Totals -->
<div class="totals">
    <table>
        <tr>
            <td class="label">Subtotal</td>
            <td class="value" th:text="${#numbers.formatDecimal(invoice.subtotal, 1, 2)}">0.00</td>
        </tr>
        <!-- Legacy: single tax row (no per-line tax) -->
        <tr th:if="${!hasPerLineTax}">
            <td class="label">Tax</td>
            <td class="value" th:text="${#numbers.formatDecimal(invoice.taxAmount, 1, 2)}">0.00</td>
        </tr>
        <!-- Per-line tax: breakdown by rate -->
        <tr th:each="breakdownEntry : ${taxBreakdown}">
            <td class="label" th:text="${breakdownEntry.rateName + ' (' + breakdownEntry.ratePercent + '%)'}">VAT (15%)</td>
            <td class="value" th:text="${#numbers.formatDecimal(breakdownEntry.taxAmount, 1, 2)}">2250.00</td>
        </tr>
        <!-- Tax-inclusive note -->
        <tr th:if="${taxInclusive && hasPerLineTax}">
            <td colspan="2" class="tax-note">
                All amounts include <span th:text="${taxLabel}">Tax</span>
            </td>
        </tr>
        <tr>
            <td class="label" th:text="'Total (' + ${invoice.currency} + ')'">Total (ZAR)</td>
            <td class="value" th:text="${#numbers.formatDecimal(invoice.total, 1, 2)}">0.00</td>
        </tr>
    </table>
</div>

<!-- Footer -->
<div class="footer">
    <div class="footer-row" th:if="${invoice.paymentTerms != null}">
        <span class="footer-label">Payment Terms:</span>
        <span th:text="${invoice.paymentTerms}">Net 30</span>
    </div>
    <div class="footer-row" th:if="${invoice.notes != null}">
        <span class="footer-label">Notes:</span>
        <span th:text="${invoice.notes}">January 2025 services</span>
    </div>
</div>

</body>
</html>
